---
 title: "Solution for Meri"
 author: "Martin"
 output: md_document
---

```{r setup, echo=FALSE, show=FALSE}

#load without warnings
suppressMessages(library(tidyverse))
suppressMessages(library(readxl))

# set working directory to source file location
library(this.path)
setwd(this.path::here())
```


## Data import 

For importing the first two data sets, I defined the following function to reshape the data into a more tidy format. 

Eventually, I treat each combination of the first column and two subsequent columns as individual tables and reshape them into a two row format with mean and standard deviation values.
These are then combined into one data frame with some final cleanup.

OPEN: handling of the third sheet... uuuhhh... 


```{r import.function}

reshapeUglySheet <- function( dataRaw ){
  
  rows <- list()
  for ( x in seq(2,(ncol(dataRaw)-1), by=2) ) {
    rows[[x]] <-
      rbind( 
        # mean values in one row with header
        dataRaw |> 
          select( all_of(names(dataRaw)[c(1,x)]) ) |> 
          pivot_wider(names_from = 1, values_from = 2) |> 
          mutate(measure="mean") |> 
          relocate(measure, .after=1)
        ,
        # sd values in one row with header
        dataRaw |> 
          select( all_of(names(dataRaw)[c(1,x+1)]) ) |> 
          pivot_wider(names_from = 1, values_from = 2) |> 
          mutate(measure="sd") |> 
          relocate(measure, .after=1)
      ) 
  }

  return(  
    bind_rows(rows) |> 
      # parse as numeric
      mutate(across(-c(1,2), as.numeric)) 
      |>
      # fill missing values in sd rows
      fill(1:4, .direction="down") |> 
      # ensure correct column names
      rename_with(str_to_title)
  )
}
```


That way, both the survival and the time table have the same format in the end and can be joined into one.

```{r import}
survival <- 
  read_xlsx("flydata.xlsx", sheet="Survival", col_names = F) |> 
  reshapeUglySheet() |> 
  rename(n_survival = "N")

time <- 
  read_xlsx("flydata.xlsx", sheet="Developmental_Time", col_names = F) |> 
  reshapeUglySheet() |> 
  rename(n_time = "N")

data <- 
  left_join(survival, time, by=c("Diet", "Measure", "Line"))

# table output
data |>
  kable(format="markdown", digits=2, )

```


## Plotting survival data 

Given this, we can now plot the survival data.

We want individual plot for males, females and total survival, thus we need to make them individual rows with respective annotations.

Given this, we can easily meet all plot requirements

```{r plot.survival}
library(ggsignif)
data |>
  pivot_longer(cols=c(Females,Males,Total), names_to="Group", values_to="Survival") |>

  # plotting
  ggplot(aes(x=Diet, y=Survival)) +
  facet_grid(cols=vars(Group),rows=vars(Measure), scales = "free_y") +
  geom_violin(aes(fill=Diet), col=NA) +
  geom_boxplot(width=0.1, fill=NA, col="white") +
  guides(fill="none") +
  # pairwise significance bars
  geom_signif(comparisons = list(c("EPS", "HPS"), c("EPS", "LPS"), c("HPS", "LPS"))
              # shift to different levels to avoid overlap
              , margin_top=c(0.1,0.2,0.1)
              # text below the line
              , vjust=1.5
              , map_signif_level=F, textsize=2, test="t.test" )

```

