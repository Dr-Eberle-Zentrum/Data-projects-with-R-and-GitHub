---
title: "EU-Birds-Decline"
author: "Danilo Penagos"
date: "2023-06-26"
output: md_document
---

``` {r, setup}
#| echo: false
library(dplyr)
library(ggplot2)
library(ggrepel) # Library with extra geom for ggplot for text and label treatment

data <- read.csv('EU-birds-declines.csv')
```


# Bye Bye Birdie

Biodiversity decline is a real problem around the globe. While for European audiences, the word normally conjures up images of rare orchids or reptiles in the world's rain forests, there is also biodiversity loss that hits a lot closer to home with a species that is considered omnipresent.

[According to research published in scientific journal Ecology and Evolution](https://onlinelibrary.wiley.com/doi/full/10.1002/ece3.8282), there are a "considerable numerical loss in the avifauna of EU" since 1980. This biodiversity loss is "also heterogeneous across habitats". 

The following [data set](https://zenodo.org/record/5544548#.ZFkcpi9n6x_) allows find patterns of change about the bird species decline. In the table, we can find a first look to the variables of the data:

``` {r, data_head}
#| echo: false

knitr::kable(
  data[1:5, ]
)
```

## Which species is decreasing its population?

We particularly interested in which of the bird species increased in population and which decreased in population. 

To answer this question through a graph, we should first extract the data we are most interested in terms of minimum and maximum values. 

```{r, max_min values}
#| echo: false

# 1. We extract the min values, transform the variable "Loss_med" to a 
# manipulable figure, and reduce the data set to a specific variables

min_values <- data |>
  mutate(Loss_med = round(-(Loss_med/1000000), 1)) |>
  arrange(Loss_med) |>
  slice(1:8) |>
  select(species, common_name, Loss_med, lastyear, popest) |>
  mutate(n = 1)

# 2. We do the same with the max values
max_values <- data |>
  mutate(Loss_med = round(-(Loss_med/1000000), 1)) |>
  arrange(desc(Loss_med)) |>
  slice(1:8) |>
  select(species, common_name, Loss_med, lastyear, popest)  |>
  mutate(n = 1)

# 3. Now, we classify the other cases in min values
other_cases_min <- data |>
  mutate(Loss_med = round(-(Loss_med/1000000), 1)) |>
  filter(!Loss_med %in% c(min_values$Loss_med, max_values$Loss_med)) |>
  mutate("Values" = ifelse(Loss_med < 0, "Min", "Max")) |>
  filter(Values == "Min") |>
  select(species, common_name, Loss_med, lastyear, popest)

# 4. We create a subset with the total of min cases
other_cases_min <- data.frame(
  species = "Other species", 
  common_name = "Other species",
  Loss_med = sum(other_cases_min$Loss_med),
  lastyear = 2017, 
  popest = sum(other_cases_min$popest), 
  n = length(other_cases_min$lastyear))

# 5. We classify in terms of max values
other_cases_max <- data |>
  mutate(Loss_med = round(-(Loss_med/1000000), 2)) |>
  filter(!Loss_med %in% c(min_values$Loss_med, max_values$Loss_med)) |>
  mutate("Values" = ifelse(Loss_med < 0, "Min", "Max")) |>
  filter(Values == "Max") |>
  select(species, Loss_med, lastyear, popest)

# 6. We create a subset with sum of max values
other_cases_max <- data.frame(
  species = "Other species", 
  common_name = "Other species",
  Loss_med = sum(other_cases_max$Loss_med),
  lastyear = 2017, 
  popest = sum(other_cases_max$popest), 
  n = length(other_cases_max$lastyear))

# 7. Now, we put together (min-max data)
mm_data <- rbind(min_values, max_values, other_cases_min, other_cases_max)

```


The following table show the result data of this process.

```{r, mm_data}
#| echo: false

knitr::kable(
  mm_data
)
```

## Data visualization
Now, we create a column graph to show the which bird species have decrease or increase its population to 2017

```{r, viz}
#| echo: false

# Colour variable
colores <- colorRampPalette(c("#8B3A8C", "#96B3D9", "#25C7D9"))(18)

# We can choose if we want to visualize in the label the scientific name of the bird or the 
# name, in this case we chose the common name

mm_data |>
  mutate(Label = paste0(common_name, " (", Loss_med, ")")) |>
  ggplot(aes(x=factor(lastyear), y=Loss_med, fill=common_name,
             label=Label))+
  scale_fill_manual(values = colores) +
  # scale_y_continuous(limits = c(-850,600)) +
  geom_col(color = "black", width = .2, show.legend = F, 
           na.rm = T) +
  geom_text_repel(position = "stack", na.rm = T,
                  direction = "x", force_pull = -1.2, force=2,
                  max.overlaps = 20, size=3) +
  labs(title="Extreme Patterns in Species' Change",
       subtitle = "Change in bird speciesâ€™ population size (millions of individuals) in the EU from 1980 to 2017",
       x="",
       y = "Change in number of birds (millions)")


```

As graph show, house sparrow it is the bird specie more affected in the last 30 years. On the other side, black cap have increase its population.
