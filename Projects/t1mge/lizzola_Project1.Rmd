---
title: "RNAseq in pregnancy - Solution lizzola"
output: md_document
date: "`r Sys.Date()`"
---

Import the data
```{r, echo=FALSE, results = 'asis', message=FALSE}
library(dplyr)
library(tidyverse)
data <- read.csv("GSE273780_EukmRNAseq_counts.csv")
head(data)
```

Filter out the count data of the following columns (G25, G26, G27, G30, G9, G12, G32, G45). Rename the columns.

 Time point | Normal weight | Overweight
----------|----------|---------
 week 12 | G25 | G27
 week 12 | G26| G30
 week 36 | G9 | G32
 week 36 | G12 | G45
```{r}
filtered_data <- data %>%
  select(Row.names, G25, G26, G27, G30, G9, G12, G32, G45) %>%
  rename(Gene = Row.names, 
         Week12_NW = G25, 
         Week12_OW = G26, 
         Week12_NW2 = G27, 
         Week12_OW2 = G30, 
         Week36_NW = G9, 
         Week36_OW = G12, 
         Week36_NW2 = G32, 
         Week36_OW2 = G45) %>%
  head()
```

Normalize the data from counts to counts per million (add up all the counts per sample and divide each sample by this, then multiply by 1.000.000)
```{r}
total_counts_per_sample <- colSums(filtered_data[, c("Week12_NW", "Week12_OW", "Week12_NW2", "Week12_OW2", "Week36_NW", "Week36_OW", "Week36_NW2", "Week36_OW2")], na.rm = TRUE)

normalized_data <- filtered_data %>%
  mutate(
    Week12_NW_CPM = Week12_NW / total_counts_per_sample["Week12_NW"] * 1e6,
    Week12_OW_CPM = Week12_OW / total_counts_per_sample["Week12_OW"] * 1e6,
    Week12_NW2_CPM = Week12_NW2 / total_counts_per_sample["Week12_NW2"] * 1e6,
    Week12_OW2_CPM = Week12_OW2 / total_counts_per_sample["Week12_OW2"] * 1e6,
    Week36_NW_CPM = Week36_NW / total_counts_per_sample["Week36_NW"] * 1e6,
    Week36_OW_CPM = Week36_OW / total_counts_per_sample["Week36_OW"] * 1e6,
    Week36_NW2_CPM = Week36_NW2 / total_counts_per_sample["Week36_NW2"] * 1e6,
    Week36_OW2_CPM = Week36_OW2 / total_counts_per_sample["Week36_OW2"] * 1e6) %>%
  select(Gene,
    starts_with("Week12_") & ends_with("_CPM"),
    starts_with("Week36_") & ends_with("_CPM")) %>%
  head()
```

log2 transformation of the counts per million to make the data more symmetric.
```{r}
normalized_data %>%
  mutate(across(
    starts_with("Week"), 
    ~ log2(. + 1), 
    .names = "{.col}_log2"
  )) %>%
  head()
```

Drop any rows with blank names and count values between 0 and 2.
```{r}
normalized_data <- normalized_data %>%
  mutate(across(ends_with("_log2"), ~ ifelse(. < 2, NA, .)))

normalized_data
```

Calculate the z-Value of each count in new columns by subtracting the normalized count value by the mean of the column and divide by the columns standard deviation.
```{r}
z_normalized_data <- normalized_data %>%
  mutate(across(ends_with("_CPM"), 
                 ~ (.-mean(., na.rm = TRUE)) / sd(., na.rm = TRUE), 
                 .names = "{.col}_z")) %>%
  select(Gene, ends_with("_CPM_z")) %>%
  head()
```

Calculate the variance of the log2 transformed counts by rows and put it in a new column.
```{r}
#variance_data <- normalized_data %>%
#  rowwise() %>%
#  mutate(Variance = var(c_across(ends_with("_log2")))) %>%
#  ungroup() %>%
#  select(Gene, Variance)
```
