---
title: "danilopenagos"
author: "Danilo Penagos"
date: "2023-06-03"
output: md_document
---

# Power Plants in Germany

```{r setup, echo=FALSE}
library(readxl)
library(raster)
library(cartography)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)

path <- "/Advanced-data-processing-with-R/Projects/PaulKirschner/kraftwerke_de_ab_100_mw_0.xls"

# GIS data (Longitude - Latitude)
locations <- read.delim("/Advanced-data-processing-with-R/Projects/PaulKirschner/locations.csv", sep = "\t")

# Classification variables
renewable_anlagenart <- c("LWK", "PSW", "PV", "SSA", "SWK", "WEA", "Wind (L)", "Wind (O)")

fossil_anlagenart <- c("BoA", "DKW", "DT", "DWR", "G/AK", "GT", "GuD", "HEL", "IKW", "SWR")

renewable_primary_source <- c("Wind (O)", "Wasser", "Licht", "Wind (L)", "Biomasse", "Licht / Wind (L) / Batteriespeicher")

fossil_primary_source <- c("Erdgas", "Steinkohle", "Braunkohle", "Erdgas, Steinkohle", "Gichtgas", "Konvertergas", "Uran", "Steinkohle, Erdgas", "HEL", "HS", "HEL, Crack\u00F6l", "Crack\u00F6l", "Erdgas, Raffineriegas", "Braunkohle, Erdgas", "Erdgas, HEL", "Raffineriegas", "Biomasse, Erdgas", "Erdgas, Biomasse", "\u00D6lrÃ¼ckstand", "Steinkohle, HEL, Abfall", "Erdgas, HS, Cracker\u00F6l", "Cracker\u00F6l")


# Classification function
classify <- function(variable, renewable_list, fossil_list) {
  new_variable <- rep(NA, length(variable))
  
  for (i in 1:length(variable)) {
    tipo <- variable[i]
    if (is.element(tipo, renewable_list)){
      new_variable[i] <- "Renewable"
    } else if (is.element(tipo, fossil_list)){
      new_variable[i] <- "Fossil"
    }
  }
  
  return(new_variable)
}

```

The following is a proposed solution to the project [Large Scale Energy Production](https://github.com/Dr-Eberle-Zentrum/Advanced-data-processing-with-R/blob/main/Projects/PaulKirschner/ProjectIdea_Energy.md) created by Paul Kishner.

## Data Table - Power Plants in Germany over 100 MW in the year 2022

The data collected by National Environmental Agency: [UBA](https://www.umweltbundesamt.de/dokument/datenbank-kraftwerke-in-deutschland) are organized into 15 variables, including the locations of the power generation companies, the raw materials used, the amount of energy produced, among others.

```{r first_sight_to_data, echo=FALSE}

data <- read_xls(path, range = "A10:J306", col_names = TRUE)

knitr::kable(
  head(data),
  caption = "Power Plants in Germany over 100 MW in the year 2022"
)

```

In order to meet the objectives proposed in the project, these data need to be modified or expanded. First, we add to our data the longitude and latitude for each of the locations or cities, where the producing companies are located. For the identification of these variables we use the Batch geocoder for journalist tool.

Secondly, we created a variable to normalize the date to a single year.

Thirdly, we separate the raw materials for the cases in which the power plant manipulates or works with different sources.

Finally, we will classify them based on whether the materials are renewable or fossil fuels.

```{r processed_data, echo=FALSE}
colnames(data) = c("power_plant", "operator", "bundesland", "zip_code", "site", "electric_gross", "heating_capacity", "comissioning", "plant_type", "primary_source")

processed_data <- data |>
  cbind(latitude = locations$Latitude, longitude = locations$Longitude) |>
  mutate(year = as.integer(str_extract(comissioning, ".{4}"))) |>
  separate_rows(plant_type, sep="\\s/\\s") |>
  separate_rows(primary_source, sep=", ") |>
  separate_rows(primary_source, sep="\\s/\\s") |>
  mutate(energie = classify(primary_source, renewable_primary_source, fossil_primary_source))

```

#### Identify historic eras for energy sources (coal, water, renewable)

```{r historic_eras, echo=FALSE}
processed_data |>
  ggplot(aes(x = year, y = primary_source, colour = energie )) +
  geom_line() +
  theme_minimal()
```

We can see that water is a resource that has been present all the time. Renewable energies are a phenomenon that appeared in the last quarter of the 20th century and the beginning of the 21st century. Fossil resources such as gas and coal have dominated since the 1930s.

### Group the energy sources by renewable vs. fossil types Bundesland

```{r fossil_vs_renewable, echo=FALSE}
de <- getData(country = "DEU", level = 1)

ggplot() +
  geom_polygon(data = de,
               aes(x = long, y = lat, group=group),
               colour = "grey", fill="white") +
  geom_point(data = processed_data, 
             aes(x = longitude, y = latitude, size = electric_gross, color = energie)) +
  coord_map() +
  theme_minimal()

```

With this map we see that renewable energy production is located in the east of the country. While the fossil production is centralized in Nordrhein-Westfalen and the Rhine river basin.

### Challenge (first try)

First we calculate the percentage of energy produced by Bundesland (both fossil and renewable).

```{r percent_calcule, echo=FALSE}
percent_renew <- processed_data |>
  group_by(bundesland) |>
  mutate("percent" = electric_gross / sum(electric_gross) * 100) |>
  group_by(bundesland, energie) |>
  summarise("total_renewbable" = sum(percent))

knitr::kable(
  head(percent_renew),
  caption = "Percent of Energie Production by Bundesland and Type"
)

```

Then, we filtered by renewable energy and merged this data with the spacial dataframe.

Finally, with the `choroLayer` function of the `cartography` library, we color the Bundesland by percentage of renewable energy production.

```{r challenge_renewable, echo=FALSE}
renew <- percent_renew |>
  mutate(HASC_1 = gsub(" ", "", paste(c("DE."),bundesland))) |>
  subset(energie == "Renewable")

de_agg <- merge(de, renew , by.x = "HASC_1", by.y = "HASC_1", 
                duplicateGeoms = TRUE, no.dups = TRUE )

choroLayer(spdf = de_agg, var = "total_renewbable",
           nclass = 5)

```

### To Improve

-   Calculate percent of renewable energies
-   Create a interactive map using leaflet library
-   Improve labels
