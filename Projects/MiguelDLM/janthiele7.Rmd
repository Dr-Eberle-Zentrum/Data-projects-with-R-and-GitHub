---
title: "janthiele7_solution_for_miguel"
output: md_document
---

```{r, error=FALSE}
#load packages
library(tidyverse)
library(dplyr)
library(gridExtra)
library(cowplot)
```

```{r, error=FALSE}
#loading datasets
bear<- read.csv("smooth_stress_tensor (bear).csv")
hyaena<- read.csv("smooth_stress_tensor (hyaena).csv")
lion<- read.csv("smooth_stress_tensor (lion).csv")
wolf<- read.csv("smooth_stress_tensor (wolf).csv")
```

```{r}
#to make work flow easier data frames are put into a list
animals<- list(bear=bear,hyaena=hyaena,lion=lion,wolf=wolf)
```


The project requires the following steps:
1. Removing the top 2 % of the Von Misses Stress Measurement in each data set
2. Dividing each dataset along it's three axis into 10 equal sized segments 
3. Calculating average von Misses Stress on each section for each animal and axis
4. Creating plots that display the average Von Misses Stress within each axis for each animal

1. Removing top 2% 
```{r}
#defining a function to remove the top 2% (0.02)
top2 <- function(df, column, percent) {
  
#calculating cutoff value 
    upper_cutoff <- max(df[[column]]) - percent * (max(df[[column]]) -min(df[[column]]))
    
    # Filter the DataFrame to remove the top X% rows
filtered_df<-df %>%
        filter(df[[column]] < upper_cutoff)

return(filtered_df)
}
```

```{r}
animals_filtered<-lapply(animals, top2, column = "Von.Misses.Stress", percent = 0.02)
```

2. Dividing axis of the datasets into 10 equal parts
```{r}
#Creating a function that segments dataframes axis into 10 equal parts
segments <- function(df) {
    df %>%
        mutate(
            segments_X = cut(X, breaks = 10, labels = FALSE),
            segments_Y = cut(Y, breaks = 10, labels = FALSE),
            segments_Z = cut(Z, breaks = 10, labels = FALSE)
        )
}
```

```{r}
#applying function to animals 
animals_segmented <- lapply(animals, segments)
```

3. Calculating averages Von Misses Stress per section

```{r}
# Define the segment columns and the variable to summarize
segment_cols <- c("segments_X", "segments_Y", "segments_Z")
value_col <- "Von.Misses.Stress"

# Function to calculate mean per segment
mean_segment <- function(df, segment_col, value_col) {
    df %>%
        group_by(across(all_of(segment_col))) %>%
        summarize(mean_stress = mean(.data[[value_col]], na.rm = TRUE), .groups = 'drop')
}
# 

```


```{r}
#function to apply on all dataframes
all_segments <- function(df, segment_cols, value_col) {
    means_list <- map(segment_cols, ~ mean_segment(df, .x, value_col))
    names(means_list) <- segment_cols
    reduce(means_list, bind_cols)
}

```

```{r}
#apply onto each frame within animal segmented
animals_means <- map(animals_segmented, ~ all_segments(.x, segment_cols, value_col))

```

4. Extracting Mean Values per Axis
```{r}
#we need to create three dataframes containing the X/Y/Z means for Von Misses Stress for each animal
names(animals_means) <- c("bear", "hyena", "lion", "wolf")

# Select columns that end with "2" in each dataframe for the x axis
x_axis<- map(animals_means, ~ select(.x, ends_with("2")))

# and combine them into one dataframe
x_axis <- bind_cols(animals_means[[1]]$segments_X,x_axis$bear,x_axis$hyena,x_axis$lion,x_axis$wolf)
names(x_axis)<- c("segment","bear","hyena","lion","wolf")

# Select columns that end with "4" in each dataframe for the x axis
y_axis<- map(animals_means, ~ select(.x, ends_with("4")))

# and combine them into one dataframe
y_axis <- bind_cols(animals_means[[1]]$segments_Y,y_axis$bear,y_axis$hyena,y_axis$lion,y_axis$wolf)
names(y_axis)<- c("segment","bear","hyena","lion","wolf")

# Select columns that end with "4" in each dataframe for the x axis
z_axis<- map(animals_means, ~ select(.x, ends_with("6")))

# and combine them into one dataframe
z_axis <- bind_cols(animals_means[[1]]$segments_Z,z_axis$bear,z_axis$hyena,z_axis$lion,z_axis$wolf)
names(z_axis)<- c("segment","bear","hyena","lion","wolf")

```

5. Creating plots
```{r}
x_axis_longer<- x_axis %>%
    pivot_longer(cols = c("bear","hyena","lion","wolf"),
                 names_to = "animal",
                 values_to = "value")

plot_x<- x_axis_longer%>%
  ggplot(aes(x = segment, y = value, color = animal)) +
    geom_point() +
    geom_line() +
    labs(y = "Stress") +
    theme_minimal()
plot_x
```
```{r}
y_axis_longer<- y_axis %>%
    pivot_longer(cols = c("bear","hyena","lion","wolf"),
                 names_to = "animal",
                 values_to = "value")

plot_y<- y_axis_longer%>%
  ggplot(aes(x = segment, y = value, color = animal)) +
    geom_point() +
    geom_line() +
    labs(y = "Stress") +
    theme_minimal()+
  theme(legend.position = "none",
        axis.title.y = element_blank(),  
        axis.text.y = element_blank())

```

```{r}
z_axis_longer<- z_axis %>%
    pivot_longer(cols = c("bear","hyena","lion","wolf"),
                 names_to = "animal",
                 values_to = "value")

plot_z<- z_axis_longer%>%
  ggplot(aes(x = segment, y = value, color = animal)) +
    geom_point() +
    geom_line() +
    labs(y = "Stress") +
    theme_minimal()+
  theme(axis.title.y = element_blank(),  
        axis.text.y = element_blank(),
        legend.position = "none")
```

```{r}
legend <- cowplot::get_legend(plot_x)
plot_x <- plot_x + theme(legend.position = "none")
# Combine plots into a single grid with a shared legend and a main title
combined_plot <- grid.arrange(
  arrangeGrob(
    plot_x,
    plot_y,
    plot_z,
    legend,
    ncol = 4
  ),
  top = "Von Misses Stress on X Y and Z of different animals jaws" # Adjust the heights: 90% for plots, 10% for legend
)

# Display the combined plot
print(combined_plot)

# plot_xyz=grid.arrange(
# plot_x + theme(legend.position="none"), plot_y+ theme(legend.position="none"), plot_z, nrow=2, legend="bottom")
```


