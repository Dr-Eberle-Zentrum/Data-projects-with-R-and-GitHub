---
title: "UFC Analysis"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
# Load necessary libraries
library(tidyverse)
library(lubridate)
library(maps)
library(stringr)
library(viridis) # Optional: for nice map colors
```


```{r Data_Loading}
events <- read.csv("raw_events.csv")
fighters <- read.csv("raw_fighters.csv")
fights <- read.csv("raw_fights.csv")
fights_detailed <- read.csv("raw_fights_detailed.csv")
```

```{r Cleaning_Fighter_Statistics}
clean_height <- function(h) {
  # Convert 5' 11" format to inches
  ifelse(h == "--", NA,
         as.numeric(str_extract(h, "^\\d+")) * 12 + 
         as.numeric(str_extract(h, "\\d+(?=\")")))
}

clean_weight <- function(w) {
  # Remove ' lbs.' and convert to numeric
  as.numeric(str_remove(w, " lbs."))
}

clean_reach <- function(r) {
  # Remove inches symbol
  as.numeric(str_remove(r, "\""))
}

# Apply cleaning and feature engineering
fighters_clean <- fighters %>%
  mutate(
    Height_in = clean_height(Ht.),
    Weight_lbs = clean_weight(Wt.),
    Reach_in = clean_reach(Reach),
    Total_Fights = W + L + D,
    # Avoid division by zero
    WL_Ratio = ifelse(Total_Fights > 0, W / (W + L), 0)
  ) %>%
  filter(!is.na(Weight_lbs))

# Assign Standard Weight Classes for grouping
# We map each fighter's weight to the nearest standard UFC weight class
define_class <- function(w) {
  classes <- c(115, 125, 135, 145, 155, 170, 185, 205, 265)
  classes[which.min(abs(classes - w))]
}

fighters_clean$Weight_Class_Bin <- sapply(fighters_clean$Weight_lbs, define_class)

# Calculate Height-to-Reach Ratio
fighters_clean <- fighters_clean %>%
  mutate(Height_Reach_Ratio = Height_in / Reach_in)
```


```{r Cleaning_Events_and_Locations}

events_clean <- events %>%
  mutate(
    Date = mdy(Date),
    Year = year(Date),
    # Split location string by comma
    Location_Clean = str_split(Location, ", "),
    # The last element is the Country
    Country = map_chr(Location_Clean, tail, 1),
    # If Country is USA, the second to last element is the State
    State = map_chr(Location_Clean, ~ifelse(length(.x) > 1 & tail(.x, 1) == "USA", 
                                            nth(.x, -2), NA))
  )

# Fix Country names for map matching
events_clean$Country[events_clean$Country == "United Arab Emirates"] <- "UAE"
```

```{r Categorizing_Fight_Methods}
fights_clean <- fights %>%
  mutate(
    Method_Simple = case_when(
      str_detect(Method, "KO|TKO") ~ "KO/TKO",
      str_detect(Method, "SUB") ~ "Submission",
      str_detect(Method, "DEC") ~ "Decision",
      str_detect(Method, "DQ") ~ "Disqualification",
      str_detect(Method, "Doctor") ~ "Doctor Stoppage",
      str_detect(Method, "Draw") ~ "Draw",
      TRUE ~ "Other"
    )
  )
```

```{r Calculating_Total_Strikes}
# Function to extract the last number from string "86 of 165"
extract_strikes <- function(s) {
  as.numeric(str_extract(s, "\\d+$"))
}

# Prepare detailed fights for merging
# We sum strikes for each fighter across all their fights
strikes_1 <- fights_detailed %>% 
  select(Fight_Id, Name = Fighter_1, Strikes_Raw = `Total.Str._1`)
strikes_2 <- fights_detailed %>% 
  select(Fight_Id, Name = Fighter_2, Strikes_Raw = `Total.Str._2`)

# Combine and sum up
all_strikes <- bind_rows(strikes_1, strikes_2) %>%
  mutate(Total_Strikes = extract_strikes(Strikes_Raw)) %>%
  group_by(Name) %>%
  summarise(Career_Strikes = sum(Total_Strikes, na.rm = TRUE)) %>%
  arrange(desc(Career_Strikes)) %>%
  top_n(10, Career_Strikes)
```



```{r Visualization_1}
# Calculate Division Means
class_means <- fighters_clean %>%
  group_by(Weight_Class_Bin) %>%
  summarise(Mean_WL = mean(WL_Ratio, na.rm = TRUE))

# Find Best Fighter per Class (Must have at least 5 fights)
best_fighters <- fighters_clean %>%
  filter(Total_Fights >= 5) %>%
  group_by(Weight_Class_Bin) %>%
  arrange(desc(WL_Ratio), desc(Total_Fights)) %>%
  slice(1) %>%
  select(Weight_Class_Bin, Name = First, Last, Top_WL = WL_Ratio) %>%
  mutate(FullName = paste(Name, Last))

# Join Data for Plotting
plot1_data <- left_join(best_fighters, class_means, by = "Weight_Class_Bin") %>%
  pivot_longer(cols = c(Top_WL, Mean_WL), names_to = "Type", values_to = "Ratio")

ggplot(plot1_data, aes(x = as.factor(Weight_Class_Bin), y = Ratio, fill = Type)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Top Fighter W/L Ratio vs Division Mean",
       x = "Weight Class (lbs)", y = "Win/Loss Ratio", fill = "Metric") +
  theme_minimal() +
  scale_fill_manual(values = c("Mean_WL" = "grey", "Top_WL" = "#D50000"), 
                    labels = c("Division Mean", "Top Fighter"))
```


```{r Visualization_2}
ggplot(fighters_clean, aes(x = Height_Reach_Ratio, y = WL_Ratio)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Do Long Arms Help? (Height-to-Reach Ratio vs W/L)",
       subtitle = "Ratio < 1.0 indicates Reach > Height",
       x = "Height / Reach Ratio", y = "Win / Loss Ratio") +
  theme_minimal()
```


```{r Visualization_3}
# World Map
world_data <- map_data("world")
country_counts <- events_clean %>% count(Country)
# Match USA name
country_counts$Country[country_counts$Country == "USA"] <- "USA"

map_data_joined <- left_join(world_data, country_counts, by = c("region" = "Country"))

ggplot(map_data_joined, aes(long, lat, group = group, fill = n)) +
  geom_polygon(color = "white", linewidth = 0.1) +
  scale_fill_viridis_c(na.value = "grey90", name = "Events") +
  labs(title = "UFC Events by Country") +
  theme_void()

# US State Map
us_data <- map_data("state")
state_counts <- events_clean %>% 
  filter(Country == "USA") %>%
  mutate(State = tolower(State)) %>%
  count(State)

us_map_joined <- left_join(us_data, state_counts, by = c("region" = "State"))

ggplot(us_map_joined, aes(long, lat, group = group, fill = n)) +
  geom_polygon(color = "white") +
  scale_fill_viridis_c(na.value = "grey90", name = "Events") +
  labs(title = "UFC Events by US State") +
  theme_void()
```
```{r Visualization_4}
fights_clean %>%
  count(Method_Simple) %>%
  ggplot(aes(x = reorder(Method_Simple, n), y = n)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(title = "How do fights usually end?", x = "Method", y = "Count") +
  theme_minimal()
```

```{r Visualization_5}
events_clean %>%
  count(Year) %>%
  ggplot(aes(x = Year, y = n)) +
  geom_line(color = "darkred", linewidth = 1) +
  labs(title = "Expansion of the Sport: Events per Year",
       x = "Year", y = "Number of Events") +
  theme_minimal()
```


```{r Visualization_6}
ggplot(all_strikes, aes(x = reorder(Name, Career_Strikes), y = Career_Strikes, fill = Name)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  labs(title = "Top 10 Fighters by Total Punches Thrown",
       x = "Fighter", y = "Total Strikes") +
  theme_minimal()
```




