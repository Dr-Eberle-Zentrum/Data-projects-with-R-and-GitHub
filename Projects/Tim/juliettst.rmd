---
title: "Solution for Tim's Project"
author: "Julia Siodmiak"
date: "`r Sys.Date()`"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
library(ggplot2)
library(dplyr)
library(knitr)
library(tibble)
library(tidyr)


```

```{r}
klimadaten <- read.csv2("klimadaten_tuebingen.csv",  header = TRUE)

klimadaten_check <- read.csv("klimadaten_tuebingen.csv", sep = ";")
```

**Spaltenerklärung der LUBW:**

-   id: Schlüssel für Bundesland, Naturraum, Kreis oder Gemeinde name
-   Bezeichnung typ: Bundesland, Naturraum, Kreis oder Gemeinde
-   Kalenderjahr, Jahreszeiten oder Monate jahr: Jahr
-   temperatur_heisse_tage: Anzahl Heißer Tage (Tmax ≥ 30 °C)
-   temperatur_frosttage: Anzahl Frosttage (Tmin ≤ 0 °C)
-   temperatur_tropennaechte: Anzahl Tropennächte (Tmin ≥ 20 °C)
-   temperatur_mittelwert: Temperatur (°C)
-   temperatur_heizgradtage: Heizgradtage (Kelvin x Tage)
-   temperatur_kuehlgradtage: Kühlgradtage (Kelvin x Tage)
-   niederschlag_summe: Niederschlagssumme (Millimeter)
-   starkniederschlag_20mm_tage: Anzahl Tage mit N ≥ 20 mm
-   trockenperiode_tage_maximum: Dauer der längsten Trockenperiode mit Tagen \< 1 mm

# Solutions

-   Wie veränderte sich die Temperatur im zeitlichen Verlauf?

```{r}
ggplot(klimadaten %>%
         filter(saison == "kalenderjahr"),
       aes(x = jahr, y = temperatur_mittelwert)) +  
  geom_line(color = "orange") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", linetype = "dashed") +  # Trendlinie
  labs(
    title = "Temperaturentwicklung in Tübingen (1961-2024) mit Trend",
    subtitle = "Jahresmitteltemperatur",
    x = "Jahr",
    y = "Temperatur (°C)"
  ) +
scale_y_continuous(breaks = seq(5, 15, by = 0.5)) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 10))
```

-   Wie verändert sich die Temperatur im Jahreszeitlichen Verlauf, über den gesamten Messzeitraum?

```{r}
ggplot(klimadaten %>%
         filter(saison ==c("winter_djf", "fruehjahr_mam", "sommer_jja", "herbst_son")),
       aes(x = jahr, y = temperatur_mittelwert, color = saison)) +  
  geom_line(linewidth = 1) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed", linewidth = 0.5) +
  scale_color_manual(values = c("fruehjahr_mam" = "#2ca02c", "sommer_jja" = "#ff7f0e", 
                                "herbst_son" = "#d62728", "winter_djf" = "#1f77b4")) +
  labs(
    title = "Saisonale Temperaturentwicklung (1961-2024)",
    subtitle = "Alle Jahreszeiten mit Trendlinien",
    x = "Jahr",
    y = "Temperatur (°C)",
    color = "Jahreszeit"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    legend.position = "right"
  )


```

-   Wie verhalten sich die Niederschlagsmengen in Kombination mit den Heißen Tagen?

```{r}

ggplot(klimadaten, aes(x = niederschlag_summe, y = temperatur_heisse_tage)) +
  geom_point(aes(color = jahr), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE, color = "red", linetype = "dashed") +
  scale_color_gradient(low = "blue", high = "red", name = "Jahr") +
  labs(
    title = "Zusammenhang: Niederschlag und Heiße Tage",
    subtitle = "Jahresdaten 1961-2024",
    x = "Niederschlagssumme (mm)",
    y = "Anzahl Heiße Tage (≥30°C)"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))


# Korrelation berechnen
cor_niederschlag_heiss <- cor(klimadaten$niederschlag_summe, 
                               klimadaten$temperatur_heisse_tage, 
                               use = "complete.obs")
cat("\nKorrelation Niederschlag - Heiße Tage:", round(cor_niederschlag_heiss, 3), "\n")


```

-   Wie entwickeln sich die Heißtage und Frost im laufe der Zeit und Sasional?

```{r}

ggplot(klimadaten %>%
         filter(saison == "kalenderjahr") %>%
         select(jahr, temperatur_heisse_tage, temperatur_frosttage) %>%
         pivot_longer(cols = c(temperatur_heisse_tage, temperatur_frosttage),
                      names_to = "typ", 
                      values_to = "anzahl"),
       aes(x = jahr, y = anzahl, color = typ)) +
  geom_line(linewidth = 1) +
  geom_smooth(method = "lm", se = TRUE, linetype = "dashed", linewidth = 0.5) +
  scale_color_manual(
    values = c("temperatur_heisse_tage" = "#d62728", 
               "temperatur_frosttage" = "#1f77b4"),
    labels = c("Heiße Tage (≥30°C)", "Frosttage (≤0°C)")
  ) +
  labs(
    title = "Entwicklung Extrem-Temperaturtage (1961-2024)",
    subtitle = "Jahres Mittelwert",
    x = "Jahr",
    y = "Anzahl Tage",
    color = "Typ"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))

```

Saisonale Trenddiagramme, alle Saisons in einem Diagramm

```{r}

ggplot(klimadaten %>%
         filter(saison ==c("winter_djf", "fruehjahr_mam", "sommer_jja", "herbst_son")) %>%
         select(jahr, temperatur_heisse_tage, temperatur_frosttage) %>%
         pivot_longer(cols = c(temperatur_heisse_tage, temperatur_frosttage),
                      names_to = "typ", 
                      values_to = "anzahl"),
       aes(x = jahr, y = anzahl, color = typ)) +
  geom_line(linewidth = 1) +
  geom_smooth(method = "lm", se = TRUE, linetype = "dashed", linewidth = 0.5) +
  scale_color_manual(
    values = c("temperatur_heisse_tage" = "#d62728", 
               "temperatur_frosttage" = "#1f77b4"),
    labels = c("Heiße Tage (≥30°C)", "Frosttage (≤0°C)")
  ) +
  labs(
    title = "Entwicklung Extrem-Temperaturtage (1961-2024)",
    subtitle = "in verschiedenen Jahreszeiten",
    x = "Jahr",
    y = "Anzahl Tage",
    color = "Typ"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))
```

-   Wie sieht der Mittelwert im Jahr 2023 aus?

<!--# Mittelwert von was?  -->

```{r}
ggplot(klimadaten %>%
         filter(jahr == 2023) %>%
         select(saison, temperatur_mittelwert, niederschlag_summe, 
                temperatur_heisse_tage, temperatur_frosttage) %>%
         pivot_longer(cols = -saison, names_to = "variable", values_to = "wert") %>%
         mutate(saison = factor(saison, 
                               levels = c("kalenderjahr", 
                                         "fruehjahr_mam", "sommer_jja", 
                                         "herbst_son", "winter_djf",
                                         "januar", "februar", "maerz", 
                                         "april", "mai", "juni",
                                         "juli", "august", "september", 
                                         "oktober", "november", "dezember"))),
       aes(x = saison, y = wert, fill = variable)) +
  geom_col() +
  facet_wrap(~variable, scales = "free_y", ncol = 1) +
  labs(
    title = "Klimadaten 2023",
    x = NULL,
    y = "Wert"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )
```

Darstellung mithilfe einer Heatmap

-   Wie häufig treten Trockenperioden auf und wie lange dauern diese an?

```{r}
ggplot(klimadaten %>%
         filter(saison == "kalenderjahr") %>%
         mutate(periode_kategorie = cut(trockenperiode_tage_maximum,
                                       breaks = c(0, 10, 20, 30, 40, 100),
                                       labels = c("0-10", "11-20", "21-30", 
                                                 "31-40", ">40"),
                                       right = TRUE)),
       aes(x = jahr, y = periode_kategorie, fill = trockenperiode_tage_maximum)) +
  geom_tile(color = "white", linewidth = 1) +
  geom_text(aes(label = trockenperiode_tage_maximum), 
            color = "white", size = 3, fontface = "bold") +
  scale_fill_gradient(low = "#fee5d9", high = "#a50f15", 
                      name = "Tage") +
  scale_x_continuous(breaks = seq(1960, 2024, by = 5)) +
  labs(
    title = "Häufigkeit und Dauer von Trockenperioden (1961-2024)",
    subtitle = "Maximale Trockenperiode (<1mm Niederschlag) pro Jahr",
    x = "Jahr",
    y = "Länge Trockenperiode (Tage)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 10)
  )
```

Heatmap, Barplot

-   Gibt es einen Zusammenhang zwischen Tropennächten und Trockentagen?

<!--# Da es keine Tropennächte gibts, checke ich überhaupt nicht was da gemacht sein sollte -->

```{r}
ggplot(klimadaten %>%
         filter(saison == "kalenderjahr"),
       aes(x = temperatur_tropennaechte, y = trockenperiode_tage_maximum)) +
  geom_bin2d(bins = 15) +
  scale_fill_gradient(low = "#fee5d9", high = "#a50f15", 
                      name = "Anzahl\nJahre") +
  labs(
    title = "Zusammenhang: Tropennächte und Trockenperioden",
    subtitle = "Häufigkeitsverteilung (1961-2024)",
    x = "Anzahl Tropennächte (≥20°C)",
    y = "Maximale Trockenperiode (Tage)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 10)
  )


ggplot(klimadaten %>%
         filter(saison == "kalenderjahr") %>%
         mutate(
           tropennaechte_kat = cut(temperatur_tropennaechte,
                                   breaks = c(-1, 0, 2, 5, 10, 100),
                                   labels = c("0", "1-2", "3-5", "6-10", ">10")),
           trockenperiode_kat = cut(trockenperiode_tage_maximum,
                                    breaks = c(0, 15, 20, 25, 30, 100),
                                    labels = c("0-15", "16-20", "21-25", "26-30", ">30"))
         ) %>%
         count(tropennaechte_kat, trockenperiode_kat),
       aes(x = tropennaechte_kat, y = trockenperiode_kat, fill = n)) +
  geom_tile(color = "white", linewidth = 1) +
  geom_text(aes(label = n), color = "white", size = 5, fontface = "bold") +
  scale_fill_gradient(low = "#fee5d9", high = "#a50f15", 
                      name = "Anzahl\nJahre") +
  labs(
    title = "Zusammenhang: Tropennächte und Trockenperioden",
    subtitle = "Häufigkeit der Kombinationen (1961-2024)",
    x = "Anzahl Tropennächte (≥20°C)",
    y = "Maximale Trockenperiode (Tage)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 10)
  )
```

Korrelationsmatrix und Scatterplot, gerne auch andere Dimensionen

-   Wie häufig gab es jährlich mehr als 5 Frosttage/Heißtage im Jahr?

```{r}
ggplot(klimadaten %>%
         filter(saison == "kalenderjahr") %>%
         select(temperatur_heisse_tage, temperatur_frosttage) %>%
         cor(use = "complete.obs") %>%
         as.data.frame() %>%
         rownames_to_column("var1") %>%
         pivot_longer(cols = -var1, names_to = "var2", values_to = "correlation"),
       aes(x = var1, y = var2, fill = correlation)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(correlation, 2)), color = "black", size = 3) +
  scale_fill_gradient2(low = "#1f77b4", mid = "white", high = "#d62728",
                       midpoint = 0, limit = c(-1, 1), name = "Korrelation") +
  labs(title = "Korrelationsmatrix Klimavariablen") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title = element_blank()
  )


ggplot(klimadaten %>%
         filter(saison == "kalenderjahr"),
       aes(x = trockenperiode_tage_maximum, y = temperatur_heisse_tage)) +
  geom_point(aes(color = jahr, size = niederschlag_summe), alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE, color = "red", linetype = "dashed") +
  scale_color_gradient(low = "blue", high = "red", name = "Jahr") +
  scale_size_continuous(name = "Niederschlag\n(mm)", range = c(2, 10)) +
  labs(
    title = "Zusammenhang: Heiße Tage, Trockenperioden und Niederschlag",
    subtitle = paste("Korrelation Heiße Tage - Trockenperioden:", 
                     round(cor(klimadaten %>% 
                              filter(saison == "kalenderjahr") %>% 
                              pull(trockenperiode_tage_maximum),
                              klimadaten %>% 
                              filter(saison == "kalenderjahr") %>% 
                              pull(temperatur_heisse_tage),
                              use = "complete.obs"), 3)),
    x = "Maximale Trockenperiode (Tage)",
    y = "Anzahl Heiße Tage (≥30°C)"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))

ggplot(klimadaten %>%
         filter(saison == "kalenderjahr"),
       aes(x = niederschlag_summe, y = temperatur_mittelwert)) +
  geom_point(aes(color = jahr, size = temperatur_heisse_tage), alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE, color = "red", linetype = "dashed") +
  scale_color_gradient(low = "blue", high = "red", name = "Jahr") +
  scale_size_continuous(name = "Heiße Tage", range = c(2, 10)) +
  labs(
    title = "Zusammenhang: Temperatur, Niederschlag und Heiße Tage",
    subtitle = paste("Korrelation Temperatur - Niederschlag:", 
                     round(cor(klimadaten %>% 
                              filter(saison == "kalenderjahr") %>% 
                              pull(niederschlag_summe),
                              klimadaten %>% 
                              filter(saison == "kalenderjahr") %>% 
                              pull(temperatur_mittelwert),
                              use = "complete.obs"), 3)),
    x = "Niederschlagssumme (mm)",
    y = "Temperatur (°C)"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))
```

Threshold Exceedance Plots

-   Hat die Anzahl an Starknierderschlägen über die Jahre zugenommen? Wenn ja, wie viele Starkniederschläge gab es und wie verteilen sich diese über das Jahr?

```{r}
ggplot(klimadaten %>%
         filter(saison %in% c("januar", "februar", "maerz", "april", "mai", "juni",
                             "juli", "august", "september", "oktober", "november", "dezember")) %>%
         mutate(
           saison = factor(saison,
                          levels = c("januar", "februar", "maerz", "april", "mai", "juni",
                                    "juli", "august", "september", "oktober", "november", "dezember"),
                          labels = c("Jan", "Feb", "Mär", "Apr", "Mai", "Jun",
                                    "Jul", "Aug", "Sep", "Okt", "Nov", "Dez")),
           ueber_1 = starkniederschlag_20mm_tage >= 1
         ) %>%
         group_by(saison) %>%
         summarise(
           gesamt = n(),
           ueberschreitungen = sum(ueber_1, na.rm = TRUE),
           prozent = (ueberschreitungen / gesamt) * 100
         ),
       aes(x = saison, y = ueberschreitungen, fill = prozent)) +
  geom_col() +
  geom_text(aes(label = ueberschreitungen), vjust = -0.5, size = 3.5, fontface = "bold") +
  scale_fill_gradient(low = "#fee5d9", high = "#d7301f", name = "% der Jahre") +
  labs(
    title = "Threshold Exceedance: Starkniederschläge nach Monat",
    subtitle = "Anzahl Jahre mit mindestens 1 Starkniederschlagstag (≥20mm) pro Monat",
    x = "Monat",
    y = "Anzahl Jahre mit Überschreitung"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 10)
  )

ggplot(klimadaten %>%
         filter(saison %in% c("kalenderjahr", "januar", "februar", "maerz", "april", "mai", "juni",
                             "juli", "august", "september", "oktober", "november", "dezember")) %>%
         mutate(
           typ = ifelse(saison == "kalenderjahr", "Zeitlicher Verlauf (Jahr)", "Monatliche Verteilung"),
           saison_label = case_when(
             saison == "kalenderjahr" ~ as.character(jahr),
             saison == "januar" ~ "Jan",
             saison == "februar" ~ "Feb",
             saison == "maerz" ~ "Mär",
             saison == "april" ~ "Apr",
             saison == "mai" ~ "Mai",
             saison == "juni" ~ "Jun",
             saison == "juli" ~ "Jul",
             saison == "august" ~ "Aug",
             saison == "september" ~ "Sep",
             saison == "oktober" ~ "Okt",
             saison == "november" ~ "Nov",
             saison == "dezember" ~ "Dez"
           ),
           x_wert = ifelse(saison == "kalenderjahr", jahr, 
                          match(saison, c("januar", "februar", "maerz", "april", "mai", "juni",
                                         "juli", "august", "september", "oktober", "november", "dezember")))
         ) %>%
         group_by(typ, saison, saison_label, x_wert) %>%
         summarise(wert = mean(starkniederschlag_20mm_tage, na.rm = TRUE), .groups = "drop"),
       aes(x = x_wert, y = wert, fill = wert)) +
  geom_col() +
  geom_smooth(data = . %>% filter(typ == "Zeitlicher Verlauf (Jahr)"),
              method = "lm", se = TRUE, color = "#d62728", 
              linetype = "dashed", inherit.aes = FALSE,
              aes(x = x_wert, y = wert)) +
  scale_fill_gradient(low = "#fee5d9", high = "#a50f15", name = "Tage") +
  facet_wrap(~typ, scales = "free_x", ncol = 1) +
  labs(
    title = "Starkniederschläge: Hat die Anzahl zugenommen und wie verteilen sie sich?",
    subtitle = paste0("Trend: ", 
                     round(coef(lm(starkniederschlag_20mm_tage ~ jahr, 
                                  data = klimadaten %>% filter(saison == "kalenderjahr")))[2] * 10, 3),
                     " Tage/Dekade"),
    x = NULL,
    y = "Starkniederschlagstage (≥20mm)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 13, face = "bold"),
    strip.text = element_text(size = 11, face = "bold")
  )
```
