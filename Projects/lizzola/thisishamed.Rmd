---
title: "DEG and GO Term Analysis"
author: "Hamed"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Load Libraries

```{r}
library(readxl)
library(knitr)
library(ggplot2)
library(stringr)
library(dplyr)
library(tibble)  # for remove_rownames()
```

## Data Manipulation

```{r}
# Read Excel and skip the first row
data <- read_excel("avym.xlsx", skip = 1)

# Remove rownames properly
remove_rownames(data)

# Add "(up)" to columns 6 to 11 and "(down)" to columns 13 to 18
data <- data %>%
  rename_with(~ paste0(.x, " (up)"), .cols = 6:11) %>%
  rename_with(~ paste0(.x, " (down)"), .cols = 13:18)

# Keep only columns 1 to 18, and remove columns 4, 5, and 12
data <- data[, 1:18]
data <- data[, -c(4, 5, 12)]

# Separate into DEG and GO terms
DEG <- data[, 1:3]
GO_terms <- data[, 4:15]
```

## Filter DEGs

```{r}
# Create filtered DEG table and top 10
top10_DEGs <- DEG %>%
  mutate(
    logFC = as.numeric(logFC),
    p.adjust = as.numeric(p.adjust)
  ) %>%
  filter(p.adjust < 0.05) %>%
  slice_max(order_by = logFC, n = 10)

# Show table
kable(top10_DEGs, caption = "Top 10 Upregulated DEGs (p.adjust < 0.05)", align = "c")
```

## GO Term Filtering

```{r}
keywords <- c("angiogenesis", "immune response", "immunity", "cytokine", "vasculature",
              "wound", "inflammatory response", "chemokine", "lymphatic",
              "lymphocyte", "macrophage", "monocyte")

pattern <- paste(keywords, collapse = "|")

GO_up_filtered <- GO_terms %>%
  filter(grepl(pattern, `Description (up)`, ignore.case = TRUE)) %>%
  select(
    -matches("\\(down\\)"),
    -any_of(c("BgRatio (up)", "pvalue (up)", "ID (up)"))
  ) %>%
  rename(
    Description = `Description (up)`,
    GeneRatio = `GeneRatio (up)`,
    p.adjust = `p.adjust (up)`
  )
```

## Volcano Plot

```{r}
DEG <- DEG %>%
  mutate(
    logFC = as.numeric(logFC),
    p.adjust = as.numeric(p.adjust),
    neg_log10_padj = -log10(p.adjust),
    sig_region = case_when(
      logFC > 2 ~ "logFC > 2",
      logFC < -2 ~ "logFC < -2",
      TRUE ~ "logFC ∈ (-2,2)"
    )
  )

ggplot(DEG, aes(x = logFC, y = neg_log10_padj)) +
  geom_point(aes(color = abs(logFC) > 2), alpha = 0.7) +
  geom_vline(xintercept = c(-2, 2), linetype = "dashed", color = "gray40") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "gray40") +
  geom_text(aes(label = gene), check_overlap = TRUE, size = 3, vjust = -0.3) +
  annotate("text", x = -4, y = max(DEG$neg_log10_padj, na.rm = TRUE), label = "logFC < -2", hjust = 0, size = 4) +
  annotate("text", x = 0, y = max(DEG$neg_log10_padj, na.rm = TRUE), label = "logFC ∈ (-2,2)", hjust = 0.5, size = 4) +
  annotate("text", x = 4, y = max(DEG$neg_log10_padj, na.rm = TRUE), label = "logFC > 2", hjust = 1, size = 4) +
  labs(
    title = "Volcano Plot of DEG Genes",
    x = "log2 Fold Change",
    y = "-log10 Adjusted p-value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

## GO Dot Plot

```{r}
# Prepare GO data
GO_dotplot <- GO_up_filtered %>%
  mutate(
    Description = str_wrap(Description, width = 40),
    GeneRatio = sapply(strsplit(GeneRatio, "/"), function(x) as.numeric(x[1]) / as.numeric(x[2])),
    p.adjust = as.numeric(p.adjust)
  ) %>%
  slice_max(order_by = GeneRatio, n = 15)

# Plot
ggplot(GO_dotplot, aes(x = GeneRatio, y = reorder(Description, GeneRatio))) +
  geom_point(aes(size = GeneRatio, color = p.adjust)) +
  scale_color_gradient(low = "red", high = "lightgray", name = "Adjusted p-value") +
  labs(
    title = "Top 15 Upregulated GO Terms Dot Plot",
    x = "Gene Ratio",
    y = "GO Term Description"
  ) +
  theme_minimal() +
  coord_flip() +
  theme(
    axis.text.y = element_text(size = 10, hjust = 1),
    legend.position = "right"
  )
```
