---
title: "ProjectSolutionByChristian"
author: "Christian Rudi"
date: "2023-06-07"
output: html_document
---

# First Attempt at solving the art gallery project

## Data Wrangling

### Load and merge the spreadsheets to r

First thing to do, would be loading the file with all slides. For that reason the rio package would first need to be installed. The rio package is used to merge all the spreadsheets within the excel document together. Please be aware, that you might have to install rio first, using install.packages("rio").

```{r}
library(tidyverse)
library(rio)
df <- import_list("PG_BD_INVITACIONES_SM05-20-2021.xlsx", rbind = TRUE)

```

### Creating a working data frame

The second step would be to slim the data down and clean it up. The Variable I chose are the ones you recommended, "Nombre, Galeria, Espacio" and "Artistas". The other issue concerns the documentation of the artists. Since galleries have invited multiple artists to an exhibition, the documentation in the data frame consist of multiple Artists in a single row separated by commas. Using the seperate_rows function, the rows where multiple artists were documented are being separated by their separating comma and stored in their individual row. The last clean-up is about the rows containing NAs, omitting them from the data.

```{r}
# Create a subset dataset using the variables: "Nombre / Galeria / Espacio", "artists", 
data <- subset(df, select = c("Nombre / Galeria / Espacio", "Artistas" ,"Año de fecha de inauguracion (aaaa)"))
data <- data|>rename(c(galleries = "Nombre / Galeria / Espacio", artists = "Artistas", year = "Año de fecha de inauguracion (aaaa)"))


# splitting the strings of Artists and saving as new variable
data1<-data %>%  
  separate_rows(artists, sep = ", ") %>%
  mutate(across(c(artists, galleries), function(x){iconv(x, to='ASCII//TRANSLIT')}))


# removing all the cases with NA
data1$year <- as.integer(str_extract(data1$year, regex("^[0-9]{4}")))

list <- c("2011-2012-2013", "marzo", "29", "n", "N/A", "NN", "S.I", "s.i.", "S.I/S.I/2009", "S/F")
for (i in list) {
  data1$artists<-na_if(data1$artists,i)
  
}


data2<-data1[complete.cases(data1), ]
data2

```

### Date-Variable recoding to a decade-Variable

To compact the data set further, individual years may be a bit overkill for the later diagram. To solve this, while still remaining accurate, I use decades.

```{r}
data2$decade <- data2$year%/%10*10 #dividing by ten "omits" the last digit and multiplying by ten gives us the decade of the artists' invitation
data2<-drop_na(data2)

```

### Counting the time artists were invited to which galleries and merging a complete data frame

Lastly, the data set needs a variable that displays, how many times artists were invited to each gallery. To create such a data frame, we need to group the data according to the artists and galleries and then count how many times a gallery invited the artist. That way, duplicated information is eliminated and the data frame is reduced from 19.738 to 8,567 rows

```{r}
artgal<-data2|>
  group_by(artists, galleries,decade) |>
  count(artists)
artgal
```

### Further reduction

Since more than 8.000 unique cases are still too much for the diagram, I should reduce the data based on the number of invitations, omitting those with just 1,2,3, etc. invitations. Further, the data should be dividable into the decade of interest.

```{r}
# creating a df that only permits cases with invitations over a certain threshold (as indicated by `NumberOfInvitations`, default value of 0 returns every observation)

ReduceInvitations <- function(NumberOfInvitations) {
  if (NumberOfInvitations>0){
  list=1:NumberOfInvitations
    for (i in list) {
      artgal$n <- artgal$n|>na_if(i)
    }
    artgal<-artgal[complete.cases(artgal), ]
  } else {
    artgal<-artgal[complete.cases(artgal), ]
  }
}  


# separator to split the data set containing only those of a given decade (as indicated by `TargetDecade`, default value of 0 returns complete df)
FindDecadeDF <- function(TargetDecade, TargetDF) {
  if (TargetDecade>0){
    sanart<-TargetDF|>group_by(TargetDF$decade)|>nest()
    indexpos<-match(TargetDecade, sanart$`TargetDF$decade`)
    sanart$data[[indexpos]]
  } else {
    sanart<-TargetDF
  }
}  

```

To achieve this, two functions have been developed for this purpose.

The first function *overwrites* the existing data frame "artgal" with a new data frame also called artgal. In this new data frame, the rows contain only those cases, that exceed the number of observations specified. E.G.: if you want to include only the cases, where artists have been invited more than 10 times execute ReduceInvitations(10). This overwrites the data set, omitting any cases, that have less than 10 invitations in a decade. The default 0, returns the complete artgal data frame.

The other function splits the data frame into grouped data frames according to the decades and returns the data frame of the decade you specified. E.G.: if you want to observe the invitations of the decade 1990 to 2000 you input FindDecadeDF(2000). This returns a tibble containing only the cases for the decade 1990-2000. The default 0 returns nothing. If you don't want to specify the decade, use the data frame **artgal**, if you want to use a decade-specific data frame, use **sanart**

# Visualization

### Packages and preparation

To create the sankey diagram I chose the networkD3 package. If you need to install the package use install.packages("networkD3") in your console. After that, specify your desired parameters using the above mentioned functions. As we will see in a bit, leaving the parameters unspecified and using all 8.000+ cases results in an indistinguishable diagram. The code below develops the sankey diagram. If you want to look at the diagram without specifications, I recommend running the complete chunk as is.

### Specifications

This will be a little complicated, but I tried to phrase it as easily as possible.

There are three values, that impact what sankey diagram you want. The first value, is the value of the *ReduceInvitations* function. As explained earlier, specify how many invitations are a minimum requirement for the graph. The output is saved into the data frame x.

If you want to **add** the *FindDecadeDF* function and specify the decade of the graph, the first argument of the function should be the desired decade and the second should be the data frame you want the information from. E.G.: you reduce the data with ReduceInvitations and want to reduce further. *You have to use ReduceInvitations first and specify x as the data set* you want to pull the information from. If you *dont want to reduce the invitations*, but are interested in reducing the decade, use *artgal* as data set. This way you can play around yourself.

Additionally, I recommend running the entire chunk every time. If there is an error or an empty sankey diagram pops up, go through it line by line. Pay special attention to **x** in you Environment. If the specification of the functions are too limited, **x** will have 0 observations or obtain the value NULL. Play around with the values, I hope this at least to a degree what you wished for your project. There might be limited time before the finalization, but if there is anything you wish to be handled differently don't hesitate to write me :)

```{r}
library(networkD3)
# Failsafe reloading the data set: since the ReduceInvitations function uses the original artgal, we have to reload the data set every time we want to change the number of invitations --> This is subject to improvement, but for now it works
artgal<-data2|>
  group_by(artists, galleries,decade) |>
  count(artists)

x <- ReduceInvitations(0)
x <- FindDecadeDF(0, x)


links <- data.frame(
  source=x$galleries,
  target=x$artists,
  value=x$n
)

nodes <- data.frame(
  name=c(as.character(links$source),
         as.character(links$target))|>unique()
)

links$IDsource <- match(links$source, nodes$name)-1
links$IDtarget <- match(links$target, nodes$name)-1

#Network
sankey <- sankeyNetwork(Links = links, Nodes = nodes, 
                        Source = "IDsource", Target = "IDtarget",
                        Value = "value", NodeID = "name",
                        sinksRight = FALSE)
sankey

```





# Playing around with the functions:
## First Case: Every artist invited >5 times in 1970
```{r eval=TRUE, echo=FALSE}
artgal<-data2|>
  group_by(artists, galleries,decade) |>
  count(artists)

x <- ReduceInvitations(5)
x <- FindDecadeDF(1970, x)


links <- data.frame(
  source=x$galleries,
  target=x$artists,
  value=x$n
)

nodes <- data.frame(
  name=c(as.character(links$source),
         as.character(links$target))|>unique()
)

links$IDsource <- match(links$source, nodes$name)-1
links$IDtarget <- match(links$target, nodes$name)-1

#Network
sankey <- sankeyNetwork(Links = links, Nodes = nodes, 
                        Source = "IDsource", Target = "IDtarget",
                        Value = "value", NodeID = "name",
                        sinksRight = FALSE)
sankey
```


## Second Case: Every artist invited >10 times in 1970

```{r eval=TRUE, echo=FALSE}
artgal<-data2|>
  group_by(artists, galleries,decade) |>
  count(artists)

x <- ReduceInvitations(10)
x <- FindDecadeDF(1970, x)


links <- data.frame(
  source=x$galleries,
  target=x$artists,
  value=x$n
)

nodes <- data.frame(
  name=c(as.character(links$source),
         as.character(links$target))|>unique()
)

links$IDsource <- match(links$source, nodes$name)-1
links$IDtarget <- match(links$target, nodes$name)-1

#Network
sankey <- sankeyNetwork(Links = links, Nodes = nodes, 
                        Source = "IDsource", Target = "IDtarget",
                        Value = "value", NodeID = "name",
                        sinksRight = FALSE)
sankey
```

## Third case: Every artist invited >5 times in 2010
```{r eval=TRUE, echo=FALSE}
artgal<-data2|>
  group_by(artists, galleries,decade) |>
  count(artists)

x <- ReduceInvitations(5)
x <- FindDecadeDF(2010, x)


links <- data.frame(
  source=x$galleries,
  target=x$artists,
  value=x$n
)

nodes <- data.frame(
  name=c(as.character(links$source),
         as.character(links$target))|>unique()
)

links$IDsource <- match(links$source, nodes$name)-1
links$IDtarget <- match(links$target, nodes$name)-1

#Network
sankey <- sankeyNetwork(Links = links, Nodes = nodes, 
                        Source = "IDsource", Target = "IDtarget",
                        Value = "value", NodeID = "name",
                        sinksRight = FALSE)
sankey
```

