---
title: "timow98"
author: "Timo Walcher"
date: "`r Sys.Date()`"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

options(repos = c(CRAN = "https://cloud.r-project.org"))
if (!requireNamespace("pacman", quietly = TRUE)) {
  install.packages("pacman")} 
library(pacman)
p_load(tidyverse, cowplot)
```

## Data Manipulation Goals
*Converting the ‘Date’ column to a proper date format to facilitate time-based analysis. 

Read the CSV file and display the head of the data. We can format the date column when importing the file.
```{r}
NVDA <- read_csv("NVDA_messedUp_final.csv", 
    col_types = cols(Date = col_date(format = "%Y-%m-%d"))) # Date format
head(NVDA)
```
*Calculating monthly closing values from the dataset to identify trends and patterns in the stock performance over time.
Here we can use dplyr to get a new dataframe with mean closing values per month, per week and per year.
```{r}
# Create mean values per month, week and year
NVDA_monthly <- NVDA %>%
  mutate(month = format(Date, "%Y-%m")) %>%
  group_by(month) %>%
  summarise(mean_close = mean(Close, na.rm = TRUE))

NVDA_weekly <- NVDA %>%
  mutate(week = format(Date, "%Y-%W"),
         weeknumber = format(Date, "%W")) %>%
  group_by(week) %>%
  summarise(mean_close = mean(Close, na.rm = TRUE),
            weeknumber = first(weeknumber))

NVDA_yearly <- NVDA %>%
  mutate(year = format(Date, "%Y")) %>%
  group_by(year) %>%
  summarise(mean_close_year = mean(Close, na.rm = TRUE))

print(NVDA_monthly)
print(NVDA_weekly)
print(NVDA_yearly)
```

```{r}
# Also transform into Data format in weekly
NVDA_weekly <- NVDA_weekly %>%
  mutate(week = as.Date(paste0(week,"-01"), format = "%Y-%W-%d"))
# which gives back wrong week numbers

# Also add a column in NVDA_weekly with year
NVDA_weekly <- NVDA_weekly %>%
  mutate(year = lubridate::year(week))

# Merge both dataframes based on year column
NVDA_merged <- merge(NVDA_weekly, NVDA_yearly, by = "year", all.x = TRUE, suffixes = c("_weekly", "_yearly"))

# make new column "percentage" showing the deviation of a week to the yearly average
NVDA_merged <- NVDA_merged %>%
  mutate(deviation = mean_close - mean_close_year,
         percentage = (deviation / mean_close_year) * 100)

print(NVDA_weekly)
print(NVDA_yearly)
print(NVDA_merged)

```

## Visualisation Plot 1
The closing values are now used to produce two charts
*A plot with a logarithmic scale to highlight percentage changes over time.

First of all, the new dataframe with the column month is of type character. I need to change it back to the date format.
```{r}
NVDA_monthly$month <- as.Date(paste0(NVDA_monthly$month, "-01"))
```

When using logarithmic scales, NA values would create an error message, so first of all we need to do something about that. It would be possible to add just a tiny constant to all the NA values or just delete them.
```{r}
NVDA_monthly <- NVDA_monthly %>%
  filter(mean_close > 0)
```
Adding a small constant would look like this:
NVDA_monthly$mean_close_p <- NVDA_monthly$mean_close + 1e-6
But it would not be useful because there is only one NA value which is basically the recent month.

Now we can plot it.
```{r}
# This is for the labels on the x-axis
break_years <- as.Date(c("2000-01-01", "2010-01-01", "2020-01-01"))

p1 <- ggplot(NVDA_monthly, aes(x = month, y = mean_close)) +
  geom_line(group = 1, color = "blue", linewidth = 1) +
  scale_y_log10(breaks = c(1, 10, 100, 1000), 
                label = \(tickposition) scales::comma(tickposition))+
  scale_x_date(breaks = break_years, labels = format(break_years, "%Y"), date_labels = "%Y") +
  labs(
    x = "Date",
    y = "Monthly values (log)",
    title = "NVIDIA STOCK CHART - Logarithmic scale") +
  theme(panel.grid = element_line(colour = "lightgrey"),
        panel.background = element_rect(fill = "white"))
  
```

*A plot with a linear scale to provide a clear representation of absolute stock values.
```{r}
# This is for the labels on the x-axis
break_years <- as.Date(c("2000-01-01", "2010-01-01", "2020-01-01"))

p2 <- ggplot(NVDA_monthly, aes(x = month, y = mean_close)) +
  geom_line(group = 1, color = "black", linewidth = 1) +
  scale_y_continuous(breaks = c(0,200,400,600,800), limits = c(0,800))+
  scale_x_date(breaks = break_years, labels = format(break_years, "%Y"), date_labels = "%Y") +
  labs(
    x = "Date",
    y = "Monthly values",
    title = "NVIDIA STOCK CHART - Linear scale") +
  theme(panel.grid = element_line(colour = "lightgrey"),
        panel.background = element_rect(fill = "white"))
```
Now both plots next to each other
```{r plot_grid_output, fig.width=10, fig.height=5}
plot_grid(p1, p2, ncol = 2)
```

## Visualisation Plot 2
```{r}

```

