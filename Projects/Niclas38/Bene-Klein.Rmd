---
title: "Bene-Klein"
output: md_document
---
```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```
```{r include = FALSE}
#Here packages
library(tidyverse)
setwd(
  # using RStudio library
  dirname(rstudioapi::getActiveDocumentContext()$path)
  # using additional library
  # this.path::this.dir()
)
```

# Data manipulation

```{r Data manipulation}
df<-read.csv('movies.csv',na.strings=c("","NA"),encoding="UTF-8") |>
  as.data.frame()|>
  mutate(
  
  ONE.LINE = str_remove_all(ONE.LINE, "\n"),
  GENRE = str_remove_all(GENRE, "\n"),
  STARS = STARS |> str_remove_all("\n") |> str_remove_all(".*(Stars|Star|Director|Directors....):"),
  GENRE = str_split(GENRE,",\\s*"[[1]]),
  STARS = str_split(STARS,",\\s*"[[1]]),
  VOTES = str_replace_all(VOTES,",",""),
  YEAR = str_remove_all(YEAR,"[a-z]"),
  YEAR = str_remove_all(YEAR,"[A-Z]"),
  YEAR = str_replace_all(YEAR, "\\((.*?)\\)","\\1"),
    Start = as.numeric(str_extract(YEAR, "\\d{4}")),
    End = as.numeric(ifelse(str_detect("--", YEAR),ifelse(grepl("^\\d{4}--", x),2022,as.numeric(str_extract(x, "\\d{4}$"))),Start)),
    #End = ifelse(str_extract(YEAR, "-\\)"), 2022, End),  # If the end is missing, set it to 2022
    #End = ifelse(is.na(End), Start, End),  # If there's no end year, use start year
    Year_List = mapply(function(s, e) if (!is.na(s) & !is.na(e)) seq(s, e) else NA, Start, End, SIMPLIFY = FALSE)
)
final_table <- df %>% select(YEAR, Start, End, Year_List)
final_table
```

# Visualization
```{r Feedback, fig.width=10, fig.height=6}
data_expanded <- df %>%
  unnest(GENRE) %>%
  mutate(
    GENRE = trimws(GENRE),
    GENRE = as.factor(GENRE),
    VOTES = as.numeric(VOTES),
    GENRE = fct_reorder(GENRE, RATING, .fun = mean, .desc = TRUE)  # Sort by mean RATING (descending)
  )

long_data <- data_expanded %>%
  pivot_longer(cols = c(RATING, VOTES), 
               names_to = "SOURCE", 
               values_to = "VALUE") %>%
  mutate(
    SOURCE = recode(SOURCE, RATING = "Critic", VOTES = "Audience"),
    GENRE = fct_reorder(GENRE, VALUE, .fun = mean, .desc = TRUE)
  )
ggplot(long_data, aes(x = Start, y = VALUE, fill = GENRE, color = GENRE)) +
  geom_point(size = 1) +
  facet_wrap(~ SOURCE, scales = "free_y") +
  labs(
    title = "Media Feedback Over the Years",
    x = "Year",
    y = NULL,
    fill = "Genre (sorted by mean Rating)",
    color = "Genre (sorted by mean Rating)"
  ) +
  theme_minimal()

```

```{r rating discrepancy , fig.width=10, fig.height=6}
df %>%
  mutate(
    VOTES = as.numeric(VOTES)  # Convert VOTES to numeric, ensuring it's numeric
  ) %>%
  arrange(desc(VOTES)) %>%               # Sort by VOTES in descending order
  mutate(
    max_votes = VOTES[1],                 # Get the max VOTES value
    discr = ifelse(is.na(RATING) | is.na(VOTES), NA, RATING - (VOTES * 10 / max_votes))  # Calculate discrepancy
  ) %>%
  ggplot(aes(x = discr)) +
  geom_histogram(binwidth = 0.1, fill = "steelblue", color = "black", alpha = 0.7) +
  labs(
    title = "Discrepancy of Ratings",
    x = "IMDb rating minus normalized audience votes (<- Audience only, Critic only ->)",
    y = "count"
  ) +
  theme_minimal()
```


```{r Actor movie rating, fig.width=10, fig.height=6}
data_expanded_stars <- df %>%
  unnest(STARS) %>%
  group_by(STARS) %>%
  summarise(mean_RATING = mean(RATING, na.rm = TRUE)) %>%
  arrange(desc(mean_RATING)) %>%  # Sorting by rating
  head(50)   # Take the first 50 stars

# Plot the data
ggplot(data_expanded_stars, aes(x = reorder(STARS, mean_RATING), y = mean_RATING)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +  # Flip to make names readable
  labs(title = "Top 50 Stars by Mean Rating",
       x = "Star Name",
       y = "Mean Rating") +
  theme_minimal()
```
