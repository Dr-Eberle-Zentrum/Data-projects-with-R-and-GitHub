---
title: "Marketing analysis of Bigmart sales"
subtitle: "Solution by Baptiste"
author: "baptistesolard"
date: "`r Sys.Date()`"
output: md_document
---

```{r setup, include = F, warning = F, message = F}
# library loading and data import
library(tidyverse)
library(knitr)
library(scales)
knitr::opts_chunk$set(warning = F, message = F)
Dataset <- read_csv("data.csv")
```

# Marketing analysis of Bigmart sales - Solution by Baptiste

## Data wrangling

### The original `Dataset` needs some small changes:

- Creation of `Item_Revenue`
- Removing the rows with `NA` in `Outlet_Size`
- I decided to keep the rows having `NA` in `Item_Weight` since we will not use this variable, so it will not cause any problems
```{r Dataset_wrangling}
Dataset <- Dataset |>
  mutate(Item_Revenue = Item_MRP * 0.7 * Item_Outlet_Sales) |>
  filter(!is.na(Outlet_Size))

kable(Dataset[1:10, ])
```

### New dataset for visualisation 1

To simplify data handling before the visualisation of Sales or Revenue vs. Item type, I suggest to create a intermdiate data table `Dataset_V1`, which summarise:  
- the sum of all `Item_Outlet_Sales` of each `Item_Type` into `Sum_Sales`  
- the sum of all `Item_Revenue` of each `Item_Type` into `Sum_Revenue`  
- the average `Item_visibility` of each `Item_Type` into `Avg_Visibility`  
- the proportion of `Sum_Sales` represented by each `Item_Type` into `Prop_Sales`  
- the proportion of `Sum_Revenue` represented by each `Item_Type` into `Prop_Revenue`  

```{r Prop_function, include = F}
#### I DON'T NEED THIS ANYMORE ####

#' There are 3 steps to create the Prop_Sales and Prop_Revenue columns, 
#' so I decided to make a function for that to make it simpler to handle;
prop <- function(x) {
  (x * 100 / sum(x)) |>  # calculates the % value
    round(3) |>  # rounds the values but keeps the 0 when needed (return a str)
    sprintf(fmt = "%.2f") |> # keeps all 
    str_c("%") # adds the % sign
}
```
Here is an extract of the new `Dataset_V1` table:
```{r Dataset_V1}
Dataset_V1 <- Dataset |>
  group_by(Item_Type) |>
  summarise(Sum_Sales = sum(Item_Outlet_Sales), 
            Sum_Revenue = sum(Item_Revenue),
            Avg_Visibility = mean(Item_Visibility)) |>
  mutate(Prop_Sales = Sum_Sales * 100 / sum(Sum_Sales),
         Prop_Revenue = Sum_Revenue * 100 / sum(Sum_Revenue))

kable(Dataset_V1[1:5, ])
```

### New dataset for visualisation 2

For the objectives of visualisation 2, we will need to create two subset of the orinigal `Dataset`:  
- `Dataset_V2a` that summarise the sales and revenue of the items by `Outlet_Type`  
- `Dataset_V2b` that summarise the sales and revenue of the items by `Outlet_Size`  

Here we have `Dataset_V2a`:
```{r Dataset_V2a}
Dataset_V2a <- Dataset |>
  group_by(Item_Type, Outlet_Size) |>
  summarise(Sum_Sales = sum(Item_Outlet_Sales), 
            Sum_Revenue = sum(Item_Revenue),
            Avg_Visibility = mean(Item_Visibility))

kable(Dataset_V2a[1:5, ])
```

And here we have an extract of the new `Dataset_V2b`:
```{r Dataset_V2b}
Dataset_V2b <- Dataset |>
  group_by(Item_Type, Outlet_Location_Type) |>
  summarise(Sum_Sales = sum(Item_Outlet_Sales), 
            Sum_Revenue = sum(Item_Revenue),
            Avg_Visibility = mean(Item_Visibility))

kable(Dataset_V2b[1:5, ])
```

---

## Visualisation goals

### Sales vs. Item type

```{r sales_type}
#' First I want to generate the vector that will be used for the % labels.
Prop_Sales_lab <- Dataset_V1$Prop_Sales |>
  round(3) |>
  sprintf(fmt = "%.2f") |>
  str_c("%")

ggobj1 <-
  ggplot(data = Dataset_V1, aes(x = Item_Type, y = Sum_Sales, fill = Avg_Visibility)) +
  geom_col() +
  labs(x = "Item type", y = "Total sales",
       fill = "Average\nvisibility") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = scales::comma) +
  geom_text(aes(label = Prop_Sales_lab), size = 3, vjust = -0.5, hjust = 0.5) +
  scale_fill_gradient2(low = "tomato", mid = "lightyellow", high = "forestgreen", midpoint = mean(Dataset_V1$Avg_Visibility))

ggsave("Plot_Sale vs Type_BS.png", plot = ggobj1, 
       width = 300, height = 200, units = "mm", dpi = 600)
```

![Plot Sales vs Type]("Plot_Sale vs Type_BS.png"){#id .class width=100%}

Turns out that there are not much difference in `Avg_Visibility` between the different `Item_Type`.  
An explanation could be that the `Item_Visibility` is calculated for each indiviual item within its own category (= `Item_Type`), i.e., already homogenised.


### Revenue vs. Item type

I took the liberty of putting the scale of `Sum_Revenue` in million dollars.  
```{r revenue_type}
#' First I want to generate the vector that will be used for the % labels.
Prop_Revenue_lab <- Dataset_V1$Prop_Revenue |>
  round(3) |>
  sprintf(fmt = "%.2f") |>
  str_c("%")

ggobj2 <-
  ggplot(data = Dataset_V1, aes(x = Item_Type, y = Sum_Revenue / 1e6, fill = Avg_Visibility)) +
  geom_col() +
  labs(x = "Item type", y = "Total revenue (in M$)",
              fill = "Average\nvisibility") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_text(aes(label = Prop_Revenue_lab), size = 3, vjust = -0.5, hjust = 0.5) +
  scale_fill_gradient2(low = "tomato", mid = "lightyellow", high = "forestgreen", midpoint = mean(Dataset_V1$Avg_Visibility))

ggsave("Plot_Revenue vs Type_BS.png", plot = ggobj2, 
       width = 300, height = 200, units = "mm", dpi = 600)
```

![Plot Revenue vs Type]("Plot_Revenue vs Type_BS.png"){#id .class width=100%}

Looks like the relative proportion of `Sum_Sales` and `Sum_Revenue` are pretty much the same between `Item_Type`.

### Total sales by outlet size

For the next 4 facet plots, I took the liberty to display the facets on the same row, so the comparison of the y-axis is easier to make. I also kept the labels on the x-axis turned to 90Â° and not slanted, otherwise they are too cramped to be displayed properly.

```{r sales_type_size}
ggobj3 <-
  ggplot(data = Dataset_V2a, aes(x = Item_Type, y = Sum_Sales, fill = Avg_Visibility)) +
  geom_col() +
  facet_wrap(~ factor(Outlet_Size, levels = c("Small", "Medium", "High")), nrow = 1) +
  labs(x = "Item type", y = "Total sales",
       fill = "Average\nvisibility") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_gradient2(low = "tomato", mid = "lightyellow", high = "forestgreen", midpoint = mean(Dataset_V1$Avg_Visibility))

ggsave("Plot_Sales vs Type by Size_BS.png", plot = ggobj3, 
       width = 300, height = 200, units = "mm", dpi = 600)
```

![Plot Sales vs Type by Size]("Plot_Sales vs Type by Size_BS.png"){#id .class width=100%}

There are more sales in medium-sized outlets.  
Here it seems that the `Avg_Visibility` changes according to `Outlet_Size`. The small-sized outlets have the best average visibility of their products.

### Total sales by location type

```{r sales_type_location}
ggobj4 <-
  ggplot(data = Dataset_V2b, aes(x = Item_Type, y = Sum_Sales, fill = Avg_Visibility)) +
  geom_col() +
  facet_wrap(~ Outlet_Location_Type, nrow = 1) +
  labs(x = "Item type", y = "Total sales",
       fill = "Average\nvisibility") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_gradient2(low = "tomato", mid = "lightyellow", high = "forestgreen", midpoint = mean(Dataset_V1$Avg_Visibility))

ggsave("Plot_Sales vs Type by Location_BS.png", plot = ggobj4, 
       width = 300, height = 200, units = "mm", dpi = 600)
```

![Sales vs Type by Location]("Plot_Sales vs Type by Location_BS.png"){#id .class width=100%}

Interestingly, there are more sales in Tier 3 outlets, although the highest visibility is seen in Tier 1 outlets.

### Total revenue by outlet size

```{r revenue_type_size}
ggobj5 <-
  ggplot(data = Dataset_V2a, aes(x = Item_Type, y = Sum_Revenue / 1e6, fill = Avg_Visibility)) +
  geom_col() +
  facet_wrap(~ factor(Outlet_Size, levels = c("Small", "Medium", "High")), nrow = 1) +
  labs(x = "Item type", y = "Total revenue (in M$)",
       fill = "Average\nvisibility") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_fill_gradient2(low = "tomato", mid = "lightyellow", high = "forestgreen", midpoint = mean(Dataset_V1$Avg_Visibility))

ggsave("Plot_Revenue vs Type by Size_BS.png", plot = ggobj5, 
       width = 300, height = 200, units = "mm", dpi = 600)
```

![Plot Revenue vs Type by Size]("Plot_Revenue vs Type by Size_BS.png"){#id .class width=100%}

Similarly to what we observed in the total number of sales, the sum of revenue is higher in medium-sized outlets.

### Total revenue by outlet location type

```{r revenue_type_location}
ggobj6 <-
  ggplot(data = Dataset_V2b, aes(x = Item_Type, y = Sum_Revenue / 1e6, fill = Avg_Visibility)) +
  geom_col() +
  facet_wrap(~ Outlet_Location_Type, nrow = 1) +
  labs(x = "Item type", y = "Total revenue (in M$)",
       fill = "Average\nvisibility") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_fill_gradient2(low = "tomato", mid = "lightyellow", high = "forestgreen", midpoint = mean(Dataset_V1$Avg_Visibility))

ggsave("Plot_Revenue vs Type by Location_BS.png", plot = ggobj6, 
       width = 300, height = 200, units = "mm", dpi = 600)
```

![Plot Revenue vs Type by Location]("Plot_Revenue vs Type by Location_BS.png"){#id .class width=100%}

Again, we have a similar results than for the total number of sales: the revenues are generally higher in Tier 3 outlets.

