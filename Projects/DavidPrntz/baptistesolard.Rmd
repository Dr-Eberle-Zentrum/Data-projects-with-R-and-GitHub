---
title: "Marketing analysis of Bigmart sales"
subtitle: "Solution by Baptiste"
author: "baptistesolard"
date: "`r Sys.Date()`"
output: md_document
---

```{r setup, include = F, warning = F, message = F}
# library loading and data import
library(tidyverse)
library(knitr)
knitr::opts_chunk$set(echo = F, warning = F, message = F)
Dataset <- read_csv("data.csv")
```

# Marketing analysis of Bigmart sales - Solution by Baptiste

## Data wrangling

### The original `Dataset` needs some small changes:

- Creation of `Item_Revenue`
- Removing the rows with `NA` in `Outlet_Size`
- I decided to keep the rows having `NA` in `Item_Weight` since we will not use this variable, so it will not cause any problems
```{r Dataset_wrangling}
Dataset <- Dataset |>
  mutate(Item_Revenue = Item_MRP * 0.7 * Item_Outlet_Sales) |>
  filter(!is.na(Outlet_Size))

kable(Dataset[1:10, ])
```

### New dataset for visualisation 1

To simplify data handling before the visualisation of Sales or Revenue vs. Item type, I suggest to create a intermdiate data table `Dataset_V1`, which summarise:
- the sum of all `Item_Outlet_Sales` of each `Item_Type` into `Sum_Sales`
- the sum of all `Item_Revenue` of each `Item_Type` into `Sum_Sales`
- the average `Item_visibility` of each `Item_Type` into `Avg_Visibility`  
Additionally, we can already add the proportions taken by each `Item_Type` for those new variations, which will be usefull for labelling the bars in the barplots.
```{r Prop_function}
#' There are 3 steps to create the Prop_Sales and Prop_Revenue columns, 
#' so I decided to make a function for that to make it simpler to handle;
"prop" <- function(x) {
  vec <- x * 100 / sum(x)  # calculates the % value
  vec <- sprintf("%.2f", round(vec, 3))  # rounds the values but keeps the 0 when needed (return a str)
  vec <- str_c(vec, "%")  # adds the % sign
  return(vec)
}
```
Here is the new `Dataset_V1` table:
```{r Dataset_V1}
Dataset_V1 <- Dataset |>
  group_by(Item_Type) |>
  summarise(Sum_Sales = sum(Item_Outlet_Sales), 
            Sum_Revenue = sum(Item_Revenue),
            Avg_Visibility = mean(Item_Visibility)) |>
  mutate(Prop_Sales = prop(Sum_Sales),
         Prop_Revenue = prop(Sum_Revenue))

kable(Dataset_V1)
```

### New dataset for visualisation 2

For the objectives of visualisation 2, we will need to create two subset of the orinigal `Dataset`:
- `Dataset_V2a` that summarise the sales and revenue of the items by `Outlet_Type`
 - `Dataset_V2b` that summarise the sales and revenue of the items by `Outlet_Size`

Here we have `Dataset_V2a`:
```{r Dataset_V2a}
Dataset_V2a <- Dataset |>
  group_by(Item_Type, Outlet_Size) |>
  summarise(Sum_Sales = sum(Item_Outlet_Sales), 
            Sum_Revenue = sum(Item_Revenue),
            Avg_Visibility = mean(Item_Visibility))

kable(Dataset_V2a)
```

And here we have `Dataset_V2b`:
```{r Dataset_V2b}
Dataset_V2b <- Dataset |>
  group_by(Item_Type, Outlet_Location_Type) |>
  summarise(Sum_Sales = sum(Item_Outlet_Sales), 
            Sum_Revenue = sum(Item_Revenue),
            Avg_Visibility = mean(Item_Visibility))

kable(Dataset_V2b)
```

---

## Visualisation goals

### Sales vs. Item type

```{r sales_type, out.width = "100%"}
#' These 3 lines generate the breaks and labs that will be used on the y axis
max.y.axis <- ceiling( max(Dataset_V1$Sum_Sales) / 1e6) * 1e6
y.breaks <- seq(0,max.y.axis, length.out = (max.y.axis / 1e6) + 1)
y.labs <- str_replace(format(y.breaks, scientific = F), "(\\d{1})(\\d{3})(\\d{3})", "\\1,\\2,\\3")

ggplot(data = Dataset_V1, aes(x = Item_Type, y = Sum_Sales, fill = Avg_Visibility)) +
  geom_col() +
  labs(x = "Item type", y = "Sum of sales") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_cartesian(ylim = c(0, max.y.axis)) +
  scale_y_continuous(breaks = y.breaks,
                     labels = y.labs) +
  geom_text(aes(label = Prop_Sales), size = 3, vjust = -0.5, hjust = 0.5) +
  scale_fill_gradient2(low = "forestgreen", mid = "gold", high = "tomato", midpoint = mean(Dataset_V1$Avg_Visibility))
```

Turns out that there are not much difference in `Avg_Visibility` between the different `Item_Type`.  
An explanation could be that the `Item_Visibility` is calculated for each indiviual item within its own category (= `Item_Type`), i.e., already homogenised.


### Sales vs. Item type

I took the liberty of putting the scale of `Sum_Revenue` in million dollars.  
```{r revenue_type, out.width = "100%"}
ggplot(data = Dataset_V1, aes(x = Item_Type, y = Sum_Revenue / 1e6, fill = Avg_Visibility)) +
  geom_col() +
  labs(x = "Item type", y = "Total revenue (in M$)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_text(aes(label = Prop_Revenue), size = 3, vjust = -0.5, hjust = 0.5) +
  scale_fill_gradient2(low = "forestgreen", mid = "gold", high = "tomato", midpoint = mean(Dataset_V1$Avg_Visibility))
```

Looks like the relative proportion of `Sum_Sales` and `Sum_Revenue` are pretty much the same between `Item_Type`.

### Total sales by outlet size

```{r sales_type_size, out.width = "100%"}
#' These 3 lines generate the breaks and labs that will be used on the y axis
max.y.axis <- ceiling( max(Dataset_V2a$Sum_Sales) / 1e6) * 1e6
y.breaks <- seq(0,max.y.axis, length.out = (max.y.axis / 1e6) * 2 + 1)
y.labs <- str_replace(format(y.breaks, scientific = F), "(\\d{1})(\\d{3})(\\d{3})", "\\1,\\2,\\3")

ggplot(data = Dataset_V2a, aes(x = Item_Type, y = Sum_Sales, fill = Avg_Visibility)) +
  geom_col() +
  facet_wrap(~ Outlet_Size, nrow = 1) +
  labs(x = "Item type", y = "Sum of sales") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_cartesian(ylim = c(0, max.y.axis)) +
  scale_y_continuous(breaks = y.breaks,
                     labels = y.labs) +
  scale_fill_gradient2(low = "forestgreen", mid = "gold", high = "tomato", midpoint = mean(Dataset_V2a$Avg_Visibility))
```

There are more sales in medium-sized outlets.  
Here it seems that the `Avg_Visibility` changes according to `Outlet_Size`. The small-sized outlets have the best average visibility of their products.

### Total sales by location type

```{r sales_type_location, out.width = "100%"}
#' These 3 lines generate the breaks and labs that will be used on the y axis
max.y.axis <- ceiling( max(Dataset_V2b$Sum_Sales) / 1e6) * 1e6
y.breaks <- seq(0,max.y.axis, length.out = (max.y.axis / 1e6) * 2 + 1)
y.labs <- str_replace(format(y.breaks, scientific = F), "(\\d{1})(\\d{3})(\\d{3})", "\\1,\\2,\\3")

ggplot(data = Dataset_V2b, aes(x = Item_Type, y = Sum_Sales, fill = Avg_Visibility)) +
  geom_col() +
  facet_wrap(~ Outlet_Location_Type, nrow = 1) +
  labs(x = "Item type", y = "Sum of sales") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_cartesian(ylim = c(0, max.y.axis)) +
  scale_y_continuous(breaks = y.breaks,
                     labels = y.labs) +
  scale_fill_gradient2(low = "forestgreen", mid = "gold", high = "tomato", midpoint = mean(Dataset_V2a$Avg_Visibility))
```

Interestingly, there are more sales in Tier 3 outlets, although the highest visibility is seen in Tier 1 outlets.

### Total revenue by outlet size

```{r revenue_type_size, out.width = "100%"}
ggplot(data = Dataset_V2a, aes(x = Item_Type, y = Sum_Revenue / 1e6, fill = Avg_Visibility)) +
  geom_col() +
  facet_wrap(~ Outlet_Size, nrow = 1) +
  labs(x = "Item type", y = "Total revenue (in M$)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_gradient2(low = "forestgreen", mid = "gold", high = "tomato", midpoint = mean(Dataset_V1$Avg_Visibility))
```

Similarly to what we observed in the total number of sales, the sum of revenue is higher in medium-sized outlets.

### Total revenue by outlet location type

```{r revenue_type_location, out.width = "100%"}
ggplot(data = Dataset_V2b, aes(x = Item_Type, y = Sum_Revenue / 1e6, fill = Avg_Visibility)) +
  geom_col() +
  facet_wrap(~ Outlet_Location_Type, nrow = 1) +
  labs(x = "Item type", y = "Total revenue (in M$)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_gradient2(low = "forestgreen", mid = "gold", high = "tomato", midpoint = mean(Dataset_V1$Avg_Visibility))
```

Again, we have a similar results than for the total number of sales: the revenues are generally higher in Tier 3 outlets.

