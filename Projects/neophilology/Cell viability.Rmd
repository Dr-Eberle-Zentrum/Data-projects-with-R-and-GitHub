---
title: "Julia's Project"
author: "Daniel Barrera"
date: "2023-07-09"
output: md_document
---
```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

``` {r, include=FALSE, warning = FALSE, message = FALSE, results='hide', echo=FALSE}
{
# Libraries
{
library(tidyverse) 
library(corrplot)
library(patchwork)
library(gridExtra)
library(grid)
library(png)
library(downloader)
library(grDevices)
library(ggthemes)
}
# Data
{
# --- Observations ---
# Individual cells
# Reading CSVs as "tibbles" using "readr" from the tidyverse 
dying_cell <- read_csv("Track_one_dying_cell.csv", show_col_types = FALSE)
viable_cell <- read_csv("Track_one_viable_cell.csv", show_col_types = FALSE)
# Group of cells
# Treated cells
df_treat <- read_csv("Tracks_Treated_Cells.csv", show_col_types = FALSE)
# Control group
df_untreat <- read_csv("Tracks_Untreated_Cells.csv", show_col_types = FALSE)
}
# group all dfs into one
{
dfs <- list( dying_cell = select(dying_cell, -c(x,y)), 
             viable_cell = select(viable_cell, -c(x,y)), 
             df_treat = df_treat, 
             df_untreat = df_untreat) |>
  bind_rows( .id="data") 
}
# Show all heads in a tibble  
  { 
dfs_heads <- dfs |> 
  group_by(data) |> 
  slice_head(n=2)
}
# Summary, Correlation and Normalizing time
{
summa <- dfs |> group_by(data) |> 
  summarize( length=n(), numNAs = sum(is.na(Intensity) | is.na(Area)),
             corrTimeIntensity = cor(Time.point,Intensity), 
             corrTimeArea = cor(Time.point, Area))

# Correlation
dfs2 <- select(dfs, -Cell.ID, ) |> 
  group_by(data) |> 
  group_walk( .f= \(table, groupName) corrplot(cor(table), method = "number", title = groupName))

#Normalizing time
norm_dfs <- group_by(dfs,Cell.ID) |> 
  mutate(Time.point = Time.point - min(Time.point)) |>
  ungroup()
}
# Lineplot viable
{
viable_norm <- filter(norm_dfs, data == 'viable_cell') |> 
  mutate(Intensity=scale(Intensity), Area=scale(Area)) |> 
  pivot_longer(c(Intensity,Area)) |>
  ggplot(aes(x=Time.point,y=value,col=name)) + 
  geom_line()+
  geom_hline(yintercept = 0, colour="red")+
  labs(title="Viable cell over time")+
  geom_smooth(linetype = 1) +
  theme_economist() + 
  scale_color_economist('Values')+
  theme_minimal()
  viable_norm
  }
# Lineplot dying
{
dying_tidy<- select(dying_cell, -c(Cell.ID, x, y)) |> 
  mutate(Intensity=scale(Intensity), Area=scale(Area)) |> 
  pivot_longer(c(Intensity,Area)) |>
  ggplot(aes(x=Time.point,y=value,col=name)) + 
  geom_line()+
  geom_hline(yintercept = 0, colour="red")+
  #  geom_density_2d()+
  labs(title="Dying cell over time")+
  geom_smooth(linetype = 2) +
  theme_wsj()+
  scale_colour_wsj('colors6', '')+
  theme_minimal()
dying_tidy  
}
#----"Viable"/"Dying" Column------
#--------- Treated cells ---------
{
  # Determine max size for each cell
  # Select each unique value from Cell-ID column
  # Find max size for each in Area column
  {
    max_size <- df_treat |> 
      arrange(desc(Area)) |> 
      distinct(Cell.ID, .keep_all = TRUE) |> 
      group_by(Cell.ID) |> 
      summarize(Area = max(Area))
    max_a <- max_size$Area
  }
  # Find min size for each in Area column
  {
    min_size <- df_treat |> 
      arrange(Area) |> 
      distinct(Cell.ID, .keep_all = TRUE) |> 
      group_by(Cell.ID) |> 
      summarize(Area = min(Area))
    min_a <- min_size$Area
  }
  #-------------------------
  # Set 40% threshold for each cell
  # point at which each cell will die
   {
    die_at <- c()
    for (i in max_a) {
      die_at <- c(die_at,(i * .40))
    }
  }
  #>-----  New df  ------
  #> Adding four columns: 
  #> Max size | Min size | PoD | Dying/Viable
  ndf <- cbind(max_size, min_a, die_at)
  # Add Dying/Viable label to each cell
  {
    ndf$Dying_OR_viable = ifelse(ndf$min_a < ndf$die_at, 'Dying',
                                 ifelse(ndf$min_a > ndf$die_at, 'Viable', '?'))
  }
  #>-------------------------
  #>-----  Final label ------
  #>-----  to original ------
  #>------ data frame  ------
  #>-------------------------
  viable <- ndf$Cell.ID[ndf$Dying_OR_viable=="Viable"]
  dying <- ndf$Cell.ID[ndf$Dying_OR_viable=="Dying"]
}
#----"Viable"/"Dying" Column------
#-------- Untreated cells --------
{
  # Determine max size for each cell
  # Select each unique value from Cell-ID column
  # Find max size for each in Area column
  {
    max_size <- df_untreat |> 
      arrange(desc(Area)) |> 
      distinct(Cell.ID, .keep_all = TRUE) |> 
      group_by(Cell.ID) |> 
      summarize(Area = max(Area))
    max_a <- max_size$Area
  }
  # Find min size for each in Area column
  {
    min_size <- df_untreat |> 
      arrange(Area) |> 
      distinct(Cell.ID, .keep_all = TRUE) |> 
      group_by(Cell.ID) |> 
      summarize(Area = min(Area))
    min_a <- min_size$Area
  }
  #-------------------------
  # Set 40% threshold for each cell
  # point at which each cell will die
  {
    die_at <- c()
    for (i in max_a) {
      die_at <- c(die_at,(i * .40))
    }
  }
  #>-----  New df  ------
  #> Adding four columns: 
  #> Max size | Min size | PoD | Dying/Viable
  ndf_un <- cbind(max_size, min_a, die_at)
  # Add Dying/Viable label to each cell
  {
    ndf_un$Dying_OR_viable = ifelse(ndf_un$min_a < ndf_un$die_at, 'Dying',
                                 ifelse(ndf_un$min_a > ndf_un$die_at, 'Viable', '?'))
  }
  #>-------------------------
  #>-----  Final label ------
  #>-----  to original ------
  #>------ data frame  ------
  #>-------------------------
  viable <- ndf_un$Cell.ID[ndf_un$Dying_OR_viable=="Viable"]
  dying <- ndf_un$Cell.ID[ndf_un$Dying_OR_viable=="Dying"]
}
# Density plots: TReated and UNtreated
{
  freq_tr <- ggplot(ndf, aes(Area, fill = Dying_OR_viable)) +
    geom_histogram(aes(y = after_stat(density * width)),
                   position = "identity", alpha = 0.5)+
    ggtitle("Treated")+
    theme_minimal()
  freq_un <- ggplot(ndf_un, aes(Area, fill = Dying_OR_viable)) +
    geom_histogram(aes(y = after_stat(density * width)),
                   position = "identity", alpha = 0.5)+
    ggtitle("Unreated")+
    theme_minimal()
}
#Counting Values DoA (death or alive)
{sum_DoA_tr <- df_treat |> 
  group_by(Cell.ID) |> 
  summarize( viable = min(Area) > max(Area)*0.4) |> 
  summarize( mean(viable), sd(viable), 
             numViable = sum(viable), 
             numDying = n()-numViable )

sum_DoA_un <- df_untreat |> 
  group_by(Cell.ID) |> 
  summarize( viable = min(Area) > max(Area)*0.4) |> 
  summarize( mean(viable), sd(viable), 
             numViable = sum(viable), 
             numDying = n()-numViable )
}
# Bar plot total count
{
count_DoA_all <- list( treated = select(sum_DoA_tr, numViable, numDying), 
             untreated = select(sum_DoA_un, numViable, numDying)) |>
  bind_rows( .id="data") 
count_DoA_all

count_DoA <- select(sum_DoA_tr, numViable, numDying)
ggplot(mapping= aes(count_DoA_all))+
  geom_histogram()

count_DoA_long<-count_DoA_all |> 
  pivot_longer(
    cols = !data, 
    names_to = "Condition", 
    values_to = "Count"
  )
Total <- ggplot(count_DoA_long, aes(x=data, y=Count, fill=Condition)) +
  geom_bar(position="dodge",stat="identity")+
  theme_economist() + 
  scale_color_economist('Values')+
#  theme_minimal()+
  ggtitle("Total count")
}
}
```
## Cell viability

In the present project we aim to measure how cells react to a certain treatment by identifying if a cell is viable or dying.

### Goals
- Identify dying cells in both populations.
- Count and plot dying treated and untreated cells.

### The data
We have four data sets with observations of a cell's **intensity** (fluorescence luminosity) and **area** (size) behaviour during treatement.


```{r, echo=FALSE}
{ 
# Summarize all dfs: length | corr | NAs  
  summa
}
```

Notes: 

- not all cells start at the same time point
- not same length
- no NA values. 
- correlation from individual cells is biased


### Visualizing viable and dying cells


```{r, echo=FALSE}
{
viable_norm / dying_tidy
}
```

Notes: 

- Area and Intensity are scaled. 
- The horizontal red line shows the average size and fluorescence and intensity of a cell. A **viable** cell stays around this zone, while the **dying** cell steep under it as time passes.  
- Time has been normalized (starting a zero time point). 

### Dying or viable criteria

**Size (area) is a good indicator of a cell's point of death**. The recommended threshold is 40% size decrease. So, all cells under the 40 percentile relative to their own size will die.


```{r, echo=FALSE}
{
sum_DoA_all <- list(treated = sum_DoA_tr, untreated = sum_DoA_un) |>
  bind_rows( .id="data")
sum_DoA_all
}
```

Notes:

- The difference between groups is not significant

```{r, echo=FALSE}

{
Total
}

```

### Plotting Dying / Viable frequency by size

The following density histogram shows that viable cells tend to be smaller in size. The relative **area** represents the median size of each cell.

```{r, echo=FALSE}
{
un_tr <- ggplot(ndf_un, aes(Area, fill = Dying_OR_viable)) +
    geom_histogram(aes(y = ..density..),lwd =.5,
                   colour = 'darkslategray4', fill = "azure1") +
    geom_density(lwd = .4, linetype = 4, colour = 'red', alpha = 0.6)+
    theme(legend.position="bottom",panel.background = element_blank())+
  ggtitle("Unreated")
treat <- ggplot(ndf, aes(Area, fill = Dying_OR_viable)) +
    geom_histogram(aes(y = ..density..),lwd =.5,
                   colour = 'darkslategray4', fill = "azure1") +
    geom_density(lwd = .4, linetype = 4, colour = 'red', alpha = 0.5)+
    theme(legend.position="bottom",panel.background = element_blank())+
  ggtitle("Treated")
}

treat + un_tr
```





