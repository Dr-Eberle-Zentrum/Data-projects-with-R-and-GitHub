---
output: md_document
---

```{r, setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(tidyverse)
library(haven)
library(stringr)
library(dplyr)
library(ggplot2)
library(ggpmisc)
```

```{r holy_pipe, echo=FALSE}
#Import data
Data2019 <- read_dta("Data2019.dta")
Data2020 <- read_dta("Data2020.dta")
HS_list <- read.csv("HS_2Digit_List.csv")

#The holy pipe. Begins with merging 2019 and 2020 import/export data
data_for_tim <- inner_join(Data2019, Data2020,  by=c("partner_code", "hs_product_code")) %>%
  
  #reduce product codes to 2 digits
  mutate(
    hs_product_code = str_extract(hs_product_code, "\\w\\w")
    ) %>%
  
  #Accumulate all import/exports across the new 2 digit code
  group_by(partner_code,hs_product_code) %>%
  summarize(
    import_2019 = sum(import_value.x), 
    export_2019 = sum(export_value.x),
    import_2020 = sum(import_value.y), 
    export_2020 = sum(export_value.y)
    ) %>%
  
  #Prepping for next merge
  mutate(
    hs_product_code = as.numeric(hs_product_code)
  ) %>%
  
  #Simple way to delete the ANS country code which isn't actually a country.
  #Verified by @HaasTim
  drop_na(.) %>%
  
  #Summarize across product categories and remove any product codes from the
  #Years_Combined data frame that don't have a corresponding codename in the 
  #HS_list. This is probably not the right way to perform this operation but it 
  #works and Years_Combined has a product code of 99 in it which idk what it is.
  inner_join(., HS_list, join_by("hs_product_code" == "code")) %>%
  ungroup() %>%
  group_by(hs_product_code) %>%
  summarize(
            Import_Diff = (sum(import_2020) - sum(import_2019)),
            Export_Diff = (sum(export_2020) - sum(export_2019))
            ) %>%
  
  #Grab the 5 largest in terms of abs value numbers for import and export
  pivot_longer(c(Import_Diff, Export_Diff)) %>%
  group_by(name) %>%
  slice_max(abs(value), n=5) %>%
  ungroup() %>%
  
  {data_for_martin <<- .} %>%
  
  #pivot wider was merging/deleting some rows. A unique ID stops this behavior
  mutate(
    ID = row_number(),
    #Massive numbers are arbitrary and just need to be big enough to show up 
    value3 = ifelse(name == "Export_Diff", 0, 3000000000),
    value4 = ifelse(name == "Import_Diff", 0, 3000000000)
  )%>%
  pivot_wider(names_from = name, values_from = value) %>%
  
  #We need individual, group, and value1-4 to make the copy/pasted code from
  #R Graph Gallery happy. value1 = surplus (green), value2 = deficit (red),
  #value3 = import (light purple), value4 = export (light blue). The renames, 
  #type changes, and pivoting are all just to make the data frame look the way
  #the RGG code wants. 
  mutate(
    value2 = coalesce(Export_Diff, Import_Diff),
    value1 = ifelse(value2 > 0, value2, 0),
    value2 = ifelse(value2 < 0, value2, 0),
    group = ifelse(is.na(Export_Diff), "Imports", "Exports")
  ) %>%
  dplyr::rename(individual = hs_product_code) %>%
  select(individual, group, value1, value2, value3, value4) %>%
  #Behold the elimination of gather and the use of pivot_longer! May it remain
  #the standard for 1000 years.
  pivot_longer(names_to = "observation", values_to="value", cols = -c(individual,group)) %>%
  transform(
    value = as.numeric(value),
    individual = as.character(individual)
  )
```

```{r data_for_martin_setup, echo=FALSE}
data_for_martin <- data_for_martin %>%
  mutate(
    ID = row_number(),
  )%>%
  pivot_wider(names_from = name, values_from = value) %>%
  
  #We need individual, group, and value1-4 to make the copy/pasted code from
  #R Graph Gallery happy. value1 = surplus (green), value2 = deficit (red),
  #value3 = import (light purple), value4 = export (light blue). The renames, 
  #type changes, and pivoting are all just to make the data frame look the way
  #the RGG code wants. 
  mutate(
    value2 = coalesce(Export_Diff, Import_Diff),
    value1 = ifelse(value2 > 0, value2, 0),
    value2 = ifelse(value2 < 0, value2, 0),
    group = ifelse(is.na(Export_Diff), "Imports", "Exports")
  ) %>%
  dplyr::rename(individual = hs_product_code) %>%
  select(individual, group, value1, value2) %>%
  #Behold the elimination of gather and the use of pivot_longer! May it remain
  #the standard for 1000 years.
  pivot_longer(names_to = "observation", values_to="value", cols = -c(individual,group)) %>%
  transform(
    value = as.numeric(value),
    individual = as.character(individual)
  )
```


```{r plot_setup, echo=FALSE}

#Create table for plot
  table <- HS_list[HS_list$code %in% unique(data_for_tim$individual),] %>%
    dplyr::rename(Code = code, Product = codename)
  
  plot_setup <- function(data) {
  #Gross solution copied from R Graph Gallery. Link below:
  #https://r-graph-gallery.com/299-circular-stacked-barplot.html
  
  # Set a number of 'empty bar' to add at the end of each group
  empty_bar <- 2
  nObsType <- nlevels(as.factor(data$observation))
  to_add <- data.frame( matrix(NA, empty_bar*nlevels(as.factor(data$group))*nObsType, ncol(data)) )
  colnames(to_add) <- colnames(data)
  to_add$group <- rep(levels(as.factor(data$group)), each=empty_bar*nObsType )
  data <- rbind(data, to_add)
  data <- data %>% arrange(group, individual)
  data$id <- rep( seq(1, nrow(data)/nObsType) , each=nObsType)
  
  #Dataframe for product labels
  label_data <- data %>% group_by(id, individual) %>% summarize(tot=sum(abs(value)))
  number_of_bar <- nrow(label_data)
  # I substract 0.5 because the letter must have the angle of the center of the bars.
  #Not extreme right(1) or extreme left (0)
  angle <- 90 - 360 * (label_data$id-0.5) /number_of_bar     
  label_data$hjust <- ifelse( angle < -90, 1, 0)
  label_data$angle <- ifelse(angle < -90, angle+180, angle)
  
  # Prepare a data frame for base lines. Not used unless code is uncommented in 
  #ggplot call
  base_data <- data %>% 
    group_by(group) %>% 
    summarize(start=min(id), end=max(id) - empty_bar) %>% 
    rowwise() %>% 
    mutate(title=mean(c(start, end)))
  
  # prepare a data frame for grid (scales)
  grid_data <- base_data
  grid_data$end <- grid_data$end[ c( nrow(grid_data), 1:nrow(grid_data)-1)] + 1
  grid_data$start <- grid_data$start - 1
  grid_data <- grid_data[-1,]
  
  #Add in second group of scale lines
  grid_data <- rbind(grid_data, list("Exports", 14, 13, 10))
  
  return(list(data, grid_data, label_data, base_data))
}
#Scale line positioning
point1 <- 1000000000
point2 <- 10000000000
point3 <- 20000000000
point4 <- 30000000000
```

```{r tim_request, echo=FALSE}
#Plot as per project request

data_list <- plot_setup(data_for_tim)
data_for_tim <- data_list[[1]]
grid_data <- data_list[[2]]
label_data <- data_list[[3]]
base_data <- data_list[[4]]

# Make the plot. 
p <- ggplot(data_for_tim) +      
  
  # Add the stacked bar. This isn't really a stack here. I've overlayed the
  #two bars with position = "identity" as the import/export label colors aren't
  #representative of any import/export numerical data
  geom_bar(aes(x=as.factor(id), y=abs(value), fill=observation), 
           stat="identity", position="identity") +
  scale_fill_manual("legend", breaks = c("value1","value2", "value3", "value4"), 
                    labels = c("Surplus", "Deficit", "Import", "Export"), 
                    values = c("green","red","#efe3fd","#add8e6")) +
  
  # Add scale lines
  geom_segment(data=grid_data, 
               aes(x = end, y = point1, xend = start, yend = point1), 
               colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, 
               aes(x = end, y = point2, xend = start, yend = point2), 
               colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, 
               aes(x = end, y = point3, xend = start, yend = point3), 
               colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, 
               aes(x = end, y = point4, xend = start, yend = point4), 
               colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +

  #Add text to scale lines
  ggplot2::annotate("text", x = rep(max(data_for_tim$id),4), 
                    y = c(point1, point2, point3, point4), 
                    label = c( "1Bn", "10Bn", "20Bn", "30Bn") , 
                    color="grey", size=3 , angle=25, fontface="bold", 
                    hjust=1, vjust=-1) +

  #The larger negative number you put for the min, the bigger the circle in the middle
  ylim(-10000000000,max(abs(label_data$tot), na.rm=T)+100) +
  
  #Title
  ggtitle("Import/Export Surplus/Deficit by Product Category for Germany, 2019-20") +
  
  #Theme
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.title = element_text(vjust = -8, hjust = .4, size = 20, face="bold"),
    plot.margin = margin(c(0, 0, 5, 0), unit="cm")
  ) +
  
  #Makes the plotting coords circular
  coord_polar() +
  
  # Add labels on top of each bar
  geom_text(data=label_data, aes(x=id, y=tot+10, label=individual, hjust=hjust),
            color="black", fontface="bold",alpha=0.6, size=5, 
            angle= label_data$angle, inherit.aes = FALSE ) +
  
  #Add in table for clarity.
  annotate(geom = "table", x = 10, y = 20000000000, label = list(table), 
           vjust = 3, hjust = 0.33, size = 2.7) 
  
ggsave(plot = p, "CSB.jpg", width = 30, height = 20, units = "cm")
```


```{r way_of_the_martin, echo=FALSE}
#Plot based on Martin's recommendations

data_list <- plot_setup(data_for_martin)
data_for_martin <- data_list[[1]]
grid_data <- data_list[[2]]
label_data <- data_list[[3]]
base_data <- data_list[[4]]

p2 <- ggplot(data_for_martin) +      
  
  #No more stacking just red/green for deficit/surplus
  geom_bar(aes(x=as.factor(id), y=abs(value), fill=observation), 
           stat="identity", position="identity") +
  
  scale_fill_manual("legend", breaks = c("value1","value2"), 
                    labels = c("Surplus", "Deficit"), 
                    values = c("lightgreen","tomato")) +
  
  # Add scale lines
  geom_segment(data=grid_data, 
               aes(x = end, y = point1, xend = start, yend = point1), 
               colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, 
               aes(x = end, y = point2, xend = start, yend = point2), 
               colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, 
               aes(x = end, y = point3, xend = start, yend = point3), 
               colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, 
               aes(x = end, y = point4, xend = start, yend = point4), 
               colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  
  #Add text to scale lines
  ggplot2::annotate("text", x = rep(max(data_for_martin$id),4), 
                    y = c(point1, point2, point3, point4), 
                    label = c( "1Bn", "10Bn", "20Bn", "30Bn") , 
                    color="grey", size=3 , angle=25, fontface="bold", 
                    hjust=1, vjust=-1) +
  
  #The larger negative number you put for the min, the bigger the circle in the middle
  ylim(-12000000000,max(abs(label_data$tot), na.rm=T)+10000000000) +
  
  #Title
  ggtitle("Import/Export Surplus/Deficit by Product Category for Germany, 2019-20") +
  
  #Theme
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.title = element_text(vjust = -8, 
                              hjust = .4, 
                              size = 20, 
                              face="bold"),
    plot.margin = margin(c(0, 0, 5, 0), unit="cm")
  ) +
  
  #Makes the plotting coords circular
  coord_polar() +
  
  # Add labels on top of each bar
  geom_text(data=label_data, 
            aes(x=id, y=tot+10, label=paste0("Code: ",individual), hjust=hjust),
            color="black", fontface="bold",alpha=0.6, size=4, 
            angle= label_data$angle, inherit.aes = FALSE ) +
  
  #Add absolute value numbers in white to each surplus/deficit
  geom_text(data=label_data, 
            aes(x=id,y=800000000,
                label=as.character(ifelse(tot!=0,format(round(tot/1000000000, 2), 
                                                        nsmall = 2), "")), 
                hjust=hjust),
            color="whi", fontface="bold", size=2, 
            angle= label_data$angle, inherit.aes = FALSE ) +
  
  #Add in table for clarity.
  annotate(geom = "table", 
           x = 10, 
           y = 20000000000, 
           label = list(table), 
           vjust = 3, 
           hjust = 0.33, 
           size = 2.7) +

  #Add Import/Export labels and black lines
  geom_segment(data=base_data, 
               aes(x = start, 
                   y = -5, 
                   xend = end, 
                   yend = -5),
               colour = "black", 
               alpha=0.6, 
               size=1, 
               inherit.aes = FALSE )  +
  
  geom_text(data=base_data, 
            aes(x = title, 
                y = -5000000000, 
                label=group),
            colour = "black", 
            alpha=0.6, 
            size=2.5, 
            fontface="bold", 
            inherit.aes = FALSE)

ggsave(plot = p2, "CSB_WayOfTheMartin.jpg", width = 30, height = 20, units = "cm")
```
## Original Project Description
![](CSB.jpg)

## Suggested Edits from Martin
![](CSB_WayOfTheMartin.jpg)


