---
title: "solution_by_hiuyan"
output: md_document
date: "2025-03-31"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Dataset Manipulation 

- TBC: is federation equal to country?
- TBC: confirm the age bins are correctly set up
- TBC: if I removed too much columns?

```{r}
library(tidyverse)
file <- "standard_rating_list.txt"

df <- read_fwf(file=file, 
               fwf_empty(file, 
                        col_names=c("ID", "Name", "Fed", "Sex", "Tit", "WTit", "OTit", "FOA", "APR25", "Gms", "K", "Birthday", "Flag")),
                        skip=1)
df <- df %>%
  drop_na(Birthday, APR25) %>% # remove rows without birthday or rating
  # filter out rows with invalid birthday year
  filter(Birthday > 1900) %>%
  # remove irrelevant columns
  mutate(Tit=NULL,
         WTit=NULL,
         OTit=NULL,
         Gms=NULL,
         FOA=NULL,
         # using cut already create factor-typed column
         bin = cut(2024-Birthday, breaks=c(1,16,25,35,46,Inf), labels=c("below 16", "16-24", "25-34", "35-45", "above 45"))
         ) %>%
  filter(!is.na(bin)) 

by_country_by_age <- group_by(df, Fed, bin) %>%
  summarise(mean_rating=mean(APR25, na.rm=TRUE), .groups="drop") %>%
  pivot_wider(names_from=bin, values_from=mean_rating) %>%
  select("Fed", "below 16", "16-24", "25-34", "35-45", "above 45") 

by_country <- group_by(df, Fed) %>%
  summarise(mean_rating=mean(APR25, na.rm=TRUE)) 

final_df <- left_join(by_country, by_country_by_age, by="Fed") %>%
  arrange(desc(mean_rating))

knitr::kable(final_df, format = "pipe", caption="table sorted by average rating of each federation")
```

## Data Visualisation

- Ridgeline Plots

```{r}
library(ggridges)
df_top10 <- df %>%
  filter(Fed %in% c("NON", "CUB", "BIH", "MYA","FIN","SRB", "KOS", "NED", "UKR", "GER")) %>%
  print()

ggplot(df_top10, aes(x = APR25, y = Fed, fill = bin)) +
  # scale for scaling the graph (the smaller the value the lower the graph is suppressed)
  # alpha for transparency
  geom_density_ridges(alpha = 0.5, scale = 8, rel_min_height = 0.01) +
  facet_wrap(~ Fed) +
  labs(title = "Rating Distributions of each Top-10 Federation (by age group)",
       x = "APR25 rating",
       y = "Federation",
       fill = "age category") 
```

- Heatmap
```{r}
df_heatmap <- by_country_by_age %>%
  filter(Fed %in% c("NON", "CUB", "BIH", "MYA","FIN","SRB", "KOS", "NED", "UKR", "GER")) %>%
  print()

matrix_heatmap <- as.matrix(df_heatmap[,-1]) # remove "Fed" column in the matrix
rownames(matrix_heatmap) <- df_heatmap$Fed # extract Fed as list of rownames for the matrix

heatmap(matrix_heatmap, 
        scale = "row",          
        col = heat.colors(10),  # heatmap color scheme
        margins = c(6, 10),
        main = "mean-rating-colored table by federation and age categories")

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
