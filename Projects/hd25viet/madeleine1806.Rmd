---
title: "madeleine1806"
author: "Madeleine"
date: "`r Sys.Date()`"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r packages, echo=FALSE}
options(warn = -1)  # Suppress warnings globally for the current session
suppressPackageStartupMessages({
  library(tidyverse)
  library(ggridges)
  library(viridis)
})
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

```
# Creating an RMarkdown table where: 
- Rows represent federations. 
- Columns represent age groups. 
- An additional column shows the overall mean rating for each federation. 
- The table is sorted by federation or by overall mean rating
```{r preparation, echo = FALSE}
file <- "standard_rating_list.txt"
data <- read_fwf(file = file, 
                         fwf_empty(file, 
                                   col_names = c("ID", "Name", "Fed", "Sex", "Tit", "WTit", 
                                                 "OTit", "FOA", "APR25", "Gms", "K", "Birthday", "Flag")),
                         skip = 1,
                         show_col_types = FALSE) %>%
  # Keep only Name, Fed, APR25, and Birthday columns
  select(Name, Fed, APR25, Birthday) %>%
  # Remove rows with missing Birthday or ratings (APR25)
  drop_na(Birthday, APR25) %>%
  # Calculate age based on the current year and the Birthday column
  mutate(Age = 2025 - Birthday) %>%
  # Create age categories
  mutate(AgeCategory = case_when(
    Age < 16 ~ "Under 16",
    Age >= 16 & Age < 24 ~ "16–24",
    Age >= 24 & Age < 34 ~ "24–34",
    Age >= 34 & Age < 45 ~ "35–45",
    Age >= 45 ~ "45+"
  )) %>%
  # Convert AgeCategory to a factor
  mutate(AgeCategory = factor(AgeCategory, levels = c("Under 16", "16–24", "24–34", "35–45", "45+")))

# Compute mean ratings by Federation and AgeCategory, and calculate overall mean
data_pivoted <- data %>%
  group_by(Fed, AgeCategory) %>%
  summarize(mean_APR25 = mean(APR25, na.rm = TRUE), .groups = "drop") %>%
  group_by(Fed) %>%
  summarize(overall_mean = mean(mean_APR25, na.rm = TRUE), .groups = "drop") %>%
  left_join(
    data %>%
      group_by(Fed, AgeCategory) %>%
      summarize(mean_APR25 = mean(APR25, na.rm = TRUE), .groups = "drop") %>%
      pivot_wider(names_from = AgeCategory, values_from = mean_APR25),
    by = "Fed"
  ) %>%
  slice_max(order_by = overall_mean, n = 10) %>% # Top 10 federations
  drop_na()

# Display the table
knitr::kable(data_pivoted, format = "pipe")
```
# Ridgeline Plots
- x-axis represents ratings 
- y-axis represents different federations
- One plot per federation, showing how different age groups compare within a country

```{r ridgeline plot, echo=FALSE, fig.show="hold", message=FALSE}

data %>%
  filter(Fed %in% data_pivoted$Fed & Fed != "NON") %>%
  left_join(data_pivoted %>% select(Fed, overall_mean), by = "Fed") %>%
  ggplot(aes(x = APR25, y = Fed, fill = after_stat(x))) + # Use after_stat to fill based on x
  geom_density_ridges_gradient(scale = 1.5, rel_min_height = 0.01) +
  facet_wrap(~ AgeCategory, scales = "free_y", ncol = 5) +
  scale_fill_viridis(name = "Ratings Gradient", option = "C", direction = -1) +  # Adjust legend name
  scale_x_continuous(breaks = scales::pretty_breaks(n = 6), labels = scales::label_number()) +
  theme_minimal() +
  labs(
    title = "Ridgeline plot of ratings by federation and age group (top 10 federations)",
    x = "Ratings",
    y = "Federation"
  ) +
  theme(
    legend.position = "right",
    strip.text = element_text(size = 10),
    axis.text.y = element_text(size = 8),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
  
```

# Heatmap

- as mean-rating-colored table
- y-axis represents federations
- x-axis represents age groups
- color intensity represents the mean rating for that age group in that federation

```{r heatmap plot, echo=FALSE, fig.show="hold"}

# Extract the same top 10 federations from the table and filter the mean APR25 ratings for the top federations
filtered_ratings <- data %>%
  filter(Fed %in% data_pivoted$Fed) %>%  # Filter for federations in top 10 list
  group_by(Fed, AgeCategory) %>%  # Group by Federation and Age Category
  summarize(mean_APR25 = mean(APR25, na.rm = TRUE), .groups = "drop") %>%  # Calculate mean APR25 per group
  drop_na(mean_APR25)  # Drop NAs 

# Create the heatmap with viridis color scale
filtered_ratings %>%
  ggplot(aes(x = AgeCategory, y = reorder(Fed, -mean_APR25), fill = mean_APR25)) +
  geom_tile() +  # Use geom_tile to create heatmap
  scale_fill_viridis_c(name = "Mean Rating", option = "C", direction = -1) +  # Color scale
  theme_classic() +  # Apply classic theme
  labs(
    title = "Heatmap of mean ratings by federation and age group",
    x = "Age category",
    y = "Federation"
  ) + 
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)  # Rotate x-axis labels
  )
``` 