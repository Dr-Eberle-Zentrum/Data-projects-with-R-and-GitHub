---
title: "Cell viability"
author: "Daniel Barrera"
date: "2023-06-15"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## ToC

Part I. Preliminaries and assumptions

1. The data
- Loading data and libraries 
- Getting to know the data
  - Correlation in a dying cell
- Dying vs viable comparison

2. The goal 
- Priorities

Part II. The Project 

1. Working on the data as it is 
2. Exploring individual cells 
3. Death or alive: labeling cells 
4. Plotting cell viability 

-------------

## Part I. Preliminaries and assumptions

### 1. The data

#### Loading data and libraries
``` {r, include=FALSE, echo=FALSE}
{
library(tidyverse) 
library(ggplot2)
library(dplyr)
library(hexbin)
library(corrplot)

# --- Observations ---
# Individual cells
dying_cell <- read_csv("Track_one_dying_cell.csv", show_col_types = FALSE)
viable_cell <- read_csv("Track_one_viable_cell.csv", show_col_types = FALSE)

# Group of cells
# Treated cells
df_treat <- read_csv("Tracks_Treated_Cells.csv", show_col_types = FALSE)
# Control group
df_untreat <- read_csv("Tracks_Untreated_Cells.csv", show_col_types = FALSE)
}
```

We have four data frames with the following structures:

- `dying_cell` = Time points observations of a **dying cell's** *intensity* (fluorescence luminosity) and *area* (size). *x* and *y* data don`t really help for analyzing treatment efficacy-only the cell's position in the frame.

- `viable_cell` = Time points observations of a **viable cell's** *intensity* (fluorescence luminosity) and *area* (size). *x* and *y* data don`t really help for analyzing treatment efficacy-only the cell's position in the frame.

- `df_treat` = A data frame containing **multiple cells that received a treatment** and their **time points observations**. *intensity* and *area* are the same as in the individual cell data frames. *x* and *y* had been removed.

- `df_untreat` = A data frame containing **multiple cells from the control group** (cells that DON'T received treatment) and their time points observations. *intensity* and *area* are the same as in the individual cell data frames. *x* and *y* had been removed.

 Next, I'll show their head (three rows). 
 
 
```{r, echo=FALSE}
head(viable_cell, n=3)
``` 




```{r, echo=FALSE}
head(viable_cell, n=3)
```

```{r, echo=TRUE}
head(dying_cell, n=3)
```

```{r, echo=TRUE}
head(df_treat, n=3)
```

```{r, echo=TRUE}
head(df_untreat, n=3)
```
### Getting to know the data 

Each column in a data frame are of the same length but the data frames don't have the same length. The good news is we don't have any NA values.

```{r, echo=TRUE}
{
lengths <- c(length(dying_cell$Cell.ID),length(viable_cell$Cell.ID),length(df_treat$Cell.ID),length(df_untreat$Cell.ID) )
any_NA <- c(any(is.na(dying_cell)), any(is.na(viable_cell)),any(is.na(df_treat)),any(is.na(df_untreat)) )
all_dfs <- data.frame(lengths, any_NA)
rownames(all_dfs) <- c("dying_cell", "viable_cell", "df_treat", "df_untreat")
print(all_dfs)
}
```

The data is asymmetric. Even though the time intervals are regular (equidistant), the number of observations for each cell is not uniform. That is why the data is not evenly shaped or the observations consistent. I think it is due to the method the observations are measured. This hinder my progress a number of times but found ways around it.

**NOTE on Time**: time points can be deceptive, as we can see later.Because not all cell have the same time length it is difficult to determine the duration of the experiment. Nonehteless, here are my assumtions:

- Each time point correspond to two minutes
- The longest observation is *Cell 0*, around 2774 time points or 5,400 minutes (90 hours)
- The shortest 

The first thing I wanted to understand was the correlation between variables. 

### Correlation in a dying cell

The dying cell data had a `y`column tracking its position but I removed because it didn't showed useful information to study the correlation between its variables. 

Accordingly to the following correlation matrix:

- Time and size (area) are the best correlated variables, a negative correlation with an index of **-0.81**. time and intensity show also a strong correlation (**-0.69**).

```{r, echo=TRUE}
{
# Correlation
colnames(dying_cell)
dying_corr <- dying_cell[-1]
colnames(dying_corr)
corrplot(cor(dying_corr), method = "number")
}
```

The following plots explore correlation between variables of a dying cell.

Line plots show a "clear" negative correlation between **time and area** and **time and intensity**. 

```{r, echo=FALSE}
{
plot(dying_corr$Time.point,dying_corr$Area,type="l",col="darkorange",
     xlab='Time', ylab='Area')
plot
plot(dying_corr$Time.point,dying_corr$Intensity,type="l",col="darkblue",
     xlab='Time', ylab='Intensity')
plot
}
```

Here are the plots overlapping. Note that the data is scaled so the plots have the same proportion. 


```{r, echo=FALSE}
{
dying_scale <- scale(dying_corr)
colnames(dying_scale)
dy_time <- c(dying_scale[,3])
dy_area <- c(dying_scale[,4])
dy_lumen <- c(dying_scale[,5])
plot(dy_time,dy_area,type="l",col="darkorange",
     main ="Proportional correlation: Time/Area - Time/Intensity", 
     sub = "[Area = dark orange] - [Intensity = dark blue]",
     xlab="Time", ylab='Area & Intensity')+
lines(dy_time,dy_lumen,col="darkblue")+
abline(h=0, v=0, col="lightblue")
abline(v=-1.3, col="lightblue")
abline(v=-0.94, col="lightblue")
abline(v=0.47, col="lightblue")
abline(v=0.95, col="lightblue")
abline(v=-0.87, col="lightblue")
plot
}
```

We can observe a general downward trend for intensity and area with intervals in which move in opposite directions, like mirroring their their trend in an opposite direction. This is shown by the vertical light blue lines. 

**CAUTION #1** I made this comment knowing next to nothing about cell physiology. I think *Intensity* is a confounding factor here. It is reacting to size decrease. If a cell's size decrease maybe the fluorescence concentrates and shows with more intensity. 

Line plots can be misleading because they trace all observations with the same "weight," which makes harder to probe the real correlation in graphs. So I'll make an hexabin to count observations and see the real distribution of variables correlated to time.


```{r, echo=FALSE}
{
graph <- ggplot(dying_cell, (aes(x=Time.point, y=Area))) + 
  stat_binhex(color='white') + 
  theme_bw() + 
  scale_fill_gradient(low='white', high='darkorange') +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  labs(x='Time', y='Area')+
  geom_vline(xintercept = 1250, color="lightblue", show.legend="ghost after this lilne")
graph
}
{
graph <- ggplot(dying_cell, (aes(x=Time.point, y=Intensity))) + 
  stat_binhex(color='white') + 
  theme_bw() + 
  scale_fill_gradient(low='white', high='darkblue') +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  labs(x='Time', y='Intensity')+
    geom_vline(xintercept = 1250, color="lightblue", show.legend="ghost after this lilne")
graph
}
```

We do find some positive correlation between *area and intensity* (**0.29**) but with not as significant. The horizontal blue line represents the 40 percentile of size. Below means cells will die or are dying. 

```{r, echo=FALSE}
{
graph <- ggplot(dying_corr, (aes(x=Intensity, y=Area))) + 
  stat_binhex(color='white') + 
  theme_bw() + 
  scale_fill_gradient(low='white', high='darkgreen') +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  labs(x='Intensity', y='Area')+
  geom_hline(yintercept = 740, color="lightblue", show.legend="The blue line represents the 40 percentile")
graph
}
{
plot(dying_corr$Intensity, dying_corr$Area, 
    xlab='Intensity', ylab='Area', col="darkgreen") +
    dim(dying_corr)+
    abline(h=740, col="red")
plot
}

```

### Dying vs viable comparison

For the last exploratory plot, let's explore a *dying and a viable cell* with a line plot of the correlation between 
time and area and time and intensity.

**NOTE:** I standardized and make the data frames of the same length.

```{r, echo=FALSE}
{
# Add plots with overlapping 
# area-intensity of viable-dying cells
  
# scaling and standardizing dfs
viable_scaled <- scale(viable_cell)
dying_scaled <- dying_scale
colnames(dying_scaled)
colnames(viable_scaled)
time_x <- dying_scaled[1:1605,3]
dying_intensity <- dying_scaled[1:1605,4]
dying_area <- dying_scaled[1:1605,5]
viable_intensity <- viable_scaled[1:1605,5]
viable_area <- viable_scaled[1:1605,6]

length(time_x)
length(dying_intensity)
length(dying_area)
length(viable_intensity)
length(viable_area)

# Finding size 40 percentile

per_40_dying <- ((max(dying_area) + min(dying_area))*0.40) + min(dying_area)
per_40_viable <- ((max(viable_area) + min(viable_area))*0.40) + min(viable_area)
{
plot(time_x,dying_intensity,type="l",col="purple",
    main ="Overlapping Viable & Dying cells for Time/Intensity correlation", 
     sub = "[Dying = purple] - [Viable = green]",
    xlab='Time', ylab='Intensity')+
  lines(time_x,viable_intensity,col="lightgreen")+
  abline(h=-0, v=0, col="red")
plot
}
plot(time_x,dying_area,type="l",col="purple",
     main ="Overlapping Viable & Dying cells for Time/Area correlation", 
     sub = "[Dying = purple] - [Viable = green]",
     xlab='Time', ylab='Area')+
  lines(time_x,viable_area,col="lightgreen")+
  abline(h = per_40_dying, col="purple")
plot  
}
```

Following Julia's recommendation and accordingly to what is shown in the plots above, **size (area) is a good indicator of a cell's point of death**. The recommended threshold is 40% size decrease. So, all cells under the 40 percentile relative to their own saize will die. This metric is shown by the purple line in the plot above. The dying cell crossed the 40 percentile threshold, then spikes up to consistently decrease in size (die). The green line section under the purple 40 percentile makes sense because the purple line is relative to the dying cell and all cells have different sizes. The green line never decreases under 40% of its size.

Now it's time to tackle the goal.

## The Goal

As Julia requested here are the:

###Priorities (from high to low)

- Identify dying tumor cells in the data sets and estimate the point of death. One suggestion for the criteria would be:
  - Observe whether the cell size dropped by 40% or more compared to the inital cell size.
  - Observe whether the fluorescence intensity shows a linear downward trend.
- Count dying tumor cells and compute the relative number of cell deaths.
- Plot the cell survival for both cell populations in one plot. In our case, we opt for two colored lines representing the treated cell population and the untreated cell population.

### Clustering

**Machine learning to the rescue:** I will use a K-Means algorithms to cluster the data into to groups, hopefully, those clusters correspond to the death and alive cells respectively.

*K-Means works by dividing the data into groups (unclassified data). It assigns means (as many as needed-in this case two) and the organize the data by the sum of the minimal squared distance to the mean-cluster.*



```{r, echo=FALSE}
{
# for resetting while modeling
df_treat <- read_csv("Tracks_Treated_Cells.csv", show_col_types = FALSE)
# scaling
scale_treat <- scale(df_treat)
# modeling
km <- kmeans(df_treat, centers=2, nstart=1)
# Assigning clusters
df_treat$cluster <- factor(km$cluster)
centers <- data.frame(cluster=factor(1:2), km$centers)
head(df_treat, n=3)
}
```


```{r, echo=FALSE}
{
graph <- ggplot(data=df_treat, aes(x=Time.point, y=Area, color=cluster, shape=cluster)) +
  geom_point() +
  scale_shape_manual(values = c(1, 2),
                     guide = guide_legend(override.aes=aes(size=1))) + 
  geom_point(data=centers,  aes(x=Time.point, y=Area), size=2, stroke=2, color='black')  +
  theme_bw() +
  scale_x_continuous(expand=c(0,0)) + 
  scale_y_continuous(expand=c(0,0)) +
  coord_cartesian(xlim=c(-10, 2800), ylim=c(-10, 1000))
graph
}
```

Area-Time make for messy clusters.

```{r, echo=FALSE}
{
graph <- ggplot(data=df_treat, aes(x=Cell.ID, y=Area, color=cluster, shape=cluster)) +
  geom_point() +
  scale_shape_manual(values = c(1, 2),
                     guide = guide_legend(override.aes=aes(size=1))) + 
  geom_point(data=centers,  aes(x=Cell.ID, y=Area), size=2, stroke=2, color='black')  +
  theme_bw() +
  scale_x_continuous(expand=c(0,0)) + 
  scale_y_continuous(expand=c(0,0)) +
  coord_cartesian(xlim=c(-10, 500), ylim=c(-10, 1000))
graph
}
```

Area-Cell.ID have also mixed values whithin their clusters.

```{r, echo=FALSE}

{
graph <- ggplot(data=df_treat, aes(x=Cell.ID, y=Time.point, color=cluster, shape=cluster)) +
  geom_point() +
  scale_shape_manual(values = c(1, 2),
                     guide = guide_legend(override.aes=aes(size=1))) + 
  geom_point(data=centers,  aes(x=Cell.ID, y=Time.point), size=2, stroke=2, color='black')  +
  theme_bw() +
  scale_x_continuous(expand=c(0,0)) + 
  scale_y_continuous(expand=c(0,0)) +
  coord_cartesian(xlim=c(-10, 500), ylim=c(-10, 3000))
graph
}

```

Time - Cell.ID clusters are jumbled together as well.

```{r, echo=FALSE}
{
graph <- ggplot(data=df_treat, aes(x=Cell.ID, y=Intensity, color=cluster, shape=cluster)) +
  geom_point() +
  scale_shape_manual(values = c(1, 2),
                     guide = guide_legend(override.aes=aes(size=1))) + 
  geom_point(data=centers,  aes(x=Cell.ID, y=Intensity), size=2, stroke=2, color='black')  +
  theme_bw() +
  scale_x_continuous(expand=c(0,0)) + 
  scale_y_continuous(expand=c(0,0)) +
  coord_cartesian(xlim=c(-10, 500), ylim=c(6000, 30000))
graph
}
```

With Intensity - Cell.ID we begin to see a pattern.

```{r, echo=FALSE}
{
graph <- ggplot(data=df_treat, aes(x=Time.point, y=Intensity, color=cluster, shape=cluster)) +
  geom_point() +
  scale_shape_manual(values = c(1, 2),
                     guide = guide_legend(override.aes=aes(size=1))) + 
  geom_point(data=centers,  aes(x=Time.point, y=Intensity), size=2, stroke=2, color='black')  +
  theme_bw() +
  scale_x_continuous(expand=c(0,0)) + 
  scale_y_continuous(expand=c(0,0)) +
  coord_cartesian(xlim=c(-10,2850), ylim=c(4500,30000))
graph
}
```

And the pattern is defined when we plot Intensity against Time. So the K-means algorithm is setting a threshold around 12000 intensity but not taking into account the other variables.

Studying the centers of the clusters' mean give more information. And show intensity as the defining factor.

```{r, echo=FALSE}
{
centers <- data.frame(cluster=factor(1:2), km$centers)
centers
}

```

The labels are not precise enough nor consistent because of the data organization. 

Before exploring with clustering further, I decided to follow the hard 40% size decrease threshold.

#### Goal 1

So here it is a data frame fulfilling the first goal, 

```{r, echo=FALSE}
{
#----------- New Column ---------
# ----- "Viable" / "Dying" ------

# Determine max size for each cell
# Select each unique value from Cell-ID column

# Find max size for each in Area column
{
max_size <- df_treat %>%
  arrange(desc(Area)) %>%
  distinct(Cell.ID, .keep_all = TRUE) %>%
  group_by(Cell.ID) %>%
  summarise(Area = max(Area))
View(max_size)
lengths(max_size)
max_a <- max_size$Area
}

# Find min size for each in Area column
{
min_size <- df_treat %>%
  arrange(Area) %>%
  distinct(Cell.ID, .keep_all = TRUE) %>%
  group_by(Cell.ID) %>%
  summarise(Area = min(Area))
View(min_size)
lengths(min_size)
min_a <- min_size$Area
}

#-------------------------
# Set 40% threshold for each cell
# point at which each cell will die

{
die <- c()
for (i in max_a) {
  die <- c(die,(i * .40))
}
#die
length(die)
}


#>---------------------
#>-----  New df  ------
#> Adding four columns: 
#> Max size | Min size | PoD | Dying/Viable
#> 
ndf <- cbind(max_size, min_a, die)

# Add Dying/Viable label to each cell
{
ndf$Dying_OR_viable = ifelse(ndf$min_a < ndf$die, 'Dying',
                      ifelse(ndf$min_a > ndf$die, 'Viable', '?'))

}

#>-------------------------
#>-----  Final label ------
#>-----  to original ------
#>------ data frame  ------
#>-------------------------

viable <- ndf$Cell.ID[ndf$Dying_OR_viable=="Viable"]
dying <- ndf$Cell.ID[ndf$Dying_OR_viable=="Dying"]
head(ndf, n=10)
}
```

#### Goal 2
Count dying tumor cells and compute the relative number of cell deaths.

```{r, echo=FALSE}

{
Count <- c(length(viable),length(dying))
Relat_num <- c((length(viable))/1.41,(length(dying))/1.41)
Goal2 <- data.frame(Count, Relat_num)
rownames(Goal2) <- c("Viable", "Dying")
print(Goal2)
}

```

The next plot represents the relative frequency of death and viable cells according to area. It shows that bigger cells respond to treatment more than smaller cells, thus, the smaller cells tend to stay alive.

```{r, echo=FALSE}

{
freq <- ggplot(ndf, aes(Area, fill = Dying_OR_viable)) +
  geom_histogram(aes(y = after_stat(density * width)),

                                  position = "identity", alpha = 0.5)
freq
}

```



```{r, echo=FALSE}



```




```{r, echo=FALSE}



```