---
title: "Soccer Processing"
author: "Daniela Kemp"
date: "2023-05-24"

output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("readr")
#install.packages("stringr")
#install.packages("lubridate")
#install.packages("ggsoccer")
#install.packages("ggforce")
```

## Soccer-Project

### Data Cleaning

```{r cars}
#library(readr)
#soccer_referee_data <- read_csv("Projects/alexanderwinterstetter/soccer_referee_data.csv")
soccer_referee_data <- read_csv("C:/users/danie/Documents/Aktuelles/R_Kurs/R_Kurs_Git/Projects/alexanderwinterstetter/soccer_referee_data.csv")
View(soccer_referee_data)
```

Create a new table with just the personal info of the players:

```{r}
unique_players<-unique(soccer_referee_data$playerShort)
unique_players_df <- data.frame(matrix(ncol = 28, nrow =0 ))
colnames(unique_players_df)<-colnames(soccer_referee_data)
for (player in unique_players){
  unique_player<-soccer_referee_data[which(soccer_referee_data$playerShort==player),][1,]
  unique_players_df<-rbind(unique_players_df,unique_player)
}

```

-   Create a new variable, which contains information on whether the player is "Goalkeeper", "Defense", "Midfielder" or "Offense" (4 possible values the variables can take on)

```{r}
library("stringr")

#included to remove mistakes in classification due to whitespaces
unique_players_df$position<-str_squish(unique_players_df$position)


unique_players_df$pos<-ifelse(is.na(unique_players_df$position),NA, 
                               ifelse(unique_players_df$position %in% c("Attacking Midfielder","Right Midfielder","Defensive Midfielder","Left Midfielder"), "Midfielder", 
                                      ifelse(unique_players_df$position %in% c("Right Winger","Center Forward","Left Winger"), "Offense", 
                                             ifelse(unique_players_df$position %in% c("Goalkeeper"),"Goalkeeper", "Defense"))))



```

# Create a new column with the age of the players

```{r}
library("lubridate")
unique_players_df$birthday<-gsub("[[:punct:]]","-",unique_players_df$birthday) %>% dmy()

unique_players_df$age<-0
for (i in 1:dim(unique_players_df)[1]){
  unique_players_df$age[i]<-seq(from=as.Date(unique_players_df$birthday[i]), to=as.Date("2012/12/31"),by="year") %>% length()
}

```

Change the unique_players_df to only contain data that remains the same for all games. To also include some data regarding the outcome of games, aggregate over Red and Yellow Cards, as well as Losses, Ties and Wins. I will use ratios for this, to be able to better compare the values between players.

```{r}
unchanged_cols<-c("playerShort","player","club","leagueCountry","birthday","height","weight","position","photoID", "pos", "age")
#"games",   
aggregate_col_names<-c("victories","ties","defeats","goals","yellowCards","yellowReds","redCards" )

aggregate_cols<-aggregate(cbind(games,victories,ties,defeats,goals,yellowCards,yellowReds,redCards)  ~ playerShort, data = soccer_referee_data, sum)

aggregate_cols[aggregate_col_names]<-aggregate_cols[aggregate_col_names]/aggregate_cols$games

unique_players_df<-merge(unique_players_df[unchanged_cols],aggregate_cols, by.x="playerShort",by.y = "playerShort")

```

-   calculate a variable "points" per club: each win means 3 points, draw 1 point, lose 0 points (I will have to further look into it whether it is possible - it may be rather tricky)

*This is impossible, there is no way to get to the number of games in a league from this data. The Bundeliga does have \~34 games for each club (but there are other countries teams here too!), but a some players meet over 60 referees in this time period, which is probably not all from league game play, but also friendly or national matches, making it impossible to find the number of points for each club.*

```{r pressure, echo=FALSE}
tail(unique_players_df[order(unique_players_df$victories),],n=15)
tail(unique_players_df[order(unique_players_df$goals),],n=15)
tail(unique_players_df[order(unique_players_df$redCards),],n=15)
tail(unique_players_df[order(unique_players_df$yellowCards),],n=15)
tail(unique_players_df[order(unique_players_df$yellowReds),],n=15)
```

### Data Visualization

\- visualize per league how many points a club gets

*This is impossible given the provided data, as we don't have the data to know which games are in the league*

\- visualize a distribution of the age of the players per league (maybe with facet\\\_grid from ggplot2)\#

```{r}
library("plotly")

level_order<-c("Goalkeeper","Defense","Midfielder","Offense")


plot<-ggplot(data=unique_players_df[complete.cases(unique_players_df),] )+
  theme_classic()+
  geom_point(x=30,y=2.5, color="white",size=3)+
  geom_point(x=30,y=2.5, color="white",shape=1,size=30, fill="springgreen4", stroke=3)+
    geom_violin(aes(x=age,alpha=0.6, y=factor(pos, levels = level_order), col=pos, fill=pos))+

  theme(panel.background = element_rect(fill = "springgreen4"),
        panel.border = element_rect(colour = "white", fill=NA, size=5),
        legend.position="none")+
  geom_hline(yintercept=2.5, color = "white", size=1.5)+
  coord_fixed(ratio=10,xlim=c(15,45))+
  labs(title="Soccer player age vs. position",x="Player age (in 2012)", y="Player position")
plot  
```

```{r echo=FALSE}

ggplot(data=unique_players_df, aes(x=age, y=leagueCountry))+theme_classic()+geom_violin(aes(fill=leagueCountry))+labs(title="Age of players vs league county",y ="")
ggplot(data=unique_players_df, aes(x=age, y=leagueCountry))+theme_classic()+geom_violin(aes(fill=leagueCountry))

```

\- visualize the ratio in the league: redcards // yellow cards

Preprocessing, define a column ratio of Red/Yellow for all players where not yellow and red =0, here I'd default to 0.

```{r}
unique_players_df$ratioRedYellow<-ifelse(unique_players_df$redCards==0|                                    unique_players_df$yellowCards==0, 
                                         yes = 0, 
                                         no =                        unique_players_df$redCards/unique_players_df$yellowCards
                                           )

limits<-boxplot.stats(unique_players_df$ratioRedYellow)$stats[c(1, 5)]
```

Plotting it

```{r}
unique_players_df$ratioRedYellow<-ifelse(unique_players_df$redCards==0|
                                           unique_players_df$yellowCards==0, 
                                         yes = 0, 
                                         no =                          unique_players_df$redCards/unique_players_df$yellowCards)

limits<-boxplot.stats(unique_players_df$ratioRedYellow)$stats[c(1, 5)]

ggplot(data=unique_players_df, aes(x=ratioRedYellow, y=leagueCountry))+
  theme_classic()+
  theme(legend.position="none")+
  geom_boxplot(aes(color=leagueCountry))+
  coord_cartesian(xlim = limits*1.3)+
  coord_cartesian(xlim = limits*1.05)+
  labs(title="Ratio of red to yellow cards for different countries", x= "Red cards/yellow cards",y="")+
  annotate("text",
           y = 1:length(table(unique_players_df$leagueCountry)),
           x = limits[ 2],
           label = paste(table(unique_players_df$leagueCountry), "players"),
           vjust= -0.8)+

  annotate("text",
           y = 1:length(table(unique_players_df$leagueCountry)),
           x = aggregate(ratioRedYellow~leagueCountry,unique_players_df,median)[,2],
           label = signif(aggregate(ratioRedYellow~leagueCountry,unique_players_df,median)[,2],digits=3),
           hjust = -0.1,
           vjust = -0.8)

```
