---
title: "Windkraftausbau in Baden-Württemberg"
author: "Dario Demenus"
date: "`r Sys.Date()`"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
# Arbeitsverzeichnis setzen:
# knitr setzt das Arbeitsverzeichnis standardmäßig auf den Speicherort der .Rmd Datei.
# Falls nötig, kann es hier explizit gesetzt werden:
# knitr::opts_knit$set(root.dir = getwd())

library(tidyverse)
library(lubridate)
library(ggcorrplot) 
library(viridis)
library(knitr)      # Für schönere Tabellen (kable)
library(sf)         # Für Geodaten
library(giscoR)     # Für amtliche Grenzen
```



Datenimport und Bereinigung
Ziel: Vorbereitung einer sauberen Datenbasis für die Analyse.

Zunächst wurde der Datensatz WindenergieBW.csv importiert. Um die Datenverarbeitung zu erleichtern, wurden die Spaltennamen vereinfacht (z. B. Umbenennung von 'Generatorleistung [MW]' zu 'Leistung_MW'). Ein wesentlicher Schritt war die Umwandlung des Inbetriebnahmedatums von einem Textformat in ein Datumsformat, um daraus das Baujahr ('Jahr') zu extrahieren. Zudem wurden Datensätze ohne gültige Geokoordinaten (Ost/Nord) herausgefiltert, um eine fehlerfreie kartografische Darstellung zu gewährleisten.




```{r data-import-cleaning}
# Import using readr. 
# The locale encoding argument helps ensure special characters are read correctly.
wind_data <- read_delim("WindenergieBW.csv", 
                        delim = ",", 
                        locale = locale(encoding = "UTF-8"))

# Inspect column names to ensure no BOM artifacts (like "ï..Zuständige")
colnames(wind_data)

# Data Cleaning Pipeline
clean_wind <- wind_data %>%
  # Rename columns for easier access (CamelCase or English is often easier)
  rename(
    Landkreis = `Zuständige Dienststelle`,
    Gemeinde = Standortgemeinde,
    Leistung_MW = `Generatorleistung [MW]`,
    Nabenhoehe_m = `Nabenhöhe [m]`,
    Rotor_m = `Rotordurchmesser [m]`,
    Inbetriebnahme = Inbetriebnahmedatum
  ) %>%
  # Convert Date from character (German format dd.mm.yyyy) to Date object
  mutate(Inbetriebnahme = dmy(Inbetriebnahme)) %>%
  mutate(Jahr = year(Inbetriebnahme)) %>%
  # Filter out rows that might have missing coordinates if necessary for the map
  filter(!is.na(Ost), !is.na(Nord))

# Preview with kable for nicer output
knitr::kable(head(clean_wind), caption = "Vorschau der bereinigten Winddaten")
```



Zeitliche Entwicklung: Ausbau vs. Leistung (Dual-Axis Plot)
Ziel: Darstellung, wie sich die Anzahl der Neubauten im Verhältnis zur installierten Leistung entwickelt hat.

Diese Visualisierung vergleicht die Anzahl der neu gebauten Windräder (blaue Balken) mit der neu installierten Leistung in MW (rote Linie) pro Jahr. Dabei wurde ein Skalierungsfaktor von 3 verwendet, um beide Metriken in einer Grafik lesbar zu machen.



```{r dual-axis-plot}
# 1. Define a scaling factor
scale_factor <- 3 
# Das Ziel: 1,2 GW = 1200 MW
ziel_mw <- 1200

# Aggregating AND Plotting in one pipe
clean_wind %>%
  group_by(Jahr) %>%
  summarise(
    New_Turbines = n(),
    Total_Power = sum(Leistung_MW, na.rm = TRUE)
  ) %>%
  ggplot(aes(x = Jahr)) +
  # Primary Data (Bars): The number of turbines
  geom_bar(aes(y = New_Turbines), stat = "identity", fill = "steelblue", alpha = 0.7) +
  
  # Secondary Data (Line): Actual Power
  geom_line(aes(y = Total_Power / scale_factor), color = "red", linewidth = 1) + 
  
  # --- Horizontale Linie für das Ausbauziel ---
  geom_hline(yintercept = ziel_mw / scale_factor, color = "darkgreen", linetype = "dashed", linewidth = 1) +
  
  annotate("text", x = 2000, y = (ziel_mw / scale_factor) + 5, 
           label = "Ziel: 1,2 GW/Jahr", color = "darkgreen", hjust = 0, vjust = 0, fontface = "bold") +
  
  # Axis Configuration
  scale_y_continuous(
    name = "Anzahl neue Windräder",
    # Limit y-axis to remove empty space (approx max turbines 150)
    limits = c(0, 160), 
    # Secondary axis in red for better visual connection to the line
    sec.axis = sec_axis(~ . * scale_factor, name = "Neu installierte Leistung [MW]")
  ) +
  
  theme_minimal() +
  # Theme adjustments: Axis title and text for secondary axis in red
  theme(
    axis.title.y.right = element_text(color = "red"),
    axis.text.y.right = element_text(color = "red")
  ) +
  labs(
    title = "Windkraftausbau in Baden-Württemberg",
    subtitle = "Vergleich von Anzahl (blau) und Leistung (rot)",
    caption = "Datenquelle: LUBW"
  )
```




Bestandsentwicklung: Kumulierte Gesamtleistung
Ziel: Darstellung der verfügbaren Gesamtkapazität in Baden-Württemberg über die Zeit.

Anstatt nur den jährlichen Zubau zu betrachten, zeigt dieses Flächendiagramm die Entwicklung der gesamten installierten Leistung (Bestand) in Baden-Württemberg. Hierfür wurden die jährlichen Leistungswerte kumuliert. Die grüne Fläche visualisiert das wachsende Energiepotenzial über die Jahre bis zum aktuellen Gesamtbestand.



```{r cumulative_wind_capacity}
# 1. Daten aggregieren und kumulieren
cumulative_stats <- clean_wind %>%
  group_by(Jahr) %>%
  summarise(
    Yearly_Added_MW = sum(Leistung_MW, na.rm = TRUE)
  ) %>%
  arrange(Jahr) %>%
  # Hier berechnen wir die laufende Summe (Gesamtbestand)
  mutate(Total_Capacity_MW = cumsum(Yearly_Added_MW))

# 2. Plotten als Flächendiagramm
ggplot(cumulative_stats, aes(x = Jahr, y = Total_Capacity_MW)) +
  
  # Fläche füllen (zeigt das "Volumen" der verfügbaren Energie)
  geom_area(fill = "forestgreen", alpha = 0.5) +
  # Linie oben drauf für klare Kante
  geom_line(color = "darkgreen", linewidth = 1) +
  
  # Optional: Aktuellen Gesamtwert als Punkt/Text markieren
  annotate("point", x = max(cumulative_stats$Jahr), 
           y = max(cumulative_stats$Total_Capacity_MW), 
           color = "darkgreen", size = 3) +
  annotate("text", x = max(cumulative_stats$Jahr) - 5, 
           y = max(cumulative_stats$Total_Capacity_MW), 
           label = paste0("Gesamt: ~", round(max(cumulative_stats$Total_Capacity_MW)), " MW"), 
           color = "darkgreen", fontface = "bold", vjust = -1) +

  theme_minimal() +
  labs(
    title = "Verfügbare Windkraftleistung in Baden-Württemberg",
    subtitle = "Entwicklung der installierten Gesamtleistung (Kumuliert)",
    y = "Gesamtleistung [MW]",
    x = "Jahr",
    caption = "Datenquelle: LUBW"
  )

```

Szenarien bis 2030
Ziel: Prognose, ob die politischen Ziele mit dem aktuellen Tempo erreichbar sind.

Um die zukünftige Entwicklung bis 2030 abzuschätzen, wurden drei Szenarien berechnet und visualisiert:

Weiter wie bisher (Rot): Eine Fortführung des linearen Trends basierend auf dem Durchschnitt der letzten 5 Jahre (Status Quo).

Verdopplung des Tempos (Orange): Ein optimistischeres Szenario, bei dem die Ausbaugeschwindigkeit verdoppelt wird.

Zielpfad (Blau/Grün): Der notwendige Pfad, um das politische Ziel von 6.100 MW Gesamtleistung (bzw. ca. 1.400 Anlagen) bis 2030 zu erreichen. Der Vergleich zeigt deutlich die Lücke zwischen dem aktuellen Trend und den notwendigen Maßnahmen zur Zielerreichung.

```{r scenarios_mw_2030}
# 1. IST-ZUSTAND BERECHNEN (MW)
# Wir summieren die Leistung pro Jahr und bilden die kumulierte Summe
history_mw <- clean_wind %>%
  filter(Jahr <= 2024) %>% # Historie bis Ende 2024
  group_by(Jahr) %>%
  summarise(Zubau_MW = sum(Leistung_MW, na.rm = TRUE)) %>%
  arrange(Jahr) %>%
  mutate(Gesamtleistung_MW = cumsum(Zubau_MW))

# Aktuelle Werte
current_year <- max(history_mw$Jahr)
current_mw <- max(history_mw$Gesamtleistung_MW)

# Durchschnittlicher MW-Zubau der letzten 5 Jahre (2020-2024)
# Wir nehmen die letzten 5 Einträge aus der Tabelle
avg_zubau_mw_5y <- history_mw %>%
  tail(5) %>%
  summarise(mean_zubau = mean(Zubau_MW)) %>%
  pull(mean_zubau)

# Zielwerte 2030
target_year <- 2030
target_mw <- 6100

# 2. SZENARIEN BERECHNEN (2025 - 2030)
years_future <- 2025:2030
n_years <- length(years_future)

# Szenario 1: Status Quo (linearer Anstieg mit Ø der letzten 5 Jahre)
szenario1 <- tibble(
  Jahr = years_future,
  Szenario = "1. Weiter wie bisher",
  Gesamtleistung_MW = current_mw + (cumsum(rep(avg_zubau_mw_5y, n_years)))
)

# Szenario 2: Doppeltes Tempo
szenario2 <- tibble(
  Jahr = years_future,
  Szenario = "2. Verdopplung des Tempos",
  Gesamtleistung_MW = current_mw + (cumsum(rep(avg_zubau_mw_5y * 2, n_years)))
)

# Szenario 3: Zielpfad (Lineare Verbindung zu 6.100 MW)
# Wir interpolieren von current_mw bis target_mw
szenario3 <- tibble(
  Jahr = years_future,
  Szenario = "3. Zielpfad (6.100 MW)",
  Gesamtleistung_MW = seq(from = current_mw, to = target_mw, length.out = n_years + 1)[-1] 
  # [-1] entfernt den Startwert, da wir bei 2025 beginnen
)

# Zusammenfügen für den Plot
# Wir brauchen einen Startpunkt für alle Linien (2024), damit sie am Area-Chart "andocken"
start_point <- tibble(
  Jahr = 2024,
  Szenario = c("1. Weiter wie bisher", "2. Verdopplung des Tempos", "3. Zielpfad (6.100 MW)"),
  Gesamtleistung_MW = current_mw
)

prognose_daten <- bind_rows(szenario1, szenario2, szenario3, start_point)

# 3. PLOTTING
ggplot() +
  
  # A) Historische Fläche (Grün)
  geom_area(data = history_mw, aes(x = Jahr, y = Gesamtleistung_MW), 
            fill = "forestgreen", alpha = 0.4) +
  geom_line(data = history_mw, aes(x = Jahr, y = Gesamtleistung_MW), 
            color = "darkgreen", linewidth = 1) +

  # B) Die 3 Szenarien (Gestrichelte Linien)
  geom_line(data = prognose_daten, aes(x = Jahr, y = Gesamtleistung_MW, color = Szenario), 
            linetype = "dashed", linewidth = 1) +
  
  # C) Zielpunkt und Labels (Mit 'annotate' statt geom_*, da es Einzelwerte sind)
  annotate("point", x = target_year, y = target_mw, color = "blue", size = 3) +
  annotate("text", x = target_year, y = target_mw, 
           label = "Ziel 2030:\n6.100 MW\n(~1.400 WKA)", 
           color = "blue", vjust = -0.5, hjust = 0.8, fontface = "bold", size = 3.5) +
  
  # Aktueller Stand
  annotate("point", x = current_year, y = current_mw, color = "darkgreen", size = 2) +
  annotate("text", x = current_year, y = current_mw, 
           label = paste0("2024: ", round(current_mw), " MW"), 
           color = "darkgreen", vjust = 1.5, hjust = 0.1, fontface = "bold") +

  # Skalen und Design
  scale_color_manual(values = c("red", "orange", "blue")) +
  scale_x_continuous(breaks = seq(2000, 2030, 5), limits = c(2000, 2031)) +
  scale_y_continuous(labels = scales::comma_format(big.mark = ".", decimal.mark = ",")) +
  
  theme_minimal() +
  labs(
    title = "Szenarien der Windkraftleistung in BW bis 2030",
    subtitle = paste0("Vergleich: Status Quo (Ø ", round(avg_zubau_mw_5y), " MW/Jahr), Verdopplung und politisches Ziel"),
    y = "Kumulierte Gesamtleistung [MW]",
    x = "Jahr",
    caption = "Datenquelle: LUBW | Berechnung: Eigene Szenarien"
  ) +
  theme(legend.position = "bottom", legend.title = element_blank())

```

```{r scenarios_2030}
# 1. IST-ZUSTAND & TREND BERECHNEN
# Wir betrachten die Historie bis Ende 2024 als Basis
history <- clean_wind %>%
  filter(Jahr <= 2024) %>%
  group_by(Jahr) %>%
  summarise(Zubau = n()) %>%
  ungroup() %>%
  arrange(Jahr) %>%
  mutate(Gesamtbestand = cumsum(Zubau))

# Durchschnittlicher Zubau der letzten 5 Jahre (2020 - 2024)
avg_zubau_5y <- history %>%
  filter(Jahr >= 2020) %>%
  summarise(mean_zubau = mean(Zubau)) %>%
  pull(mean_zubau)

# Startwert für die Prognose (Bestand Ende 2024)
start_bestand <- tail(history$Gesamtbestand, 1)
# Der Zielwert für 2030
ziel_anzahl <- 1400

# 2. SZENARIEN ERSTELLEN (2025 - 2030)
years_future <- 2025:2030
n_years <- length(years_future)

# Szenario 1: "Weiter so" (Status Quo)
szenario1 <- tibble(
  Jahr = years_future,
  Szenario = "1. Weiter wie bisher",
  Zuwachs = avg_zubau_5y
)

# Szenario 2: "Verdopplung"
szenario2 <- tibble(
  Jahr = years_future,
  Szenario = "2. Verdopplung des Tempos",
  Zuwachs = avg_zubau_5y * 2
)

# Szenario 3: "Zielerreichung"
# Wie viel müssen wir pro Jahr bauen, um 1400 zu erreichen?
notwendiger_zubau <- (ziel_anzahl - start_bestand) / n_years
szenario3 <- tibble(
  Jahr = years_future,
  Szenario = "3. Zielpfad (1400 Anlagen)",
  Zuwachs = notwendiger_zubau
)

# Alle Szenarien zusammenbinden und kumulieren
prognose_daten <- bind_rows(szenario1, szenario2, szenario3) %>%
  group_by(Szenario) %>%
  mutate(
    # Wir addieren den Zuwachs zum Startbestand von 2024
    Gesamtbestand = start_bestand + cumsum(Zuwachs)
  ) %>%
  ungroup()

# Um Lücken im Plot zu vermeiden: Den Startpunkt 2024 zu jedem Szenario hinzufügen
start_point <- tibble(
  Jahr = 2024,
  Szenario = unique(prognose_daten$Szenario),
  Zuwachs = 0,
  Gesamtbestand = start_bestand
)
prognose_daten <- bind_rows(start_point, prognose_daten)

# 3. PLOTTING
ggplot() +
  # A) Historische Daten (Durchgezogene Linie)
  geom_line(data = history, aes(x = Jahr, y = Gesamtbestand), 
            color = "black", linewidth = 1.2) +
  
  # B) Szenarien (Gestrichelte Linien)
  geom_line(data = prognose_daten, aes(x = Jahr, y = Gesamtbestand, color = Szenario), 
            linetype = "dashed", linewidth = 1) +
  
  # C) Markierung des Ziels
  geom_hline(yintercept = ziel_anzahl, color = "grey50", linetype = "dotted") +
  annotate("text", x = 2020, y = ziel_anzahl + 20, 
           label = paste0("Politisches Ziel: ", ziel_anzahl, " Anlagen"), 
           color = "grey50", fontface = "italic") +

  # Styling
  scale_color_manual(values = c("red", "orange", "darkgreen")) +
  scale_x_continuous(breaks = seq(2000, 2030, 5)) +
  scale_y_continuous(limits = c(0, 1500)) +
  
  theme_minimal() +
  labs(
    title = "Szenarien des Windkraftausbaus bis 2030",
    subtitle = paste0("Basis: ~", round(avg_zubau_5y), " neue Anlagen/Jahr (Schnitt 2020-2024)"),
    y = "Kumulierte Anzahl Windräder",
    x = "Jahr",
    caption = "Szenario 1: Ø 2020-24 | Szenario 2: Doppeltes Tempo | Szenario 3: Linear zum Ziel"
  ) +
  theme(legend.position = "bottom")


```



Korrelation technischer Parameter
Ziel: Untersuchung des Zusammenhangs zwischen Baugröße und Leistung.

Mithilfe einer Korrelationsmatrix wurde der statistische Zusammenhang (Pearson-Koeffizient) zwischen der Nabenhöhe, dem Rotordurchmesser und der Generatorleistung untersucht. Die Werte nahe 1 (rot) zeigen eine sehr starke positive Korrelation. Das bedeutet technisch: Je höher die Nabe und je größer der Rotor, desto höher ist die erzielte Leistung der Windkraftanlage. Die Signifikanz dieser Zusammenhänge wurde statistisch bestätigt.


```{r correlogram}
# --- DEFINITION DER LABELS ---
my_labels <- c(
  "Leistung_MW"  = "Leistung (MW)",
  "Nabenhoehe_m" = "Nabenhöhe (m)",
  "Rotor_m"      = "Rotor (m)"
)

# Pipeline: Data -> Select -> Cor -> Reshape -> Plot
clean_wind %>%
  select(Leistung_MW, Nabenhoehe_m, Rotor_m) %>%
  drop_na() %>%
  cor() %>%
  as.data.frame() %>%
  rownames_to_column("Var1") %>%
  pivot_longer(-Var1, names_to = "Var2", values_to = "rho") %>%
  # Filter lower triangle
  mutate(Var1 = factor(Var1, levels = c("Leistung_MW", "Nabenhoehe_m", "Rotor_m")),
         Var2 = factor(Var2, levels = c("Leistung_MW", "Nabenhoehe_m", "Rotor_m"))) %>%
  filter(as.numeric(Var1) > as.numeric(Var2)) %>%
  
  # Plotting
  ggplot(aes(x = Var1, y = Var2, fill = rho)) +
  geom_tile(color = "white") +
  
  # --- ÄNDERUNG: paste0 fügt das Sternchen an den gerundeten Wert an ---
  geom_text(aes(label = paste0(round(rho, 2), "*")), color = "black", size = 4) +
  
  # Adjusted color scale (Sequential since no negative correlations expected)
  scale_fill_gradient(low = "white", high = "red", 
                      name = "Corr", limits = c(0.8, 1)) +
  
  scale_x_discrete(labels = my_labels) +
  scale_y_discrete(labels = my_labels) +
  
  theme_minimal() +
  coord_fixed() +
  labs(title = "Korrelogramm technischer Parameter",
       subtitle = "Pearson Korrelationskoeffizient (* signifikant)",
       x = "", y = "") +
  theme(panel.grid = element_blank())
```

Räumliche Verteilung (Hexbin Map)
Ziel: Geografische Verortung der Windkraftschwerpunkte in Baden-Württemberg.

Für die räumliche Analyse wurde eine Hexbin-Karte erstellt. Anstatt jeden einzelnen Standort als Punkt darzustellen, fasst diese Methode benachbarte Anlagen in sechseckigen Kacheln (Hexagons) zusammen und summiert deren Leistung. Dies ermöglicht eine bessere Erkennung von regionalen Clustern und Schwerpunkten der Windkraftnutzung, ohne durch Overplotting (überlappende Punkte) an Übersichtlichkeit zu verlieren. Zur besseren Orientierung wurden die Verwaltungsgrenzen der Landkreise (NUTS-3) darübergelegt.
```{r maps-setup}
# Geodaten zentral vorbereiten (werden für beide Karten benötigt)
# NUTS 1 = Bundesland (DE1 = BW), NUTS 3 = Landkreise
bw_border <- gisco_get_nuts(nuts_id = "DE1", resolution = "01") %>%
  st_transform(crs = 25832)

bw_kreise <- gisco_get_nuts(country = "Germany", nuts_level = 3, resolution = "03") %>%
  filter(startsWith(NUTS_ID, "DE1")) %>%
  st_transform(crs = 25832)
```

```{r map-wind-turbines}
# Aggregating per Landkreis for Table
landkreis_agg <- clean_wind %>%
  group_by(Landkreis) %>%
  summarise(
    Turbine_Count = n(),
    Sum_Leistung = sum(Leistung_MW, na.rm = TRUE) 
  ) %>%
  arrange(desc(Sum_Leistung))

# Output as nice table
knitr::kable(head(landkreis_agg, 10), caption = "Top 10 Landkreise nach Leistung")
```

```{r map-hexbin-with-boundaries}
# Plotting the Map with boundaries directly
ggplot(clean_wind, aes(x = Ost, y = Nord, z = Leistung_MW)) +
  
  # 1. Boundaries (Layering: Borders first)
  geom_sf(data = bw_kreise, fill = NA, color = "grey80", size = 0.3, inherit.aes = FALSE) +
  geom_sf(data = bw_border, fill = NA, color = "black", size = 0.8, inherit.aes = FALSE) +
  
  # 2. Hexbins
  stat_summary_hex(fun = sum, bins = 20, alpha = 0.85) +
  scale_fill_viridis_c(option = "C", name = "Summe der Leistung\npro Kachel\n(MW)") +
  
  theme_void() + 
  coord_sf(datum = NA) +
  labs(title = "Räumliche Verteilung der Windkraftleistung",
       subtitle = "Hexbin Map mit Verwaltungs-Grenzen")
```



```{r landkreis_map_labels}
# 1. Daten vorbereiten (wie zuvor)
wind_points <- clean_wind %>%
  st_as_sf(coords = c("Ost", "Nord"), crs = 25832)

map_data_agg <- st_join(wind_points, bw_kreise) %>%
  st_drop_geometry() %>%
  group_by(NUTS_ID) %>%
  summarise(
    Anzahl_Windraeder = n(),
    Sum_Leistung = sum(Leistung_MW, na.rm = TRUE)
  )

# 2. Labels erstellen und Geometrie anfügen
map_data <- bw_kreise %>%
  left_join(map_data_agg, by = "NUTS_ID") %>%
  mutate(
    # A) Namen bereinigen: "Tübingen, Landkreis" -> "Tübingen"
    Clean_Name = str_remove_all(NUTS_NAME, ", Landkreis|, Stadtkreis|Landkreis |Stadtkreis "),
    
    # B) Abkürzung erstellen: Erste 3 Buchstaben (z.B. "Tüb")
    # Falls du lieber den ganzen Namen willst, nutze einfach 'Clean_Name' im Plot unten
    Label_Kurz = str_sub(Clean_Name, 1, 3) 
  )

# 3. Plotten
ggplot(map_data) +
  geom_sf(aes(fill = Sum_Leistung), color = "white", size = 0.2) +
  
  # --- NEU: Text-Labels hinzufügen ---
  geom_sf_text(
    aes(label = Label_Kurz), # Ändere zu 'Clean_Name' für "Tübingen" statt "Tüb"
    size = 2.5,              # Textgröße
    color = "black",         # Textfarbe
    fontface = "bold",       # Fettdruck für bessere Lesbarkeit
    check_overlap = TRUE     # Verhindert, dass sich Texte unleserlich überlagern
  ) +
  # -----------------------------------

  scale_fill_viridis_c(
    option = "C", 
    name = "Leistung (MW)",
    na.value = "grey90",
    direction = 1
  ) +
  
  theme_void() +
  labs(
    title = "Windkraftleistung pro Landkreis",
    subtitle = "Mit abgekürzten Landkreis-Namen",
    caption = "Daten: LUBW | Geodaten: Eurostat"
  ) +
  coord_sf(datum = NA)

```

Ökonomische Analyse: Steuerkraft-Proxy
Ziel: Schätzung, welche Landkreise potenziell am meisten von Gewerbesteuereinnahmen profitieren.

Da die reine Leistung nicht direkt den Steuereinnahmen entspricht, wurde ein 'Steuerkraft-Proxy' entwickelt. Dieser gewichtet die Leistung einer Anlage anhand ihres Alters, um steuerliche Abschreibungszyklen zu simulieren:

Neue Anlagen (< 5 Jahre): Gewicht 0,8 (Hohe Abschreibung, aber EEG-Umlagen).

Abschreibungsphase (5–12 Jahre): Gewicht 0,3 (Niedriges Steuerpotenzial durch Zins/Tilgung).

'Cash Cows' (> 12 Jahre): Gewicht 1,0 (Anlage abgeschrieben, hoher Ertrag fließt in Gewerbesteuer). Das Ergebnis zeigt ein Ranking der Landkreise, die voraussichtlich am stärksten finanziell von den Windparks profitieren.
```{r tax-potential-analysis}
# 1. BERECHNUNG DES STEUER-PROXY
tax_analysis <- clean_wind %>%
  filter(Status == "in Betrieb") %>%
  mutate(Alter = 2025 - Jahr) %>%
  mutate(Gewichtungsfaktor = case_when(
    Alter < 5 ~ 0.8,
    Alter >= 5 & Alter <= 12 ~ 0.3,
    Alter > 12 ~ 1.0, 
    TRUE ~ 0
  )) %>%
  mutate(Steuerkraft_Index = Leistung_MW * Gewichtungsfaktor)

# 2. AGGREGATION & VISUALISIERUNG
landkreis_ranking <- tax_analysis %>%
  group_by(Landkreis) %>%
  summarise(
    Steuerkraft_Proxy = sum(Steuerkraft_Index, na.rm = TRUE)
  ) %>%
  mutate(Landkreis = str_remove(Landkreis, "Landratsamt "))

# Tabelle
knitr::kable(head(arrange(landkreis_ranking, desc(Steuerkraft_Proxy)), 10), 
             caption = "Top 10 Landkreise nach geschätztem Steuerpotenzial")

# Plot using slice_max for cleaner code
landkreis_ranking %>%
  slice_max(Steuerkraft_Proxy, n = 15) %>%
  ggplot(aes(x = reorder(Landkreis, Steuerkraft_Proxy), y = Steuerkraft_Proxy)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(
    title = "Geschätztes Steuerpotenzial (Top 15)",
    subtitle = "Proxy-Index basierend auf Anlagenalter",
    x = "Landkreis",
    y = "Steuerkraft-Index"
  ) +
  theme_minimal()
```

```{r tax-hexbin-map}
# Plot in Variable speichern, um Redundanz zu vermeiden
p_tax_map <- ggplot(tax_analysis, aes(x = Ost, y = Nord, z = Steuerkraft_Index)) +
  stat_summary_hex(fun = sum, bins = 25, alpha = 0.9) +
  scale_fill_viridis_c(option = "A", direction = -1, name = "Steuerkraft-Proxy") +
  theme_void() + 
  coord_sf(datum = NA) +
  labs(
    title = "Räumliche Verteilung des Steuerpotenzials",
    subtitle = "Hexbin Map (Gewichtete MW)"
  )

# 1. Basis-Plot ohne Grenzen (falls gewünscht, sonst diesen Schritt weglassen)
# print(p_tax_map)

# 2. Plot MIT Grenzen erweitern (Wiederverwendung der Variable)
p_tax_map +
  geom_sf(data = bw_kreise, fill = NA, color = "grey80", size = 0.3, inherit.aes = FALSE) +
  geom_sf(data = bw_border, fill = NA, color = "black", size = 0.8, inherit.aes = FALSE)
```