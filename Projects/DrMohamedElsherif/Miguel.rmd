---
title: "MiguelDLM's solution to DrMohamedElsherif's project"
author: "Miguel Díaz de León"    
output: md_document
---

## Load the data

First let's load the data.

```{r load-data, results='hide', message=FALSE, warning=FALSE}
# Load necessary libraries
library(here)
library(readr)
library(purrr)
library(magrittr)
library(dplyr)

# unzip data
unzip("BikeData.zip", exdir = "BikeData")
# read data
list.files(path = here("Projects/DrMohamedElsherif/BikeData"), pattern = "*.csv", full.names = TRUE) %>% 
    set_names(nm = tools::file_path_sans_ext(basename(.))) %>% 
    walk2(.x = ., .y = names(.), ~ assign(.y, read_csv(.x), envir = .GlobalEnv))
# remove unzipped data
unlink("BikeData", recursive = TRUE)

```
## Merge the data

The data frame bike_counts contains the number of bikes that passed through each point every hour and the weather data frame contains the weather information for each hour. We need to merge both data frames to analyze the relationship between the number of bikes and the weather. Since the data frames cointain a column with the date and hour, we can use this column to merge the data frames.

```{r merge-data}
# Merge the data frames
bike_data <- merge(bike_counts, weather, by = "time")
head(bike_data)
```

## Explore the data to find missing values

Let's explore the data to find missing values.

```{r explore-data}
# Number of missing values
colSums(is.na(bike_data))
```

No missing values were found, however, we only teste for NA values. We need to check if there are any other type of missing values as zeros in the channel_id or counter_site_id column

```{r explore-data2}
# Number of zeros in the channel_id column
sum(bike_data$channel_id == 0)
# Number of zeros in the counter_site_id column
sum(bike_data$counter_site_id == 0)
```

No outliers were found in the channel_id or counter_site_id columns. We can now proceed with the analysis.

## Plot the data
Lets plot the number of bikes that passed through each point every hour separating the data by counter_site_id and group by the hour of the day.

```{r plot-data}
library(ggplot2)
library(dplyr)

# Extract the hour from the time column adding it as a new column
bike_data$hour <- as.numeric(format(bike_data$time, "%H"))

# Agrupar por hour y counter_site_id, y sumar bike_count
bike_data_per_hour <- bike_data %>%
    group_by(hour, counter_site_id) %>%
    summarise(bike_count = sum(bike_count), .groups = 'drop')

bike_data_per_hour$counter_site_id <- as.factor(bike_data_per_hour$counter_site_id)

# Plot
ggplot(bike_data_per_hour, aes(x = hour, y = bike_count, color = counter_site_id, group = counter_site_id)) +
    geom_line() +
    labs(title = "Number of bikes by counter site and hour", x = "Hour", y = "Number of bikes")+ 
    theme_minimal() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

We can see that the number of bikes that pass through each point varies throughout the day. There is a peak in the morning and another in the afternoon. The number of bikes is higher in the afternoon than in the morning.

## Analyze the relationship between the number of bikes and the weather

Let's plot the number of bikes that passed through each point every hour and the weather information. We will create a new data frame with the sum of the number of bikes by hour in all the counter sites and merge it with the weather data frame.

```{r analyze-relationship}
bike_data_weather <- bike_data %>%
    mutate(time = as.POSIXct(time, format = "%Y-%m-%d %H:%M:%S")) %>%
    group_by(time) %>% 
    summarise(bike_count = sum(bike_count), .groups = 'drop') %>%
    left_join(weather, by = "time")


```

Now we will plot the number of bikes per hour in the Y axe against the temperature in the X axe.

```{r plot-relationship}



ggplot(bike_data_weather, aes(x = temperature, y = bike_count)) +
    geom_point() +
    labs(title = "Number of bikes by temperature", x = "Temperature", y = "Number of bikes")+
    theme_minimal() + 
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

In this plot we can see that the number of bikes that pass through each point increases as the temperature increases. There is a positive relationship between the number of bikes and the temperature.

We may add a linear regression line to the plot to visualize the relationship between the number of bikes and the temperature.

```{r plot-relationship2}
ggplot(bike_data_weather, aes(x = temperature, y = bike_count)) +
    geom_point() +
    geom_smooth(method = "lm") +
    labs(title = "Number of bikes by temperature", x = "Temperature", y = "Number of bikes")+
    theme_minimal() + 
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black"))+
          #add the R squared value
    annotate("text", x = -10, y = 2000, label = paste("R^2 =", round(summary(lm(bike_count ~ snow, data = bike_data_weather))$r.squared, 4)), hjust = 0, vjust = 1)
```

Regardless the positive relationship between the number of bikes and the temperature, the R squared value is very low, which means that the temperature is not a good predictor of the number of bikes.

We can do the same analysis with the snow column.

```{r plot-relationship3}
ggplot(bike_data_weather, aes(x = snow, y = bike_count)) +
    geom_point() +
    geom_smooth(method = "lm") +
    labs(title = "Number of bikes by snow", x = "Snow", y = "Number of bikes")+
    theme_minimal() + 
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))+
    annotate("text", x = 0, y = 2000, label = paste("R^2 =", round(summary(lm(bike_count ~ snow, data = bike_data_weather))$r.squared, 4)), hjust = 0, vjust = 1)
```

In the case of the snow, a low R squared value is obtained, which means that the snow is not a good predictor of the number of bikes. This may be because even when it is not snowing, the stations register a low number of bikes. The reason may be related to failed sensors or other factors that are not related to the weather.

Let's analyze if the rain is a good predictor of the number of bikes.

```{r plot-relationship4}
ggplot(bike_data_weather, aes(x = rain, y = bike_count)) +
    geom_point() +
    geom_smooth(method = "lm") +
    labs(title = "Number of bikes by rain", x = "Rain", y = "Number of bikes")+
    theme_minimal() + 
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))+
    annotate("text", x = 0, y = 2000, label = paste("R^2 =", round(summary(lm(bike_count ~ rain, data = bike_data_weather))$r.squared, 4)), hjust = 0, vjust = 1)
```

It is interesting to notiece that in the days of rain and snow, the records of the stations are lower than in the days without rain or snow. This is because the sensors may be affected by the weather. Also it could be possible that the points are being overploted in the plot, so we may need to check the number of records for each type of weather.

```{r plot-relationship5}
bike_data_weather %>%
    count(rain)
```
As we can see, the number of records for the days without rain is higher than the number of records for the days with rain.

Let's do the same for the snow column.

```{r plot-relationship6}
bike_data_weather %>%
    count(snow)
```

The number of records for the days without snow is higher than the number of records for the days with snow. This lead us to the conclusion that the weather may be affecting the sensors of the stations.
