---
title: "MiguelDLM's solution to DrMohamedElsherif's project"
author: "Miguel Díaz de León"    
output: md_document
---

## Load the data

First let's load the data.

```{r load-data}
library(readr)
library(purrr)

# Set the working directory to the folder where this file is located
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

# Load the data from the RData file that is in the same folder as this Rmd file
list.files(path = paste0(getwd(), "/BikeData/"), pattern = "*.csv", full.names = TRUE) %>% 
    set_names(nm = tools::file_path_sans_ext(basename(.))) %>% 
    walk2(.x = ., .y = names(.), ~ assign(.y, read_csv(.x), envir = .GlobalEnv))

```
## Merge the data

The data frame bike_counts contains the number of bikes that passed through each point every hour and the weather data frame contains the weather information for each hour. We need to merge both data frames to analyze the relationship between the number of bikes and the weather. Since the data frames cointain a column with the date and hour, we can use this column to merge the data frames.

```{r merge-data}
# Merge the data frames
bike_data <- merge(bike_counts, weather, by = "time")
head(bike_data)
```

The holydays dataset contains the dates of the holidays in the city. We need to merge this data with the bike_data data frame to analyze the relationship between the number of bikes and the holidays. The first column is the data with the format "YYYY-MM-DD", on the other hand the bike_data frame has the date and hour in a combined column. We need to extract the date from the time column to merge the data frames.

```{r merge-data2}
# Extract the date from the time column
bike_data$date <- as.Date(bike_data$time)
# Merge the data frames
bike_data <- merge(bike_data, holidays, by = "date")
#divide the time column into date and hour
bike_data$time <- as.POSIXct(bike_data$time)
bike_data$hour <- as.numeric(format(bike_data$time, "%H"))
bike_data$counter_site_id <- as.factor(bike_data$counter_site_id)
bike_data$rain <- as.factor(bike_data$rain)
bike_data$holiday <- as.factor(bike_data$holiday)
bike_data$channel_id <- as.factor(bike_data$channel_id)

head(bike_data)
```

## Explore the data to find missing values

Let's explore the data to find missing values.

```{r explore-data}
# Number of missing values
colSums(is.na(bike_data))
```

No missing values were found, however, we only teste for NA values. We need to check if there are any other type of missing values as zeros in the channel_id or counter_site_id column

```{r explore-data2}
# Number of zeros in the channel_id column
sum(bike_data$channel_id == 0)
# Number of zeros in the counter_site_id column
sum(bike_data$counter_site_id == 0)
```

No outliers were found in the channel_id or counter_site_id columns. We can now proceed with the analysis.

## Plot the data
Lets plot the number of bikes that passed through each point every hour separating the data by counter_site_id and group by the hour of the day.

```{r plot-data}
library(ggplot2)
library(dplyr)

# Agrupar por hour y counter_site_id, y sumar bike_count
bike_data_per_hour <- bike_data %>%
    group_by(hour, counter_site_id) %>%
    summarise(bike_count = sum(bike_count), .groups = 'drop')

bike_data_per_hour$counter_site_id <- as.factor(bike_data_per_hour$counter_site_id)

# Plot
ggplot(bike_data_per_hour, aes(x = hour, y = bike_count, color = counter_site_id, group = counter_site_id)) +
    geom_line() +
    labs(title = "Number of bikes by counter site and hour", x = "Hour", y = "Number of bikes")
```

We can see that the number of bikes that pass through each point varies throughout the day. There is a peak in the morning and another in the afternoon. The number of bikes is higher in the afternoon than in the morning.

## Analyze the relationship between the number of bikes and the weather

Let's plot the number of bikes that passed through each point every hour and the weather information. We will create a new data frame with the sum of the number of bikes by hour in all the counter sites and merge it with the weather data frame.

```{r analyze-relationship}
# Summarize the number of bikes by hour
bike_data_per_hour_all <- bike_data %>%
    group_by(hour) %>%
    summarise(bike_count = sum(bike_count), .groups = 'drop')
#extract the hour from the time column in the weather data
weather$hour <- as.numeric(format(weather$time, "%H"))
#merge with the weather data
bike_data_per_hour_all <- merge(bike_data_per_hour_all, weather, by = "hour")
bike_data_per_hour_all$rain <- as.factor(bike_data_per_hour_all$rain)
bike_data_per_hour_all$snow <- as.factor(bike_data_per_hour_all$snow)
bike_data_per_hour_all$holiday <- as.factor(bike_data_per_hour_all$holiday)
bike_data_per_hour_all$temperature <- as.numeric(bike_data_per_hour_all$temperature)
bike_data_per_hour_all$windspeed <- as.numeric(bike_data_per_hour_all$windspeed)

```

Now we can plot the number of bikes that passed through all the counter sites every hour and the weather information.

```{r plot-relationship}
# Plot
ggplot(bike_data_per_hour_all, aes(x = hour, y = bike_count, color = rain, linetype = rain)) +
    geom_line() +
    labs(title = "Number of bikes by hour and rain", x = "Hour", y = "Number of bikes", color = "Rain", linetype = "Rain")
```