---
title: "Svenjasinitialprojectsolution.rmd"
author: "SvenjaPoerstel"
date: "2025-06-30"
output: md_document
---

```{r, echo = TRUE, results = 'hide'}
library(tidyverse) 
library(ggplot2) 
library(readr) 
library(dplyr) 
library(tidyr)
```

```{r,, echo = TRUE, results = 'hide'}
# read csv
if (interactive()) {
  setwd(dirname(rstudioapi::getSourceEditorContext()$path))
} else if (!is.null(knitr::current_input())) {
  setwd(dirname(knitr::current_input()))
}
ms <- read_csv2("data_MS.csv", show_col_types = FALSE)
```

##Data manipulation
```{r}
ms_cleaned <- ms %>%
  # (1) MS duration in months (+++), created a new column but didn't delete the old one
  mutate(
    MSDuration_months = case_when(
      grepl("Year?", `MS Duration`) ~ as.integer(gsub("Year", "", `MS Duration`)) * 12,
      grepl("Month?", `MS Duration`) ~ as.integer(gsub("Months", "", `MS Duration`)),
      TRUE ~ NA_integer_
    ),
    
    # (2) new column related to diseases
    Other_Diseases_Count = ifelse(
      `Other Diseases` == "-" | is.na(`Other Diseases`) | trimws(`Other Diseases`) == "",
      0,
      sapply(`Other Diseases`, function(x) {
        n_commas <- lengths(regmatches(x, gregexpr(",", x)))
        n_commas + 1
      })
    ),
    
    # (3) new columns (treated with Corticosteroid)
    Corticosteroid = ifelse(str_detect(Medication, regex("corticosteroid", ignore_case = TRUE)), "Yes", "No"),
    
    # (4) new columns (treated with B-cell depleting therapy
    BCellDepletion = ifelse(str_detect(Medication, regex("rituximab", ignore_case = TRUE)), "Yes", "No"),
    
    # (5) use coded names according to the schema instead of clear names and delete column names
    PatientCode = sprintf("MS_XS_%03d", as.integer(as.character(`No.`)))
  ) %>%
  select(-`Patient Name`)

print(ms_cleaned)
```


## Visualization

# Scatterplot

```{r}
ggplot(ms, aes(x = `Cortisol Test Result`, y = `BAI Score`, color = Sex, shape = Corticosteroid)) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE,
              aes(color = Sex, linetype = Corticosteroid, group = interaction(Sex, Corticosteroid))) +
  labs(title = "BAI Score vs Cortisol Level",
       x = "Cortisol (ng/mL)",
       y = "BAI Score")
```  
The plot displays the relationship between BAI Score and Cortisol Test Result, with data points differentiated by shape. 
# correlation value for four groups f+, f-, m+, m-
```{r}
cor_groups <- ms %>%
  group_by(Sex, Corticosteroid) %>%
  summarise(Correlation = cor(`Cortisol Test Result`, `BAI Score`, use = "complete.obs"),
            .groups = "drop")
print(cor_groups)
```

# chart showing average NO test value
```{r}
# Group MS duration into 6-month intervals
ms$MSDurationGroup <- cut(ms$MSDuration_months, 
                          breaks = seq(0, max(ms$MSDuration_months, na.rm = TRUE) + 6, by = 6), 
                          right = FALSE)


# Calculate mean and standard deviation of NO test values for each MS duration group
ms %>%
  group_by(MSDurationGroup) %>%
  summarise(mean_NO = mean(`NO test result`, na.rm = TRUE),
            sd_NO = sd(`NO test result`, na.rm = TRUE)) %>%
  ggplot(aes(x = MSDurationGroup, y = mean_NO)) +
  geom_point(size = 3, color = "darkblue") +
  geom_errorbar(aes(ymin = mean_NO - sd_NO, ymax = mean_NO + sd_NO), width = 0.2) +
  labs(title = "NO Test Results by MS Duration (6-Month Groups)",
       x = "MS Duration Group",
       y = "Average NO Test Value") 
```
The graph shows the average NO test values as points and the standard deviation as an error bar for each group. 

```{r}
# 1. Erstelle alle möglichen 6-Monats-Intervalle
breaks <- seq(0, max(ms$MSDuration_months, na.rm = TRUE) + 6, by = 6)
labels <- paste0(breaks[-length(breaks)], "-", breaks[-1])

# 2. Gruppiere die Daten in diese Intervalle
ms$MSDurationGroup <- cut(ms$MSDuration_months,
                          breaks = breaks,
                          labels = labels,
                          right = FALSE)

# 3. Berechne Mittelwert und SD
summary_df <- ms %>%
  group_by(MSDurationGroup) %>%
  summarise(mean_NO = mean(`NO test result`, na.rm = TRUE),
            sd_NO = sd(`NO test result`, na.rm = TRUE),
            .groups = "drop")

# 4. Erstelle vollständige Gruppe-Referenz (auch leere Gruppen)
all_groups <- data.frame(MSDurationGroup = factor(labels, levels = labels))

# 5. Füge fehlende Gruppen mit NA hinzu
summary_df_full <- left_join(all_groups, summary_df, by = "MSDurationGroup")

# 6. Plot
ggplot(summary_df_full, aes(x = MSDurationGroup, y = mean_NO)) +
  geom_point(size = 3, color = "darkblue", na.rm = TRUE) +
  geom_errorbar(aes(ymin = mean_NO - sd_NO, ymax = mean_NO + sd_NO), width = 0.2, na.rm = TRUE) +
  labs(title = "NO Test Results by MS Duration (6-Month Groups)",
       x = "MS Duration Group (Months)",
       y = "Average NO Test Value") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
++++++++++++++++
ms_grouped <- ms_cleaned %>%
  mutate(
    MSDurationGroup = cut(
      MSDuration_months,
      breaks = seq(0, max(MSDuration_months, na.rm = TRUE) + 6, by = 6),
      right = FALSE,
      include.lowest = TRUE
    )+++++++++++++++++
)

ms_grouped %>%
  group_by(MSDurationGroup) %>%
  summarise(
    mean_NO = mean(`NO test result`, na.rm = TRUE),
    sd_NO = sd(`NO test result`, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = MSDurationGroup, y = mean_NO)) +
  geom_point(size = 3, color = "darkblue") +
  geom_errorbar(aes(ymin = mean_NO - sd_NO, ymax = mean_NO + sd_NO), width = 0.2) +
  labs(
    title = "NO Test Results by MS Duration (6-Month Groups)",
    x = "MS Duration Group",
    y = "Average NO Test Value"
  )
```


```{r}
ms_adjusted <- ms_cleaned %>%
  mutate(
    Total_Diseases = Other_Diseases_Count + 1,
    Age_Group = cut(Age, breaks = seq(0, 100, by = 15), right = FALSE)
  ) %>%
  drop_na(Age_Group)


ms_summary <- ms_augmented %>%
  group_by(Age_Group) %>%
  summarise(
    MeanDiseases = mean(Total_Diseases, na.rm = TRUE),
    SDDiseases = sd(Total_Diseases, na.rm = TRUE),
    .groups = "drop"
  )

#graph
ggplot() +
  geom_count(
    data = ms_adjusted,
    aes(x = Age_Group, y = Total_Diseases),
    color = "gray50",
    alpha = 0.5
  ) +
  geom_bar(
    data = ms_summary,
    aes(x = Age_Group, y = MeanDiseases),
    stat = "identity", fill = "darkgreen", width = 0.6
  ) +
  geom_errorbar(
    data = ms_summary,
    aes(x = Age_Group,
        ymin = MeanDiseases - SDDiseases,
        ymax = MeanDiseases + SDDiseases),
    width = 0.2, color = "black"
  ) +
  labs(
    title = "Average Number of Diseases by Age Group",
    x = "Age Group (15-year intervals)",
    y = "Mean Disease Count (incl. MS)"
  ) +
  guides(size = "none")
```