
library(tidyverse)

# read list of country codes
countryCodes <- read_tsv("https://gist.github.com/malteos/658b98ea89b8f7584ae1/raw/8b2f1be51600fc379e247cbbaa4d5bdbc83ff9d5/german-iso-3166.csv",
                         col_names = c("code","country"))

######### ROSTER INFORMATION CORRECTION  ##################

rosters <-
  # read all roster files
  read_csv2(
    list.files("volleyball-project/team-rosters", pattern = "*.csv", full.names = T)
    , id = "team"
    , locale = locale(encoding = "cp852")
    , na = c("keine Angabe","NA")
  ) |>

  # reduction to columns of interest
  select( -c(`First Name Last Name`, `Last Name First Name`, `Date of Birth`, `Jersey Number`)) |>

  ####  CORRECTIONS  ###########

# define roster name
mutate( team = str_remove(team,"^.*roster_") |> str_remove(".csv") |> str_replace_all("_"," ")) |>
  # correct heights to meter
  mutate( Height = as.numeric(Height)/100) |>
  # correct gender information
  # pull(Gender) |> unique()
  mutate( Gender = ifelse(str_detect(Gender,"^[mM1]"), "male","female")) |>

  #### COUNTRY CODES ###########

# get mappable country codes
left_join(countryCodes, by = c("Nationality" = "country")) |>
  # do manual country code setting where needed
  mutate( code = case_when(
    Nationality %in% c("ger","GER","de","DE","Ger") ~ "DE",
    Nationality == "Spain" ~ "ES",
    Nationality == "USA" ~ "US",
    Nationality == "Poland" ~ "PL",
    Nationality == "Finland"~"FI",
    Nationality == "Canada" ~"CA",
    Nationality == "Holland" ~"NL",
    Nationality == "Bosnien und Herzegowina" ~"BA",
    Nationality %in% c("Serbia","Serbien") ~"RS",
    Nationality == "Australie"~"AU",
    Nationality == "Montenegro"~"ME",
    Nationality == "Slowenia"~"SI",
    .default = code
  )) |>
  # check unmapped Nationalities
  # filter(is.na(code)) |> pull(Position) |> unique
  select(-Nationality) |>

  #####  POSITION INFORMATION  #######

# check for position strings
# pull(Position) |> unique()
# define synonymous positions
left_join(
  tribble(
    ~Position, ~task,
    "middle     blocker", "middle blocker",
    "Mittelblock"       , "middle blocker",
    "middle"           , "middle blocker",
    "middle blocker"     , "middle blocker",
    "middle  blocker"   , "middle blocker",
    "Middle Blocker"    , "middle blocker",
    "Middle blocker"     , "middle blocker",
    "opposite"           , "opposite hitter",
    "opposite hitter"   , "opposite hitter",
    "Opposite"           , "opposite hitter",
    "Opposite Hitter"   , "opposite hitter",
    "opoositte    hitter", "opposite hitter",
    "Diagonal"            , "opposite hitter",
    "Außenangriff"       , "outside hitter",
    "Auáenangriff"   , "outside hitter",
    "outside"            , "outside hitter",
    "Outside Hitter"     , "outside hitter",
    "Libero"             , "libero",
    "Universal"      , "libero",
    "Zuspiel"            , "setter",
    "setter"            , "setter",
    "Setter"            , "setter",
    "Cheftrainer"        , "head coach",
    "head coach"       , "head coach",
    "coach (headcoach)"  , "head coach",
    "chef trainer"       , "head coach",
    "head of coaching"   , "head coach"
  ), by = "Position"
) |>
  # drop all positions not matched above
  filter(!is.na(task)) |>
  select(-Position)
  # view()

  ###########  RESULTS  ###########################

# read data
dat <- list()
for( f in list.files("volleyball-project/games/", pattern = "*.csv",full.names = T)) {
  dat[[f]] <- read_csv2(f ,
                        locale = locale(encoding = "cp852"),
                        col_select = c("Mannschaft 1","Mannschaft 2","Satzpunkte"),
                        col_types = list(Satzpunkte ="c")
  )
}

library(png)
library(patchwork)


# get win/loss statistics per team
bind_rows(dat) |>
  # numerate games
  mutate(game = 1:n()) |>
  # decompose game information into 2 lines
  pivot_longer(cols= starts_with("Mann"), values_to = "team") |>
  # per line: identify if that game was won or lost
  rowwise() |>
  mutate(name = str_extract(name,"\\d+") |> as.numeric(),
         won = str_split(Satzpunkte,":",simplify = T)[[name]] > str_split(Satzpunkte,":",simplify = T)[[ifelse(name==1,2,1)]],
         all_sets = str_split(Satzpunkte,":",simplify = T) |> as.numeric() |> sum(),
         sets = str_split(Satzpunkte,":",simplify = T)[[name]] |> as.numeric()) |>
  ungroup() |>
  # get statistics per team
  group_by(team) |>
  summarize(win = sum(won), loss= n()-win, played = n(), meanOwnSets = mean(sets), meanSetsInGames = mean(all_sets)) |>
  mutate( win = ifelse(win==0,NA,win), loss=ifelse(loss==0,NA,loss)) |>
  # get only top teams
  slice_max(win,n=2) |>
  mutate(teamId = 1:n()) |>

  # visualize
  pivot_longer(cols = c(win,loss, meanOwnSets, meanSetsInGames), names_to = "result")|>
  mutate(result = factor(result)) |>
  ggplot() +
  geom_bar(
    aes(fill=team, y = value, x=result),
    stat = "identity",
    position="dodge"
  ) +
  ylim(-100,50)+
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = unit(rep(-1,4), "cm")
  )  +
  coord_polar(start = 0)+
  geom_text(aes(label=round(value,1),
                x=as.integer(result)+ifelse(teamId==1,-0.22,0.22),
                y = value+10),
            hjust=0.5, color="black", fontface="bold",alpha=0.6, size=2.5  ) +
  inset_element(p=readPNG("volleyball-project/team-logos/BRV_Berlin_Logo.png", native=TRUE),
                left=0.25, right=0.5, bottom=0.4, top=0.6)+
  inset_element(p=readPNG("volleyball-project/team-logos/vfb_friedrichshafen_logo_kreis.png", native=TRUE),
              left=0.5, right=0.75, bottom=0.4, top=0.6)


