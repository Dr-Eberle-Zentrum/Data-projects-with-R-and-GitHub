---
title: "Nutriscore project"
output: md_document
date: "2023-06-20"
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
options(repos=structure(c(CRAN="https://cloud.r-project.org")))
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE
)
rm(list=ls())
install.packages("data.table")
library(data.table)
library(readr)
library(tidyverse)
library(ggplot2)
Data <- fread("Food_data_0.txt")
Data1 <- fread("Food_data_1.txt")
  colnames(Data1)<-colnames(Data) 
Data_tot <- as.data.frame(lapply(Data, as.character), stringsAsFactors = FALSE)
Data1_tot <- as.data.frame(lapply(Data1, as.character), stringsAsFactors = FALSE)
Data_merge <- rbind(Data_tot,Data1_tot) %>%
  select_if(~ !all(is.na(.))) %>%
  select("brands", "categories", "labels", "food_groups_en", "countries_en", "ingredients_analysis_tags", "allergens", "additives_n", "nutriscore_score", "nutriscore_grade", "pnns_groups_2", "energy.kcal_100g", "energy.kj_100g") 

Data_merge$brands <- as.factor(Data_merge$brands)
#levels(Data_merge$brands)
Data_merge$brands <- droplevels(Data_merge$brands, exclude = "nestle")

Data_merge$energy.kcal_100g <- as.numeric(Data_merge$energy.kcal_100g)
Data_merge$energy.kj_100g <- as.numeric(Data_merge$energy.kj_100g)
#Data_merge <-  mutate(Data_merge$energy.kcal_100g == ifelse(is.na(Data_merge$energy.kcal_100g), Data_merge$energy.kj_100g / 4.184, Data_merge$energy.kcal_100g),Data_merge$energy.kj_100g == ifelse(is.na(Data_merge$energy.kj_100g), Data_merge$energy.kcal_100g * 4.184, Data_merge$energy.kj_100g))

Data_merge$pnns_groups_2 <- as.factor(Data_merge$pnns_groups_2)
Data_merge$nutriscore_score <- as.numeric(Data_merge$nutriscore_score)
Data_merge$countries_en <- as.factor(Data_merge$countries_en)
Data_merge$nutriscore_grade <- as.factor(Data_merge$nutriscore_grade) 
Data_merge$nutriscore_grade <- droplevels(Data_merge$nutriscore_grade, exclude = "")
Data_merge$food_groups_en <- as.factor(Data_merge$food_groups_en)
package="AER"

Nutri_Colors<-c("#058b49","#74c928","#fbc801","#f4730e","#ef2d1a")
#Data_merge$additives_en <- as.factor(Data_merge$additives_en)
#Data_merge$additives_en <- droplevels(Data_merge$additives_en, exclude = "")
Upper_lim<-c(-1,2,10,18,40)
#color_factor <- cut(Data_merge$nutriscore_score, breaks = c(-15,-1,2,10,18,40), labels = c("#058b49","#74c928","#fbc801","#f4730e","#ef2d1a"))



Country <- Data_merge %>%
  drop_na(countries_en, nutriscore_grade) %>%
  subset(countries_en %in% c("France", "Germany")) %>%
  count(nutriscore_grade, countries_en) %>%
  ggplot(aes(x= countries_en, y=n, group=nutriscore_grade, color = nutriscore_grade))+
  scale_color_manual(values = Nutri_Colors) +
  geom_point() + geom_line()  

print(Country)

```

## Nutriscore project

The data set was quite a mess so data preparation took quite a lot of time. I used the fread() function to import the data sets. I only imported two out of five data sets. The second data set didn't have column names so I added the column names of the first data set to the second and merged the two tables. Then I did a pipe to delete all columns except of those which I needed. So the table shrank from 201 variable to 13. Then I dropped all rows from Nestle.


As a first overview we want to see what the distribution of the nutriscore is.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
NumbersNutriscore <- Data_merge %>%
  group_by(nutriscore_grade) %>%
  drop_na(nutriscore_grade) %>%
  count(nutriscore_grade) %>%
  ggplot(aes(x=nutriscore_grade, y=n, fill = nutriscore_grade)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = Nutri_Colors) +
  theme(legend.position = "none")

print(NumbersNutriscore)
```

We wanted to see the mean nutriscore for each food category

```{r, echo=FALSE, warning=FALSE, message=FALSE}
NutriScore <- Data_merge %>%
  drop_na(pnns_groups_2, nutriscore_score) %>%
  group_by(pnns_groups_2) %>%
  summarise(NutriScore = mean(nutriscore_score)) %>%
  ggplot(aes(x=pnns_groups_2, y= NutriScore)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
  
print(NutriScore)
```

Then we are interessted in beverages therefore we check how the nutriscore is distributed by different beverage categories.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
NutriGrade <- Data_merge %>%
  drop_na(pnns_groups_2, nutriscore_grade) %>%
  subset(pnns_groups_2 %in% c("Sweetened beverages", "Unsweetened beverages", "Artificially sweetened beverages", "Alcoholic beverages")) %>%
  count(nutriscore_grade, pnns_groups_2) %>%
  ggplot(aes(x = pnns_groups_2, y = n, fill = nutriscore_grade)) +
   scale_fill_manual(values = c("#74c928","#fbc801","#f4730e","#ef2d1a")) +
     geom_bar(stat = "identity", position =  "fill") + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x="")
  

print(NutriGrade)
```

Then I wanted to know if the distribution of the nutriscore is different between the countries. But it seems that the proportion in all 4 countries are similar.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
Country <- Data_merge %>%
  drop_na(countries_en, nutriscore_grade) %>%
  subset(countries_en %in% c("France", "Germany", "United States", "Japan")) %>%
  count(nutriscore_grade, countries_en) %>%
  ggplot(aes(x= countries_en, y=n, group=nutriscore_grade, fill = nutriscore_grade))+
  scale_fill_manual(values = Nutri_Colors) +
  geom_bar(stat = "identity", position = "fill")

print(Country)
```
